**部署指南**

# 1. **概述**

本指南旨在帮助管理员和开发人员配置 Jetspeed 并将其部署到应用程序服务器。虽然管理指南记录了在门户用户界面中配置 Jetspeed，但本指南记录了使用 Spring 配置和 Java 属性文件进行配置和部署。

### 1.1.1. **部署 Jetspeed 2**

Jetspeed 可以部署在各种应用服务器中。本指南描述了[Apache Tomcat](https://portals.apache.org/jetspeed-2/deployguide/guide-tomcat.html)和[IBM Websphere](https://portals.apache.org/jetspeed-2/deployguide/deploying-jetspeed-to-websphere.html)的部署过程。

### 1.1.2. **配置 Jetspeed 2 组件**

Jetspeed 为特定的配置设置提供了非常灵活的方法。

Jetspeed 组件最初是从**/WEB-INF/assembly/**文件夹加载的，而默认配置属性是从文件夹加载的**/WEB-INF/conf/jetspeed.properties.**

初始/默认配置可以通过**/WEB-INF/assembly/override/**文件夹覆盖，而覆盖/附加值可以通过**/WEB-INF/conf/override.properties.**

另一个新特性是有条件的 Spring 程序集加载。Jetspeed 提供了一个扩展的 BeanFactory，它根据预定义的配置检查加载的 Spring BeanDefinition 是否有一些额外的元数据（在 Spring 配置本身中定义），可以“阻止”在 Spring 中注册 BeanDefinition，从而有效地过滤掉某些定义。

### 1.1.3. **本指南**

部署指南描述了[可以配置的属性](https://portals.apache.org/jetspeed-2/deployguide/jetspeed-properties.html)，以及如何[覆盖默认值](https://portals.apache.org/jetspeed-2/deployguide/override-properties.html)。

简要介绍了管理[Spring 配置](https://portals.apache.org/jetspeed-2/deployguide/config-spring.html)，以及如何 使用您自己的部署自定义[覆盖默认** Spring **配置。](https://portals.apache.org/jetspeed-2/deployguide/config-overrides.html)整个 Jetspeed 门户是使用 Spring 配置构建的。本部署指南记录了您可以覆盖的关键组件。该指南在左侧菜单中分类为描述**安全组件**和**门户组件**的一般主题。

# 2. **部署**

## 2.1. [**雄猫**](https://portals.apache.org/jetspeed-2/deployguide/guide-tomcat.html)

[Apache Tomcat](http://tomcat.apache.org/)是 Java Servlet 和 JavaServer Pages 技术的实现。Java Servlet 和 JavaServer Pages 规范是在 Java Community Process 下开发的。尽管 Tomcat 不是一个完整的 Java Enterprise Application Server，例如[Geronimo](http://geronimo.apache.org/)或[JBoss](http://jboss.org/)，但 Tomcat 仍然具有应用服务器的许多高级特性。Tomcat 不是门户服务器，也不是 portlet 容器。Jetspeed 既是一个门户服务器，又包括一个portlet 容器。要了解有关 portlet 容器的更多信息，请参阅[Pluto 项目](http://portals.apache.org/pluto/)。Jetspeed 安装程序附带一个预打包的内置 Tomcat 版本。

### 2.1.1. **支持的 Tomcat 版本**

Jetspeed 2.3.0 经过良好测试和集成，可在以下 Apache Tomcat 平台上运行：

· 最新的 Tomcat 7.0.59+ - 推荐用于 Servlet API 3.0.1 / JSP 2.2.1

### 2.1.2. **Jetspeed 如何在 Tomcat 中运行**

Jetspeed 是一个普通的 Web 应用程序，因此它像任何其他 Web 应用程序一样在 Tomcat 中运行。然而，由于 Jetspeed 也是一个门户服务器，能够在应用程序服务器中包含来自其他已部署的 portlet 应用程序的内容，它有一些特殊要求才能在 Tomcat 中运行：

· 跨上下文调用 - 必须在 Tomcat 中配置 Jetspeed 才能执行跨上下文请求调度。

· 数据库配置 - 默认情况下，Jetspeed 让 Tomcat 管理数据库连接。Tomcat 需要提供一个上下文文件，以便 Jetspeed 使用 Tomcat 连接池

· 通用类加载器 - Jetspeed 需要在 Tomcat 共享类加载器中加载多个 jar。这些 jar 中的类在 Jetspeed 和所有 portlet 应用程序之间共享

· 重命名上下文路径 - 您可以给 Jetspeed 一个不同的上下文路径名

· 配置 JAAS 领域 - 您可以在 Tomcat 中配置特定于 Jetspeed 的 JAAS 领域功能，例如提供您自己的角色和用户类

让 Jetspeed 在 Tomcat 中运行需要一些最低限度的配置，如下节所述。如果您运行内置 Tomcat 的 Jetspeed 安装程序，所有配置都由安装程序为您管理。

### 2.1.3. **Tomcat 配置**

Tomcat 使用 XML 文件来配置 Tomcat 特定的功能以及标准化的功能。*WEB-INF/web.xml*文件配置标准功能。*在META-INF/context.xml*文件中配置了一些 Tomcat 特定的 Web 应用程序特性，servlet 规范没有明确涵盖。在没有安装程序的情况下配置 Jetspeed 所需的几个 Tomcat 特定配置是：数据库、跨上下文请求和 common-class-loader。另请注意，如果您使用 Maven 构建工具构建 Jetspeed，Jetspeed 将为 Jetspeed Web 应用程序创建此 Tomcat 上下文文件并将其自动部署到 Tomcat。

以下是 Jetspeed 的 context.xml 文件示例：

<上下文 crossContext="true">

<领域类名称="org.apache.catalina.realm.JAASRealm"

     appName="Jetspeed"

     userClassNames="org.apache.jetspeed.security.impl.UserPrincipalImpl"

     roleClassNames="org.apache.jetspeed.security.impl.RolePrincipalImpl"

     useContextClassLoader="true"

     调试="0"/>

<资源名称="jdbc/jetspeed" auth="容器"

        factory="org.apache.commons.dbcp.BasicDataSourceFactory"

        type="javax.sql.DataSource" 用户名="j2" 密码="secret"

        driverClassName="com.mysql.jdbc.Driver" url="jdbc:mysql://localhost/jetdb"

        maxActive="100" maxIdle="30" maxWait="10000"/>

<Valve className="org.apache.catalina.authenticator.FormAuthenticator" characterEncoding="UTF-8"/>
</上下文>

#### 2.1.3.1. **Tomcat 跨上下文配置**

关于 Tomcat 上下文文件，您会注意到的第一件事是交叉上下文设置设置为 true，它*不是*默认设置：

<上下文 crossContext="true">

Jetspeed 需要此设置才能将来自不同 portlet 应用程序的内容全部“聚合”到同一页面上。但默认情况下，Tomcat 不启用此功能。请确保此设置为真，否则 Jetspeed 将无法正常运行。

![](file:///C:\Users\johnfeng\AppData\Local\Temp\ksohtml11556\wps1.png)

#### 2.1.3.2. **Tomcat 数据库配置**

此上下文文件还包含 Jetspeed 内部使用的数据库的 JDBC 配置。默认情况下，Jetpeed 使用 JNDI 查找数据库连接。因此 Jetspeed 期望您在您的特定应用程序服务器配置中配置您的数据库连接。对于 Tomcat，这里是设置所需 JNDI 资源名称*jdbc/jetspeed*所需的数据库配置：

<上下文 crossContext="true">

...

<资源名称="jdbc/jetspeed" auth="容器"

        factory="org.apache.commons.dbcp.BasicDataSourceFactory"

        type="javax.sql.DataSource" 用户名="j2" 密码="secret"

        driverClassName="com.mysql.jdbc.Driver" url="jdbc:mysql://localhost/jetdb"

        maxActive="100" maxIdle="30" maxWait="10000"/>
...

</上下文>

我们已经配置了特定于 Tomcat 的数据库配置的几个重要特性，包括：


| **属性**     | **描述**                                                               |
| ------------ | ---------------------------------------------------------------------- |
| 工厂         | JDBC数据源工厂类名。这里我们使用 Apache Commons DBCP（数据库连接池）库 |
| 类型         | javax.sql.DataSource -资源类型：JDBC DataSource 提供者                 |
| 用户名       | 数据库中将用于身份验证的用户名                                         |
| 密码         | 数据库上用户的密码                                                     |
| 驱动程序类名 | JDBC数据库驱动程序的类名：特定于 Jetspeed 使用的数据库                 |
| 网址         | JDBC数据库连接 URL 字符串                                              |
| 最大活动     | 最大活动数据库连接数                                                   |
| 最大空闲     | 最大空闲数据库连接数                                                   |
| 最大等待     | 超时前获得连接的最大等待时间（以毫秒为单位）                           |

另请参阅 Tomcat 文档以获取有关在 Tomcat 中配置 数据库[连接池](https://tomcat.apache.org/tomcat-7.0-doc/jndi-datasource-examples-howto.html) 和[JNDI的更多详细信息](https://tomcat.apache.org/tomcat-7.0-doc/jndi-resources-howto.html)

#### 2.1.3.3. **Tomcat shared/lib 中的通用类加载器**

Jetspeed 需要在 Tomcat 共享类加载器中加载多个 jar。这些 jar 中的类在 Jetspeed 和所有 portlet 应用程序之间共享。

Jetspeed 和 portlet 应用程序部署为单独的 Web 应用程序。Jetspeed 作为 MVC 控制器类型的 servlet 运行，在独立的 web（portlet）应用程序中运行。每个 portlet 应用程序都在其自己的 Web 应用程序中运行。然后，门户使用跨上下文调用将分派到 portlet

这意味着 Jetspeed 的某些部分必须存在于应用服务器中所有 Web 应用程序共享的通用类加载器中。如下图所示，shared/lib 类加载器优先于单个 portlet 应用程序类加载器：

![](file:///C:\Users\johnfeng\AppData\Local\Temp\ksohtml11556\wps2.png)

总而言之，您必须将以下 jar 放在 Tomcat 的共享库目录 (lib) 中：

ls $TOMCAT_HOME/lib

...

apa-logging-1.1.jar

ccpp-1.0.jar

jetspeed-api-2.3.0.jar

jetspeed-commons-2.3.0.jar

pluto-container-api-2.0.3.jar

pluto-taglib-2.0.3.jar

门户-桥梁-common-2.1.jar

portlet-api_2.1.0_spec-1.0.jar

此外，您可能希望将 JDBC 驱动程序放在这里，例如：

mysql-connector-java-5.1.6-bin.jar

### 2.1.4. **将 Portlet 应用程序部署到 Tomcat**

Portlet 类似于 servlet。除了servlet 应用程序所需的*web.xml*之外，它们还需要一个名为*portlet.xml*的部署描述符，该描述符位于 WEB-INF 目录中。Portlet 应用程序需要以为 servlet 指定的相同*WAR格式打包。*为了部署 portlet，Jetspeed-2 要求用户遵循以下步骤：

· 就像构建 Web 应用程序一样，将您的 portlet 构建为 portlet 应用程序。

· 将您的 portlet 应用程序与 WEB-INF/portlet.xml 描述符一起打包到 .war 文件中。

· 将 .war 文件复制到 Jetspeed 的部署目录，默认为*WEB-INF/deploy*。Jetspeed 将负责将 portlet 应用程序自动部署到应用程序服务器 (Tomcat) 中，然后将 portlet 注册到 portlet 注册表中。

或者，您可以直接复制到 Tomcat 的*webapps*目录中，但前提是您已经在 web.xml 中为您的 portlet 应用程序*注入*了必要的设置。

您还可以复制 portlet 应用程序的 web.xml 或 portlet.xml 以重新注册 portlet 应用程序。

#### 2.1.4.1. **在您的应用程序中注入 Jetspeed Servlet**

Jetspeed 要求在您的portlet 应用程序的web.xml 中放置一个Jetspeed Container servlet。这个 servlet 的类文件实际上存储在 Jetspeed 共享库路径中，因此您不必将它包含到您的 portlet 应用程序分发中。同样，当进入 Jetspeed 的部署目录时，不需要此过程，因为 Servlet 将由 Jetspeed 部署程序自动添加到您的 web.xml。此 servlet 允许 Jetspeed 与您的 portlet 应用程序通信以调用跨上下文 portlet 阶段（操作、呈现）。此外，servlet 将在 servlet 初始化阶段尝试注册这个 portlet 应用程序。对 portlet.xml、web.xml 和 jetspeed-portlet.xml 的校验和值进行比较，以确定是否需要重新注册。

<小服务程序>

<description>用于 Jetspeed Portlet 应用程序的 MVC Servlet</description>

<display-name>Jetspeed 容器</display-name>

<servlet-name>JetspeedContainer</servlet-name>

<servlet-class>org.apache.jetspeed.container.JetspeedContainerServlet</servlet-class>

<初始化参数>

  <param-name>contextName</param-name>

  <param-value>j2-admin</param-value>

</init-param>

<load-on-startup>100</load-on-startup>
</servlet>

<servlet 映射>

<servlet-name>JetspeedContainer</servlet-name>

<url-pattern>/container/*</url-pattern>
</servlet-mapping>

contextName init 参数定义 Tomcat 和 Jetspeed 在定位应用程序时使用的上下文路径*。*这应该与 Tomcat 的 servlet 上下文路径设置相同。

最后，您可以选择运行 Jetspeed 部署工具来自动将上述 XML 添加到应用程序的 web.xml。Jetspeed 提供了一个部署工具，可在您的 portlet 应用程序的构建过程中运行：

java -jar jetspeed-deploy-tools-<版本>.jar -s inputWarPath outputWarPath
在哪里：

-s：指示是否从应用程序中剥离到记录器的标志。当国旗

 目前，应用程序中可用的记录器将被删除。
inputWarPath：要处理的战争路径。

outputWarPath：处理后的war的路径。

#### 2.1.4.2. **Tomcat 管理器和 Jetspeed**

Jetspeed 知道如何与 Tomcat Manager 应用程序通信。Tomcat Manager 是一个简单的编程 API，用于管理 servlet 应用程序生命周期，包括：

· 部署应用程序

· 取消部署应用程序

· 启动应用程序

· 停止应用程序

Jetspeed PortletApplicationManager portlet 需要对 Tomcat 配置进行一些修改才能正常工作。您需要在 Tomcat 的*conf/tomcat-users.xml*中定义一个管理脚本用户。确保为您的用户配置*manager-script*角色。

一个最小的示例 tomcat-users.xml 可能如下所示：

<tomcat 用户>

<role rolename="manager-script"/>

<user username="j2deployer" password="xxxxx" roles="manager-script"/>
</tomcat-users>

*用户名和密码的属性值也必须在*[*Jetspeed Override Properties中配置*](https://portals.apache.org/jetspeed-2/deployguide/config-overrides.html)

### 2.1.5. **高级配置...**

#### 2.1.5.1. **更改应用程序上下文路径和文档库**

如果您愿意，您可以更改任何 Web 或 portlet 应用程序的上下文路径和文档库，包括 Jetspeed。上下文路径是标识应用程序的路径，例如 http://localhost:8080/jetspeed/portal 等 URL 中的 /jetspeed。使用此功能，您可以将门户名称更改为*/myportal 之*类的内容：

<上下文路径='/myportal' docBase='/opt/myportal'>

此外，您的应用程序不必驻留在 Tomcat webapps 目录中。在上面的示例中，我们已将其移至 /opt/myportal 目录。

#### 2.1.5.2. **JAAS 领域、用户和角色**

Jetspeed 使用自己的登录模块。在该登录模块中，Jetspeed 为 Tomcat 提供了自己的用户主体和角色主体实现。为了让 Tomcat 知道这些 JAAS（Java Authentication and Authorization Services）类，我们需要告诉 Tomcat：

<领域类名称="org.apache.catalina.realm.JAASRealm"

     appName="Jetspeed"

     userClassNames="org.apache.jetspeed.security.impl.UserPrincipalImpl"

     roleClassNames="org.apache.jetspeed.security.impl.RolePrincipalImpl"

     useContextClassLoader="true"

     调试="0"/>
#### 2.1.5.3. **Windows 上的 Tomcat**

要在 Windows 上使用 Tomcat 7.x+ 时重新部署和取消部署正常工作，您必须在 META-INF 下 的*context.xml文件中将全局上下文属性“antiJARLocking”设置为 true。*

<上下文 antiJARLocking="true">

...

</上下文>

			
## 2.2. [**网络球**](https://portals.apache.org/jetspeed-2/deployguide/deploying-jetspeed-to-websphere.html)

### 2.2.1. **介绍**

本文档是在 Websphere Application Server 上部署自定义 Apache Jetspeed-2 门户和 portlet 应用程序的分步指南。此处提供的此解决方案在 Websphere 版本 6.1 上进行了测试。

要构建 Jetspeed 门户，请阅读随附文档“使用 Maven-1 构建 Jetspeed for Websphere”和“使用 Maven-2 构建 Jetspeed for Websphere”。

Jetspeed 是一个开源项目，因此所有源代码都可以从 Apache 免费获得。有关详细信息，请参阅网站：http: [//portals.apache.org/jetspeed-2/](http://portals.apache.org/jetspeed-2/)。

#### 2.2.1.1. **目的**

本文档将教您如何在 Web 应用程序存档或企业存档 (EAR) 中将 Jetspeed 门户和一个或多个 portlet 应用程序部署到 Websphere。

本文档中使用的自定义门户是一个名为 Jet Express 的示例教程门户。Jet Express 是 Jetspeed 门户的定制版本。此外，我们将部署 Jetspeed 管理 portlet 应用程序和一个名为 Express Demo 的示例 portlet 应用程序。使用示例自定义门户的目的是教您如何为生产系统部署自己的自定义门户。

#### 2.2.1.2. **我应该将 Jetspeed 部署为 WAR 文件还是嵌入到 EAR 文件中？**

这两种方法都有好处。将 Jetspeed 门户部署为 WAR 可能是增量开发 portlet 应用程序的更好方法。通过将 Jetspeed 部署为 WAR 文件一次，您不必像您的 portlet 应用程序那样频繁地重新部署它。这可以将您的 portlet 应用程序的部署周期与 Jetspeed 门户的部署周期分开。

部署 EAR 的好处是：

· 您只需处理一个部署单元

· 在生产环境中，这可能更有意义

· 共享库更容易配置

· 可以在EAR中配置JDBC数据源等资源

部署为所有 WAR 文件的过程不同于部署在单个 EAR 文件中的过程。

WAR 过程在[第** 4 **节](https://portals.apache.org/jetspeed-2/deployguide/deploying-jetspeed-to-websphere.html)中定义。

EAR 程序在[第** 5 **节](https://portals.apache.org/jetspeed-2/deployguide/deploying-jetspeed-to-websphere.html)中定义。

第三种选择是将 Jetspeed 和 Jetspeed 管理应用程序部署为 EAR 文件，然后将您的 portlet 应用程序部署为外部 EAR 文件。有关部署两个或更多 EAR 文件的详细信息， 请参阅[第** 6 **节。](https://portals.apache.org/jetspeed-2/deployguide/deploying-jetspeed-to-websphere.html)

### 2.2.2. **Websphere 6.1 和 Jetspeed 入门**

本指南假定您使用的是 Websphere 6.1 版。尽管 Jetspeed 在 Websphere 5.x 和 Websphere Express 上运行，但本指南专门针对 Websphere 6.1 环境。

#### 2.2.2.1. **所需的修复包**

如果您运行的是 6.1.0.0 版或 6.1.0.1 版，则必须安装 Fix Pack 2 才能运行 Jetspeed。如果没有此修订包，portlet 将无法正确呈现。从此处下载修订包：

[http](#ver61)

://www-1.ibm.com/support/docview.wss?rs=180&uid= swg27004980#ver61 安装修订包需要安装 IBM Update Installer 程序。

#### 2.2.2.2. **验证 Websphere 版本**

启动 Websphere。使用 Web 浏览器转至管理控制台，并验证您正在运行正确版本的 Websphere。

**http://localhost:9060/ibm/console/**

您应该是一个拆分页面，左侧是导航，右侧是详细信息。单击左侧的第一个导航：“欢迎”。

![](file:///C:\Users\johnfeng\AppData\Local\Temp\ksohtml11556\wps3.jpg)

确保您运行的是正确版本的 Websphere，6.1.0.2 或更高版本：

![](file:///C:\Users\johnfeng\AppData\Local\Temp\ksohtml11556\wps4.jpg)

Websphere 必须运行 6.1.0.2 或更高版本。如果您使用的是 6.1.0.1 或更低版本，请在继续之前按照第 2.1 节中的说明进行操作。

#### 2.2.2.3. **调试**

如果您想使用 Eclipse 或 RAD 附加到 Websphere，您可以打开调试以调试您的 portlet。导航到*服务器 -> 应用程序服务器*菜单；选择您要调试的服务器。在*Additional Properties*部分下，单击*Debugging Service*链接。

![](file:///C:\Users\johnfeng\AppData\Local\Temp\ksohtml11556\wps5.jpg)

在此处，您可以通过单击*Enable service at server startup*启用调试，按 OK，然后重新启动服务器：

![](file:///C:\Users\johnfeng\AppData\Local\Temp\ksohtml11556\wps6.jpg)

### 2.2.3. **数据库配置**

Jetspeed 需要一个关系数据库来存储portlet 信息，例如portlet 首选项、页面和portlet 注册表。Jetspeed 支持许多最流行的商业和开源数据库，包括：

· 甲骨文

· DB2

· MySQL

· 微软 SQL 服务器

· 德比

· SAP 数据库

· PostgreSQL

可以在此处找到使用 Websphere 配置 MySQL 数据提供程序的文档：http:

[//www.devx.com/Java/Article/31571](http://www.devx.com/Java/Article/31571)

[http://www.hackedby.us/2006/04/discovering-portals-jetspeed-with。 html](http://www.hackedby.us/2006/04/discovering-portals-jetspeed-with.html)

WAS 5.x

[http://www.webspherepower.com/issuesprint/issue200403/00001236.html](http://www.webspherepower.com/issuesprint/issue200403/00001236.html)

在本例中，我们将配置一个 Oracle JDBC 数据提供者。在继续之前，请在 Oracle 实例中配置 Jetspeed 数据库。确保您已经：

1. 创建了一个配置为保存 Jetspeed 表的 Oracle 用户（模式）。
2. 构建了自定义门户。Jetspeed 表必须预先创建并预先填充默认数据。自定义门户构建为您执行此操作。有关预填充数据库的更多信息，请参阅构建指南。
3. 连接到数据库的 Oracle/JDBC 连接字符串。

*注意*：如果您在一个或多个开发人员之间共享模式，您可能会覆盖另一位开发人员的开发环境。因此，建议每个开发人员都有一个分配的模式。开发人员在他们的构建属性文件中配置他们的数据库配置。有关更多信息，请参阅 Jetspeed 构建文档

org.apache.jetspeed.production.database.default.name = oracle

org.apache.jetspeed.production.database.url = jdbc:oracle:thin:@localhost:1521:fep

org.apache.jetspeed.production.database.driver = oracle.jdbc.driver.OracleDriver

org.apache.jetspeed.production.database.user = fep

org.apache.jetspeed.production.database.password = xxxxx

org.apache.jetspeed.production.jdbc.drivers.path = ${was.root}/lib/OptionalLibraries/oracle/ojdbc14.jar

#### 2.2.3.1. **在 Websphere 中创建 JAAS 用户身份**

首先，在 JAAS Java 2 连接器中创建用户身份和密码。导航到 Websphere 的 LHS 菜单中的“安全”菜单：

![](file:///C:\Users\johnfeng\AppData\Local\Temp\ksohtml11556\wps7.jpg)

选择“安全管理、应用程序和基础架构”，这将导致“身份验证”页面。展开“Java 认证和授权服务”部分：

![](file:///C:\Users\johnfeng\AppData\Local\Temp\ksohtml11556\wps8.jpg)

选择“J2C authentication data”... 创建一个新的 JAAS J2C User 身份，选择“New”：

![](file:///C:\Users\johnfeng\AppData\Local\Temp\ksohtml11556\wps9.jpg)

然后输入您的凭据。请注意，我们将用户别名称为“JetExpressLogin”。不需要将其命名为“JetExpressLogin”；但请确保在下一节中配置 JDBC 数据源时使用相同的名称。

![](file:///C:\Users\johnfeng\AppData\Local\Temp\ksohtml11556\wps10.png)

按确定，然后完成保存对话框。

#### 2.2.3.2. **创建 JDBC 数据提供者**

在 Jetspeed 的默认配置中，Jetspeed 更喜欢从应用程序服务器使用 JNDI 名称提供的连接池中获取其数据库连接。本节演示如何配置 Websphere 6.1 JDBC 数据提供者。在 Websphere 中，数据提供者可以拥有一个或多个数据源。Jetspeed 实际上是连接到数据源的，但首先我们需要定义一个泛化的数据提供者。

#### 2.2.3.3. **创建 Oracle JDBC 数据提供者**

其次，导航到 Websphere 的 LHS 菜单中的“资源”菜单：

![](file:///C:\Users\johnfeng\AppData\Local\Temp\ksohtml11556\wps11.jpg)

单击 JDBC Providers，您应该会看到所有预安装的 JDBC 提供程序的列表。如果您已经安装了 Oracle JDBC 提供程序，请跳到下一节配置 JDBC 数据源。否则，点击“新建”，如下图：

![](file:///C:\Users\johnfeng\AppData\Local\Temp\ksohtml11556\wps12.jpg)

然后我们可以创建一个新的 Oracle JDBC 提供程序：

![](file:///C:\Users\johnfeng\AppData\Local\Temp\ksohtml11556\wps13.jpg)

选择Oracle的“数据库类型”，“Oracle JDBC驱动程序”的提供者类型，“连接池数据源”。为提供者命名或使用默认值（Oracle JDBC 驱动程序）。

确保您在 Websphere 中配置了驱动程序：

![](file:///C:\Users\johnfeng\AppData\Local\Temp\ksohtml11556\wps14.jpg)

这里我们硬编码了从 Oracle 下载并安装到我们系统上的驱动程序的路径：

**/opt/IBM/WebSphere/AppServer/lib/ext/ojdbc14.jar**

单击下一步，然后使用默认值进行其他所有操作。到最后，按“完成”，然后按“保存”，如下所示：

![](file:///C:\Users\johnfeng\AppData\Local\Temp\ksohtml11556\wps15.png)

您现在应该在 Websphere 上的已知 JDBC 提供程序列表中看到 Oracle：

![](file:///C:\Users\johnfeng\AppData\Local\Temp\ksohtml11556\wps16.jpg)

#### 2.2.3.4. **配置 Oracle 数据源**

接下来，我们需要创建一个 Oracle 数据源。在继续此步骤之前，请确保按照第 3 节中的说明正确配置您的 Oracle 数据库。导航到 Oracle JDBC 提供程序，然后单击“附加属性”区域中的“数据源”：

![](file:///C:\Users\johnfeng\AppData\Local\Temp\ksohtml11556\wps17.png)

进入：

1. 数据源名称 - 将其重命名为**jetspeed**
2. JNDI 名称 - 此值必须是**jdbc/jetspeed**
3. 选择默认 CMA 别名
4. ![](file:///C:\Users\johnfeng\AppData\Local\Temp\ksohtml11556\wps18.jpg)
5. 输入 Oracle JDBC URL 连接字符串，通常该字符串类似于：
6.
7. **jdbc:oracle:thin:@localhost:1521:XE**
8. 为 Oracle 9i 或 Oracle 10g 选择数据存储帮助程序类
9. 从组件管理的认证别名中选择 3.1 节中配置的 JAAC J2C 身份：
10. ![](file:///C:\Users\johnfeng\AppData\Local\Temp\ksohtml11556\wps19.jpg)

按**“测试连接”**按钮以确保您的连接正确。在您可以使用测试连接按钮连接到数据库之前，不要继续第 4 节。按页面顶部的 **“保存”完成 JDBC 数据源配置并完成保存对话框。**

![](file:///C:\Users\johnfeng\AppData\Local\Temp\ksohtml11556\wps20.jpg)

#### 2.2.3.5. **重启 Websphere**

在 Websphere 5.1.1.3 上，安装数据源定义后需要重新启动 Websphere。否则，Jetspeed 在首次部署时无法使用数据源定义。对于 6.1.0.2 或更高版本，不需要重新启动。

### 2.2.4. **WAR 部署**

本节介绍使用 WAR 文件将 Jetspeed 部署到 Websphere。如果您更喜欢使用 EAR 文件进行部署，请跳至[第** 5 **节](https://portals.apache.org/jetspeed-2/deployguide/deploying-jetspeed-to-websphere.html)。

部署工件由开发人员或构建团队创建。在此示例中，我们将假设您使用了演示自定义门户“Jet Express”。有关如何构建 Jet Express 门户工件的说明，请参阅随附的构建文档。

#### 2.2.4.1. **WAR 文件**

Jet Express 的 WAR 文件部署包含三个 WAR 文件：

· **jetexpress.war** - 自定义 Jetspeed 门户

· **j2-admin.war** - Jetspeed 附带的管理 portlet

· **expressdemo.war** - 示例 portlet 应用程序

必须使用管理控制台按上述顺序将这三个 war 文件部署到 Websphere。

#### 2.2.4.2. **共享库**

以下 jar 文件必须位于 Jetspeed 和所有 portlet 应用程序使用的共享类加载器中：

1. jetspeed-api-2.1-dev.jar
2. jetspeed-commons-2.1-dev.jar
3. pluto-1.0.1.jar
4. 门户-桥梁-common-1.0.jar
5. portlet-api-1.0.jar

不应复制第 6 个 jar 文件 derby-10.1.1.0.jar。如果您打算将 Derby (Cloudscape) 数据库与 Jetspeed 一起使用，请

在 Websphere 中创建一个 JDBC 数据源并通过 JNDI 过程将其连接到 Jetspeed在[第** 3 **节](https://portals.apache.org/jetspeed-2/deployguide/deploying-jetspeed-to-websphere.html)中描述。

这 6 个文件是在随附的构建文档中描述的构建过程中创建的。

Websphere 6 具有专门用于在应用程序之间共享库（jar）的新功能。Websphere 有一个用于存储共享库的目录。您的 Websphere 安装应该有一个目录：**\${WAS\_INSTALL\_ROOT}/optionalLibraries/Apache/**。

在 Apache 目录下创建一个名为“Jetspeed-2”的目录：

**\${WAS\_INSTALL\_ROOT}/optionalLibraries/Apache/Jetspeed-2/jetspeed-api-2.1-dev.jar**

cd ${WAS_INSTALL_ROOT}/optionalLibraries/Apache

mkdir Jetspeed-2

将上面的五个jar文件复制到Jetspeed-2共享库目录下。然后从 Websphere Admin 中，转到 LHS 菜单选项*Environment -> Shared Libraries*，然后单击“新建”：

![](file:///C:\Users\johnfeng\AppData\Local\Temp\ksohtml11556\wps21.jpg)

在这里，我们创建一个新的共享库以供部署的应用程序使用：

![](file:///C:\Users\johnfeng\AppData\Local\Temp\ksohtml11556\wps22.jpg)

确保将五个 jar 输入到 Classpath 多行编辑中，如上所示，并使用 CRLF 分隔每个 jar 文件：

${WAS_INSTALL_ROOT}/optionalLibraries/Apache/Jetspeed-2/jetspeed-api-2.1-dev.jar

${WAS_INSTALL_ROOT}/optionalLibraries/Apache/Jetspeed-2/jetspeed-commons-2.1-dev.jar

${WAS_INSTALL_ROOT}/optionalLibraries/Apache/Jetspeed-2/pluto-1.0.1.jar

${WAS_INSTALL_ROOT}/optionalLibraries/Apache/Jetspeed-2/portals-bridges-common-1.0.jar

${WAS_INSTALL_ROOT}/optionalLibraries/Apache/Jetspeed-2/portlet-api-1.0.jar

请注意，我们已将共享库命名为“JetspeedSharedLib”。在安装 Jetspeed 应用程序和所有其他 portlet 应用程序时，不要忘记引用这个共享库。

#### 2.2.4.3. **将共享库引用添加到应用程序服务器类加载器**

为了跨 WAR 或 EAR 部署在系统范围内共享[第** 4.2 **节](https://portals.apache.org/jetspeed-2/deployguide/deploying-jetspeed-to-websphere.html)中安装的 Jetspeed 共享库，您需要将共享库引用添加到应用程序服务器的类加载器。该共享库引用指向[4.2 节中配置的](https://portals.apache.org/jetspeed-2/deployguide/deploying-jetspeed-to-websphere.html)*JetspeedSharedLib*共享库。

要安装共享库引用，请转到*服务器 -> 应用程序*服务器菜单：

![](file:///C:\Users\johnfeng\AppData\Local\Temp\ksohtml11556\wps23.jpg)

选择要安装 Jetspeed 的服务器，然后展开页面右侧的*Java and Process Management项，然后点击Class loader*：

![](file:///C:\Users\johnfeng\AppData\Local\Temp\ksohtml11556\wps24.jpg)

在类加载器页面中，单击新建：

![](file:///C:\Users\johnfeng\AppData\Local\Temp\ksohtml11556\wps25.jpg)

在 General Properties 上，将*Class loader order*设置为*Classes loaded with parent class loader last*：

![](file:///C:\Users\johnfeng\AppData\Local\Temp\ksohtml11556\wps26.png)

单击确定，然后单击保存。单击您的新类加载器：

![](file:///C:\Users\johnfeng\AppData\Local\Temp\ksohtml11556\wps27.jpg)

单击*共享库参考*链接：

![](file:///C:\Users\johnfeng\AppData\Local\Temp\ksohtml11556\wps28.jpg)

通过单击新建创建了一个新的共享库引用：

![](file:///C:\Users\johnfeng\AppData\Local\Temp\ksohtml11556\wps29.jpg)

选择*JetspeedSharedLib*库名称，按 OK 并继续保存到主配置。

![](file:///C:\Users\johnfeng\AppData\Local\Temp\ksohtml11556\wps30.jpg)

您现在已准备好部署 Jetspeed 门户和 portlet 应用程序 WAR 文件。

#### 2.2.4.4. **安装 Jetspeed 门户 WAR 文件**

下一步是安装 Jetspeed Portal WAR 文件。在尝试安装任何 portlet 应用程序之前，必须始终安装并运行 Jetspeed。在我们的示例中，jetspeed 战争文件的名称是*“jetexpress.war”*。

导航到*应用程序-> 安装新应用程序*：

![](file:///C:\Users\johnfeng\AppData\Local\Temp\ksohtml11556\wps31.png)

1. 选择浏览按钮，然后从本地文件系统加载**jetexpress.war文件。**
2. **输入/jetexpress**的上下文根
3. 按下一步，导致一系列对话框
4. 在 Step 1 对话框中，使用默认值并按 Next
5. 在第 2 步对话框中，使用默认值并按下一步
6. 在步骤 3 对话框中，将身份验证方法指定为“无”并选择您的 JDBC 数据源：
7. ![](file:///C:\Users\johnfeng\AppData\Local\Temp\ksohtml11556\wps32.jpg)
8. 点击浏览并从第 3 部分中选择预配置的 Oracle JDBC 数据源，然后应用然后下一步：
9. 在第 4 步对话框“映射虚拟主机..”中，单击复选框，然后按下一步
10. 在 Step 5 对话框中，按 Finish，然后在下一个对话框中，按 Save

如果您转到*Applications -> Enterprise Applications*页面，您应该会看到您的应用程序已部署：

![](file:///C:\Users\johnfeng\AppData\Local\Temp\ksohtml11556\wps33.jpg)

#### 2.2.4.5. **安装 Jet Express 演示 Portlet 应用程序**

在这里，我们将安装 Jet Express 演示 portlet 应用程序。此过程对于所有 portlet 应用程序都是相同的。在我们的示例中，应用程序 war 文件的名称是*“expressdemo.war”*。

导航到应用程序->安装新应用程序：

![](file:///C:\Users\johnfeng\AppData\Local\Temp\ksohtml11556\wps34.jpg)

1. 选择浏览按钮，然后从本地文件系统加载**expressdemo.war文件。**
2. **输入/expressdemo**的上下文根
3. 按下一步，导致一系列对话框
4. 在步骤 1 到 4 对话框中，使用默认设置，然后按 Next，然后按 Finish
5. 保存对主配置的更改

如果您转到*Applications -> Enterprise Applications*页面，您应该会看到您的应用程序已部署：

![](file:///C:\Users\johnfeng\AppData\Local\Temp\ksohtml11556\wps35.jpg)

#### 2.2.4.6. **安装 Jetspeed Admin Portlet 应用程序**

在这里，我们将安装 Jetspeed Admin portlet 应用程序。此过程对于所有 portlet 应用程序都是相同的。在我们的示例中，jetspeed war 文件的名称是*“j2-admin.war”*。

导航到*应用程序-> 安装新应用程序*：

![](file:///C:\Users\johnfeng\AppData\Local\Temp\ksohtml11556\wps36.jpg)

1. 选择浏览按钮，然后从本地文件系统加载**j2-admin.war文件。**
2. **输入/j2-admin**的上下文根
3. 按下一步，导致一系列对话框
4. 在步骤 1 到 4 对话框中，使用默认设置，然后按 Next，然后按 Finish
5. 保存对主配置的更改

如果您转到*Applications -> Enterprise Applications*页面，您应该会看到您的应用程序已部署：

![](file:///C:\Users\johnfeng\AppData\Local\Temp\ksohtml11556\wps37.jpg)

#### 2.2.4.7. **启动应用程序**

从*应用程序 -> 企业应用程序*菜单中，您可以启动和停止所有已部署的应用程序。首先通过单击旁边的复选框然后按*Start*来启动 Jetspeed 应用程序 ( *jetexpress\_war* ) 。

![](file:///C:\Users\johnfeng\AppData\Local\Temp\ksohtml11556\wps38.jpg)

一旦您看到所有“绿色状态”，您就可以测试您的门户了。

转到此链接：

[http://localhost:9080/jetexpress/portal](http://localhost:9080/jetexpress/portal)

您应该看到示例 Jet Express 自定义门户：

![](file:///C:\Users\johnfeng\AppData\Local\Temp\ksohtml11556\wps39.jpg)

### 2.2.5. **EAR 部署**

本节介绍在一个 EAR 文件中将 Jetspeed 部署到 Websphere。如果您更喜欢使用 WAR 文件进行部署，请转到[第** 4 **节](#section_4)。

部署工件由开发人员或构建团队创建。在此示例中，我们将假设您使用了演示自定义门户“Jet Express”。有关如何构建 Jet Express 门户工件的说明，请参阅随附的构建文档。

#### 2.2.5.1. **EAR 文件**

Jet Express 的 EAR 文件部署包含一个 EAR 文件：

· **jetexpress.ear** - 自定义 Jetspeed 门户和示例 portlet 应用程序

EAR 文件包含：

· **jetexpress.war** - 自定义 Jetspeed 门户

· **j2-admin.war** - Jetspeed 附带的管理 portlet

· **expressdemo.war** - 示例 portlet 应用程序

· **共享库文件**——上面三个war文件使用的共享库

· **application.xml** - EAR 部署描述符

#### 2.2.5.2. **共享库**

以下 jar 文件必须位于 Jetspeed 和所有 portlet 应用程序使用的共享类加载器中：

1. jetspeed-api-2.1-dev.jar
2. jetspeed-commons-2.1-dev.jar
3. pluto-1.0.1.jar
4. 门户-桥梁-common-1.0.jar
5. portlet-api-1.0.jar

使用 EAR 文件，共享的 jar 文件可以简单地放在 EAR 发行版的根目录中。然后，这些文件将在同一个类加载器中在此 EAR 发行版中部署的所有 Web 应用程序中共享。

不应复制第 6 个 jar 文件 derby-10.1.1.0.jar。如果您打算将 Derby (Cloudscape) 数据库与 Jetspeed 一起使用，请在 Websphere 中创建一个 JDBC 数据源并通过 JNDI 过程将其连接到 Jetspeed在第 3 节中描述。

共享 jar 文件是在随附的构建文档中描述的构建过程中创建的。该构建将自动将共享的 jar 文件放入 EAR 文件的根目录中。事实上，所有三个 WAR 文件也都包含在 EAR 文件的根目录中。因此，EAR 文件在根目录中包含 5 个 jar 文件和 3 个 war 文件，在 META-INF 目录 ( *application.xml* ) 下包含一个部署描述符。

EAR 文件应如下所示：

元信息/

元信息/清单.MF

expressdemo.war

j2-admin.war

喷气快车.war

jetspeed-api-2.1-dev.jar

jetspeed-commons-2.1-dev.jar

pluto-1.0.1.jar

门户-桥梁-common-1.0.jar

portlet-api-1.0.jar

META-INF/application.xml

#### 2.2.5.3. **删除任何旧的共享库**

如果您将共享 jar 文件部署到您的 EAR 文件中，您将需要删除任何应用程序服务器范围的共享库，例如在[第** 4.3 **节](#section_4_3)#Add a Shared Library Reference to the Application Server Class Loader 中配置的共享库。

#### 2.2.5.4. **安装 EAR 文件**

EAR 文件的安装方式与 WAR 文件相同。

导航到*应用程序-> 安装新应用程序*：

![](file:///C:\Users\johnfeng\AppData\Local\Temp\ksohtml11556\wps40.jpg)

1. 选择浏览按钮，然后从本地文件系统加载**jetexpress.ear文件。**
2. 将上下文根留空
3. 按下一步，导致一系列对话框
4. 在 Step 1 对话框中，使用默认值并按 Next
5. 在第 2 步中，选择三个 Web 应用程序以将它们映射到服务器
6. ![](file:///C:\Users\johnfeng\AppData\Local\Temp\ksohtml11556\wps41.jpg)
7. 在第 3 步对话框中，将身份验证方法指定为“无”并选择您的 JDBC 数据源：
8. ![](file:///C:\Users\johnfeng\AppData\Local\Temp\ksohtml11556\wps42.jpg)
9. 点击浏览并从第 3 部分中选择预配置的 Oracle JDBC 数据源，然后应用然后下一步：
10. ![](file:///C:\Users\johnfeng\AppData\Local\Temp\ksohtml11556\wps43.jpg)
11. 在第 4 步对话框中，选择三个 Web 应用程序以将其映射到虚拟主机：
12. ![](file:///C:\Users\johnfeng\AppData\Local\Temp\ksohtml11556\wps44.png)
13. 在 Step 5 对话框中，按 Finish，然后在下一个对话框中，按 Save

如果您转到*Applications -> Enterprise Applications*页面，您应该会看到您的应用程序已部署：

![](file:///C:\Users\johnfeng\AppData\Local\Temp\ksohtml11556\wps45.png)

**如果应用程序状态未启动（红色，非绿色），则单击jetexpress**链接 旁边的复选框，然后单击“开始”按钮启动它。一旦您看到所有“绿色状态”，您就可以测试您的门户了。

转到此链接：

[http://localhost:9080/jetexpress/portal](http://localhost:9080/jetexpress/portal)

您应该看到示例 Jet Express 自定义门户：

![](file:///C:\Users\johnfeng\AppData\Local\Temp\ksohtml11556\wps46.jpg)

### 2.2.6. **两个或更多 EAR 部署文件**

在第 5 节中，我们演示了如何部署所有 WAR 文件。在第 6 节中，我们演示了如何在单个 EAR 文件中进行部署。第三种选择是将 Jetspeed 和您的 portlet 应用程序部署在两个或多个 EAR 部署文件中。

好处：

1. 不必每次都重新部署 Jetspeed 和 Jetspeed 管理 Portlet
2. 对于开发，用于部署 portlet 应用程序的占用空间更小

缺点：

1. 仍然需要设置一个共享库和共享引用。

本文档不涉及部署两个或更多 EAR 文件。所需的所有步骤都可以在第 3、4 和 5 节中找到。您仍然需要安装第 4 节中定义的共享库。此外，您还需要每个 EAR 部署文件的共享库引用。按照第 4 节中的说明配置共享库和共享库引用，因为它们适用于 EAR 文件的方式与适用于 WAR 文件的方式相同。

### 2.2.7. **Websphere 应用程序服务器附加信息**

#### 2.2.7.1. **Websphere 应用程序服务器 Portlet 扩展**

特定于 Websphere Application Server 的 portlet 部署描述符的扩展在名为*ibm-portlet-ext.xmi*的文件中定义。此部署描述符是一个可选描述符，您可以使用它来为 portlet 应用程序及其 portlet 配置 WebSphere 扩展。例如，您可以在扩展的 portlet 部署描述符中禁用 portlet 应用程序的*PortletServingServlet* servlet。*ibm-portlet-ext.xmi*扩展文件在应用程序启动期间加载。如果没有使用此设置指定扩展文件，则使用 portlet 容器的默认值。*portletServingEnabled*属性的缺省值为 true。以下是如何配置的示例不为 portlet 应用程序上的任何 portlet 创建 *PortletServingServlet servlet。*

<?xml 版本="1.0" 编码="UTF-8"?>

<portletappext:PortletApplicationExtension xmi:version="1.0"

xmlns:xmi="http://www.omg.org/XMI"

xmlns:portletappext="portletapplicationext.xmi"

xmlns:portletapplication="portletapplication.xmi"

xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"

xmi:id="PortletApp_ID_Ext"

portletServingEnabled="假">
<portletappext:portletApplication href="WEB-INF/portlet.xml#myPortletApp"/>

[/portletappext:PortletApplicationExtension](/portletappext:PortletApplicationExtension)

在此处查找有关 Websphere porlet 扩展的更多信息：

[http://publib.boulder.ibm.com/infocenter/wasinfo/v6r1/index.jsp?topic=/com.ibm.websphere.nd.doc/info/ae/ae/rport\_depdesc\_ext.html](http://publib.boulder.ibm.com/infocenter/wasinfo/v6r1/index.jsp?topic=/com.ibm.websphere.nd.doc/info/ae/ae/rport_depdesc_ext.html)

#### 2.2.7.2. **Portlet 名称和 Servlet 名称的补丁程序不同**

启用 URL 可寻址性后，portlet 名称不得与同一 Web 应用程序中的任何 servlet 名称相同。如果不需要 URL 可寻址性，则不需要此名称要求。如果 URL 可寻址性被禁用，则需要修复来关闭名称验证。

#### 2.2.7.3. **问题结论**

当 URL 可寻址性被禁用时，端口让名称与 servlet 名称是否匹配的验证测试也必须被禁用。在禁用此修复和 URL 可寻址性的情况下，如果 portlet 应用程序与 servlet 具有相同的 portlet 名称，也可以安装该应用程序。

此 APAR 的修复当前的目标是包含在修复包 6.1.0.4 中。

[http://www-1.ibm.com/support/docview.wss?uid=swg1PK31467](http://www-1.ibm.com/support/docview.wss?uid=swg1PK31467)

### 2.2.8. **修订记录**


| 修订 | 日期       | 作者         | 评论                                          |
| ---- | ---------- | ------------ | --------------------------------------------- |
| 0.1  | 2005-01-21 | 大卫肖恩泰勒 | 初稿                                          |
| 0.2  | 2006-01-10 | 吃了豆豆     | 进一步细化和清理未使用的部分                  |
| 0.3  | 2006-01-10 | 大卫肖恩泰勒 | 快速改进                                      |
| 0.4  | 2006-10-16 | 大卫肖恩泰勒 | Websphere 6.1测试                             |
| 0.5  | 2006-10-16 | 大卫肖恩泰勒 | 升级到6.1.0.2，完成 WAR 部分，从 EAR 部分开始 |
| 0.6  | 2006-10-23 | 大卫肖恩泰勒 | 完成EAR部分                                   |

## 2.3. [**部署工具**](https://portals.apache.org/jetspeed-2/deployguide/deploy-tools.html)

### 2.3.1. **JetspeedDeploy 和 DeploymentManager**

Jetpeed 部署工具 (JetspeedDeploy) 准备 Portlet 应用程序以在 Jetspeed 门户中进行部署。Jetspeed 要求将 servlet 添加到所有 portlet 应用程序的 web.xml 声明中，然后才能使用 Jetpeed 运行 portlet 应用程序。您可以通过手动编辑 web.xml 并添加所需的 servlet 来准备您的 portlet 应用程序以进行部署，或者该工具可以从命令行独立使用。或者，您也可以依靠 Jetspeed 添加 servlet 本身，因为部署工具内置在 Jetspeed 门户本身中。在门户内部，当一个新的 portlet 部署事件被注册时，**DeployPortletAppEventListener**调用**JetspeedDeploy**为部署准备 portlet 应用程序的工具。什么时候注册新事件？当您将 portlet 应用程序 WAR 放到 deploy 目录中时，该目录默认位于 Jetspeed WEB-INF/deploy 目录中。 **JetspeedDeploy**将 Web 应用程序存档 (.war) 从 WEB-INF/deploy 目录复制到目标目录（例如，Tomcat /webapps 目录）并解析**web.xml**、**portlet.xml**和 ，**context.xml** 以确保它们符合 Jetspeed-2 门户引擎。

![](file:///C:\Users\johnfeng\AppData\Local\Temp\ksohtml11556\wps47.png)

如果 servlet 尚不存在，则 部署工具将其注入**web.xml** servlet ，这对于部署到 Jetpeed 的任何 portlet 应用程序都是必需的：**JetspeedContainer**

<小服务程序>

<servlet-name>JetspeedContainer</servlet-name>

<display-name>Jetspeed 容器</display-name>

<description>用于 Jetspeed Portlet 应用程序的 MVC Servlet</description>

<servlet-class>org.apache.jetspeed.container.JetspeedContainerServlet</servlet-class>

<初始化参数>

  <param-name>contextName</param-name>

  <param-value>${portlet-application-name}</param-value>

</init-param>

<load-on-startup>0</load-on-startup>
</servlet>

...

<servlet 映射>

<servlet-name>JetspeedContainer</servlet-name>

<url-pattern>/container/*</url-pattern>
</servlet-mapping>

以同样的方式，**JetspeedDeploy**调用**JetspeedContextRewriter**来操作 portlet 应用程序**context.xml**文件。有关 Tomcat 的更多信息**context.xml**，请参阅[tomcat 的文档](#A word on Contexts)。

### 2.3.2. **JetspeedDeploy 独立使用**

**JetspeedDeploy**也可以通过命令行调用：

java -jar jetspeed-deploy-tools-<版本>.jar -s inputWarPath outputWarPath
在哪里：

· **-s**: 指示是否从应用程序中剥离到记录器的标志。当标志存在时，应用程序中可用的记录器将被删除。

· **inputWarPath**: 战争的路径来处理。

· **outputWarPath**: 加工战争的路径。

# 3. **Jetspeed 属性文件**

## 3.1. [**Jetspeed 属性**](https://portals.apache.org/jetspeed-2/deployguide/jetspeed-properties.html)

Jetspeed 默认配置属性位于目录中的**jetspeed.properties**文件中**/WEB-INF/conf/**。

Jetspeed 属性在运行时用于自定义 Jetspeed Portal 运行时门户行为。从 2.3.0 版开始，您必须在更改一个或多个属性后重新启动服务器。我们不建议编辑此文件。相反，请使用[Override Properties](https://portals.apache.org/jetspeed-2/deployguide/override-properties.html)文档中定义的过程。下面提供了从 2.3.0 版开始的所有属性的列表。此外，有关门户的进一步部署配置，请参阅[Spring 配置](https://portals.apache.org/jetspeed-2/deployguide/config-spring.html)文档。


| **财产**                 | **默认**        | **描述**                                                                                                                                                                                         |
| ------------------------ | --------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ |
| 包括                     | 覆盖.properties | [覆盖](https://portals.apache.org/jetspeed-2/deployguide/override-properties.html)jetspeed.properties。在覆盖中进行更改，而不是在 jetspeed.properties 中。这包括需要在任何其他属性定义之前出现。 |
| 门户网站名称             | 捷速            | 通过Portlet API返回到 Portlet 容器的门户名称                                                                                                                                                     |
| 门户版本                 | 2.3.0           | 当前版本的Jetspeed。                                                                                                                                                                             |
| portal.use.internal.jndi | 错误的          | 通过将此设置为true，引擎将创建自己的 JNDI 上下文。部署时不需要。我们改用 Tomcat 的 JNDI。对命令行实用程序和测试很有用。                                                                          |


| **门户网址导航**                           |          |
| ------------------------------------------ | -------- |
| **财产**                                   | **默认** |
| portalurl.navigationalstate.parameter.name | \_ns     |
| portalurl.relative.only                    | 错误的   |


| **合并门户请求参数**                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               |          |
| ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ | -------- |
| 在2.1版之前，Jetspeed 将门户请求参数与特定于 portlet 的参数合并，有效地允许“共享”参数。这不符合 JSR-168 PLT.11，因此默认情况下现在禁用。通过设置 merge.portal.parameters.with.portlet.parameters=true 这个特性可以“恢复”。在portal 和portlet 参数同名的情况下，默认情况下portlet 参数将首先在values 数组中提供，但这也可以通过设置merge.portal.parameters.before.portlet.parameters=true 来覆盖。将这两个属性都设置为 true 将提供“旧”的 2.1 之前的行为。注意：对于单个 portlet，可以通过将这些属性设置为 jetspeed-portlet.xml 中的元数据来覆盖这些全局设置。 |          |
| **财产**                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           | **默认** |
| 合并.portal.parameters.with.portlet.parameters                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     | 错误的   |
| 合并.portal.parameters.before.portlet.parameters                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   | 错误的   |


| **Portlet 模式支持** |            |
| -------------------- | ---------- |
| **财产**             | **默认**   |
| 支持的.portletmode   | 看法       |
| 支持的.portletmode   | 编辑       |
| 支持的.portletmode   | 帮助       |
| 支持的.portletmode   | 关于       |
| 支持的.portletmode   | 配置       |
| 支持的.portletmode   | 编辑默认值 |
| 支持的.portletmode   | 打印       |
| 支持的.portletmode   | 安全的     |


| **自动切换**                                                                                                                                                                                                                    |                                   |
| ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | --------------------------------- |
| 自动切换功能使门户网站能够为想要支持配置模式但尚未实现它的portlet使用内置的配置模式 portlet。此外，它还允许门户在 Edit_Defaults 模式下使用 portlet 的编辑模式。默认情况下，这两个功能都处于关闭状态。使用下面的属性来启用它们。 |                                   |
| **财产**                                                                                                                                                                                                                        | **默认**                          |
| 支持的.portletmode.autoswitch.config                                                                                                                                                                                            | 错误的                            |
| 支持的.portletmode.autoswitch.edit\_defaults                                                                                                                                                                                    | 错误的                            |
| 支持的.portletmode.autoswitch.config.surrogate.portlet                                                                                                                                                                          | j2-admin::CustomConfigModePortlet |


| **窗口状态支持**   |          |
| ------------------ | -------- |
| **财产**           | **默认** |
| 支持的.windowstate | 普通的   |
| 支持的.windowstate | 最大化   |
| 支持的.windowstate | 最小化   |
| 支持的.windowstate | 独奏     |


| **用户和角色默认值**                                                                     |          |
| ---------------------------------------------------------------------------------------- | -------- |
| 以下设置允许您为来宾（未经身份验证的）用户设置默认值，以及在需要时设置默认角色和用户名。 |          |
| **财产**                                                                                 | **默认** |
| default.user.principal                                                                   | 客人     |
| 默认.admin.user                                                                          | 行政     |
| default.admin.role                                                                       | 行政     |
| default.manager.role                                                                     | 经理     |
| 默认用户角色                                                                             | 用户     |
| default.guest.role                                                                       | 客人     |


| **LOG4J - 记录**                                                                                                                                                                                                                                                                                                                                                     |                                         |
| -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | --------------------------------------- |
| Log4J配置文件的位置。所有 Jetspeed 类别都在此文件中配置。Jetspeed 使用隔离的 Log4J 记录器，因此它不会干扰 App Server 或其他 portlet 应用程序的 Log4J 日志记录。默认情况下，所有日志记录都进入 /WEB-INF/conf/Log4j.properties 下的 Jetspeed Web 应用程序本身。您可能希望更改此配置以将日志文件指向分布式应用程序之外。在发行版中，所有日志记录都配置为**ERROR**级别。 |                                         |
| **记录器**                                                                                                                                                                                                                                                                                                                                                           | **地点**                                |
| 喷射速度                                                                                                                                                                                                                                                                                                                                                             | \${applicationRoot}/logs/jetspeed.log   |
| 冥王星                                                                                                                                                                                                                                                                                                                                                               | \${applicationRoot}/logs/pluto.log      |
| 安慰                                                                                                                                                                                                                                                                                                                                                                 | 系统控制台                              |
| ojb                                                                                                                                                                                                                                                                                                                                                                  | \${applicationRoot}/logs/ojb.log        |
| 速度                                                                                                                                                                                                                                                                                                                                                                 | \${applicationRoot}/logs/velocity.log   |
| 部署                                                                                                                                                                                                                                                                                                                                                                 | \${applicationRoot}/logs/deployment.log |


| **Portlet 容器**                                                                                                                     |                                                               |
| ------------------------------------------------------------------------------------------------------------------------------------ | ------------------------------------------------------------- |
| Portlet容器 Pluto 在此处配置。我们基本上只允许您插入另一个 portlet 容器或包装器。不是很常见，但您可能希望扩展 Pluto 以实现自定义行为 |                                                               |
| **财产**                                                                                                                             | **默认**                                                      |
| 容器.impl                                                                                                                            | org.apache.pluto.PortletContainerImpl                         |
| 容器包装器                                                                                                                           | org.apache.jetspeed.container.JetspeedPortletContainerWrapper |


| **Jetspeed管道** |               |
| ---------------- | ------------- |
| **财产**         | **默认**      |
| 管道.default     | jetspeed-管道 |


| **冥王星工厂**                                                                                                                                                                       |                                                             |
| ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ | ----------------------------------------------------------- |
| Portlet容器 Pluto 2.0 可通过工厂进行扩展。Pluto 的行为可以被这个工厂机制覆盖。一些出厂配置在这里。其他配置直接在Spring中编码。有关详细信息，请参阅 Spring 配置 pluto-factories.xml。 |                                                             |
| **财产**                                                                                                                                                                             | **默认**                                                    |
| factory.container.response                                                                                                                                                           | org.apache.jetspeed.container.ContainerResponse             |
| factory.container.request                                                                                                                                                            | org.apache.jetspeed.container.ContainerRequest              |
| factory.invoker.servlet                                                                                                                                                              | org.apache.jetspeed.container.invoker.ServletPortletInvoker |
| factory.invoker.servlet.mapping.name                                                                                                                                                 | /容器                                                       |
| factory.invoker.local                                                                                                                                                                | org.apache.jetspeed.container.invoker.LocalPortletInvoker   |


| **能力，内容编码**      |            |
| ----------------------- | ---------- |
| **财产**                | **默认**   |
| content.defaultencoding | iso-8859-1 |


| **自动部署**                                                                                                                                                                                             |                                    |
| -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ---------------------------------- |
| 自动部署配置。通过手动将war文件复制到暂存目录或通过[Jetspeed PALM](https://portals.apache.org/jetspeed-2/adminguide/palm.html)远程自动部署portlet应用程序。这些属性中的大多数仅适用于 Tomcat，如下所示。 |                                    |
| **财产**                                                                                                                                                                                                 | **默认**                           |
| 自动部署.staging.dir                                                                                                                                                                                     | \${applicationRoot}/WEB-INF/deploy |
| 自动部署.target.dir                                                                                                                                                                                      | \${applicationRoot}/../            |
| 自动部署延迟                                                                                                                                                                                             | 10000                              |


| **应用程序服务器管理器（仅限Tomcat）**                                                                                                                                                                                                                                              |          |
| ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | -------- |
| 通过j2-admin PortletApplicationManager portlet进行运行时应用程序生命周期管理。这仅适用于 Tomcat，并且需要启用和配置对 Tomcat 管理器的访问权。有关详细信息，请参阅部署者指南中的[Tomcat管理器和 Jetspeed](https://portals.apache.org/jetspeed-2/deployguide/guide-tomcat.html)部分。 |          |
| **财产**                                                                                                                                                                                                                                                                            | **默认** |
| 应用程序服务器主机                                                                                                                                                                                                                                                                  | 本地主机 |
| 应用程序服务器端口                                                                                                                                                                                                                                                                  | 8080     |
| application.server.manager.script.path                                                                                                                                                                                                                                              | /经理    |
| application.server.manager.name                                                                                                                                                                                                                                                     |          |
| application.server.manager.password                                                                                                                                                                                                                                                 |          |


| **Spring 配置目录位置（程序集）**        |                 |
| ---------------------------------------- | --------------- |
| Jetspeed在 Spring Framework 容器中配置。 |                 |
| **财产**                                 | **默认**        |
| 程序集.dir                               | /WEB-INF/程序集 |
| 程序集.扩展                              | .xml            |


| **电子邮件**             |                                                          |
| ------------------------ | -------------------------------------------------------- |
| **财产**                 | **默认**                                                 |
| 电子邮件管理员           | someemailaddress@somecompanyororganization.comororgornet |
| 电子邮件管理器           | someemailaddress@somecompanyororganization.comororgornet |
| email.userinfo.attribute | 用户邮箱                                                 |


| **布局**                                                    |                                      |
| ----------------------------------------------------------- | ------------------------------------ |
| Jetspeed布局用于门户页面的表格结构。布局作为 portlet 实现。 |                                      |
| **财产**                                                    | **默认**                             |
| layout.page.default                                         | jetspeed-layouts::VelocityTwoColumns |
| layout.page.storeViewPageInSession                          | 真的                                 |


| **装饰器**                                             |            |
| ------------------------------------------------------ | ---------- |
| Jetspeed装饰器是可以装饰门户页面或portlet 窗口的皮肤。 |            |
| **财产**                                               | **默认**   |
| 装饰器.page.default                                    | 底格里斯河 |
| 装饰器.portlet.default                                 | 底格里斯河 |


| **PSML**             |               |
| -------------------- | ------------- |
| **财产**             | **默认**      |
| psml.template.folder | /\_用户/模板/ |


| **页面管理器缓存**                                                             |             |
| ------------------------------------------------------------------------------ | ----------- |
| 页面管理器的本地和分布式缓存。使用覆盖属性来启用这些属性。以下设置为默认设置。 |             |
| **财产**                                                                       | **默认**    |
| org.apache.jetspeed.ehcache.pagemanager.maxelements                            | 128         |
| org.apache.jetspeed.ehcache.pagemanager.element.ttl                            | 150         |
| org.apache.jetspeed.ehcache.pagemanager.maxfiles                               | 1000        |
| org.apache.jetspeed.ehcache.config.resource                                    | ehcache.xml |
| org.apache.jetspeed.ehcache.group.address                                      | 230.0.0.1   |
| org.apache.jetspeed.ehcache.group.port                                         | 4446        |
| org.apache.jetspeed.ehcache.group.ttl                                          | 1           |
| org.apache.jetspeed.ehcache.hostname                                           |             |
| org.apache.jetspeed.ehcache.port                                               | 40001       |


| **探查器**                   |          |
| ---------------------------- | -------- |
| **财产**                     | **默认** |
| profiler.rule.names.default  | 页       |
| profiler.rule.values.default | j2       |


| **用户注册**                                                                             |          |
| ---------------------------------------------------------------------------------------- | -------- |
| 用户注册默认设置。在新用户注册期间可以分配一个或多个角色和组。角色或组列表应以逗号分隔。 |          |
| **财产**                                                                                 | **默认** |
| 注册.roles.default                                                                       | 用户     |
| 注册.groups.default                                                                      |          |

## 3.2. [**覆盖属性**](https://portals.apache.org/jetspeed-2/deployguide/override-properties.html)

**jetspeed.properties**可以通过创建**/WEB-INF/conf/override.properties**文件来覆盖默认值。也可以在此文件中声明其他属性。

强烈建议您**永远不要**更改**jetspeed.properties**，而只修改 override.properties 以进行任何属性配置更改。原因很简单：升级。新版本的 Jetspeed 可以对 jetspeed.properties 进行更改，您所做的修改将会丢失。如果您使用 override.properties，您的修改将继续覆盖 Jetspeed 属性的后续版本。

属性被属性名称覆盖。例如，如果 jetspeed.properties 中有一个属性，例如：

email.sender = admin@somedomain.com
要将其覆盖到您公司的 Jetspeed 门户上的邮件服务器，请不要编辑 jetspeed.properties，而是编辑 override.properties，将属性设置为同名：

email.sender = admin@aig-handouts.com
### 3.2.1. **示例 override.properties 文件**

# 使用它来覆盖 jetspeed.properties 中的设置

psml.pages.path = ${applicationRoot}/WEB-INF/some-pages

email.sender = emailsender@somedomain.com

merge.portal.parameters.with.portlet.parameters=true

email.admin = emailadmin@somedomain.com

# 系统管理员邮箱

email.manager = emailmanager@somedomain.com

# 电子邮件用户信息属性（非标准）

email.userinfo.attribute = user.email

# smtp 邮件服务器地址

email.smtp.server.address=secondhost

# smtp 电子邮件服务器用户名

email.smtp.user.name=

# smtp 电子邮件服务器用户密码

email.smtp.user.password=

#mail.smtp.auth

email.smtp.auth=false

### 3.2.2. **变量替换**

可以使用称为变量替换的语法来引用在 jetspeed.properties（甚至在 override.properties 中更高级）中声明的变量。在定义一个属性时，您可以通过用“${}”将引用的变量名括起来来引用另一个属性的值：

	${变量名}
Jetspeed 为您提供了一个名为 ${applicationRoot} 的变量。此变量引用您的 Web 应用程序的完整文件系统路径。它对于引用未作为 Web 应用程序资源（使用 java.io.File 打开）打开的资源（例如 PSML 文件的位置）很有用。

# 4. **弹簧配置**

## 4.1. [**介绍**](https://portals.apache.org/jetspeed-2/deployguide/config-spring.html)

Spring 是一个独特的 Java 应用程序框架，旨在简化应用程序的开发。企业 Java Bean 使用起来非常复杂，而[Spring 框架](http://www.springframework.org/)是一个易于使用和理解的企业应用程序框架。春天的重点是：

· 提供一种简单的方法来管理对象的生命周期和关系（通过依赖注入）。

· 分层架构。Spring 是全面而模块化的。你只使用你需要的东西。例如，您可能只使用 JDBC 支持而不在整个框架中进行链接。

· 推广最佳软件开发实践。例如，Spring 旨在始终促进测试驱动开发并消除对工厂和单例的需求。

· 控制反转。Spring 是一个应用程序容器，支持拦截和声明性的面向方面编程。

Spring是一个开源项目；但是它不在 Apache 中。

### 4.1.1. **Jetspeed + 弹簧**

Jetspeed 门户完全配置为 Spring 应用程序。Jetspeed 中的所有服务都是作为 Spring bean 构建和配置的。Jetspeed 在 Spring 容器中运行。Spring 为自定义您的 Jetspeed 部署提供了一个很好的环境。Jetspeed 中 Spring 的一些额外好处是：

· Spring 配置文件中的面向方面编程。

· 热交换：允许实现隐藏和交换。

· 故障转移：当一个组件发生故障时故障转移到下一个组件。

· 多播：将方法调用多播到多个组件。

· 生命周期管理：启动、暂停和恢复组件。

### 4.1.2. **组件在 Spring 容器中运行**

Jetspeed 作为一个 Spring 应用程序，是一个组件或服务的集合，它们全部组装在一起以创建一个完整的工作门户。如果从这个角度来看，可以看到主要的门户组件都由容器管理，它实际上只是一个 Spring 容器，如下图所示。请注意，这绝不是 Spring 中连接的所有 Jetspeed 服务的完整列表：

![](file:///C:\Users\johnfeng\AppData\Local\Temp\ksohtml11556\wps48.png)

### 4.1.3. **Jetspeed API 编程**

在开发 Jetspeed 核心、Jetspeed 扩展或 Jetspeed 管理 Portlet 时，您应该始终对 Jetspeed API 进行编程。所有 Jetspeed 组件都在接口上连接在一起，而不是类实现。这种按接口进行编程的方法为开发企业门户应用程序提供了强大且可扩展的编程模型。当您配置 Jetspeed Spring 组件（bean）时，您会看到组件的依赖关系通过依赖注入连接到其他 Jetspeed 组件。注入的依赖项始终是接口。在 Spring 配置中以声明方式管理依赖项。在 Jetspeed 中，我们支持构造函数和 setter 依赖注入。

<bean id='PortalAdministrationImpl' init-method="start"

  类='org.apache.jetspeed.administration.PortalAdministrationImpl'>

	<构造函数参数索引='0'>

		<ref bean="org.apache.jetspeed.security.UserManager"/>

	</constructor-arg>

    <构造函数参数索引='1'>

		<ref bean="org.apache.jetspeed.security.RoleManager"/>

	</constructor-arg>

    <构造函数参数索引='2'>

		<ref bean="org.apache.jetspeed.security.GroupManager"/>

	</constructor-arg>

    <构造函数参数索引='3'>

		<ref bean="org.apache.jetspeed.page.PageManager"/>

	</constructor-arg>

    <构造函数参数索引='4'>

		<ref bean="org.apache.jetspeed.prefs.PreferencesProvider"/>

	</constructor-arg>        

    <构造函数参数索引='5'>

		<ref bean="org.apache.jetspeed.profiler.Profiler"/>

	</constructor-arg>

    <构造函数参数索引='6'>

		<ref bean="mailSender"/>

	</constructor-arg>

    <构造函数参数索引='7'>

		<ref bean="adminVelocityEngine"/>

	</constructor-arg>                                                            
</豆>

这是与 Spring 配置匹配的 Java 代码构造函数。请注意，注入的依赖项是接口，而不是具体的类实现：

公共 PortalAdministrationImpl( UserManager userManager,

                             角色管理器角色管理器，

                             组管理器组管理器，

                             页面管理器页面管理器，

                             PreferencesProvider 偏好，

                             探查器探查器，

                             JavaMailSender 邮件发送器，

                             速度引擎速度引擎）
## 4.2. [**数据源引导**](https://portals.apache.org/jetspeed-2/deployguide/config-datasource.html)

Jetspeed 在 Jetspeed 引擎中使用了两个 Spring 容器。第一个容器是**Bootstrap**容器。它包含所有与数据库相关的 Spring 组件。第二个容器是通用的Jetspeed容器。它包含所有其他 Jetspeed 组件。在引导程序中配置的主要文件是 datasource.xml 文件。

可以通过 JNDI 或直接使用 JDBC 和 DBCP 连接池数据源以两种模式配置数据库。

### 4.2.1. **JNDI 数据库配置**

使用 JNDI 进行配置时，Jetspeed 不处理 JDBC 数据源的管理。数据源和数据库连接池通常由应用程序服务器处理，例如 Tomcat 或 Websphere。使用 Spring，我们通过 JDNI 名称配置 JNDI bean，并将其与应用程序服务器中配置的 Tomcat 或 Websphere JNDI 资源匹配。

<bean id="JetspeedDS" class="org.springframework.jndi.JndiObjectFactoryBean">

    <property name="resourceRef"><value>false</value></property>

    <属性名称="jndiName">

        <value>java:comp/env/jdbc/jetspeed</value>

    </属性>

</豆>
此方法是 Jetspeed 的默认配置。这允许应用程序管理数据库连接池并可能与其他 Web 应用程序中的 JNDI 资源一起使用

### 4.2.2. **JDBC/DBCP 数据库配置**

在 spring datasource.xml 中有第二个 bean，被注释掉了。它与基于 JNDI 的实现同名。所以你不能同时使用这两个bean。您必须选择一个，并注释掉另一个。通过 JDBC/DBCP（数据库连接池）配置，我们直接在 Jetspeed Web 应用程序中设置数据库连接。我们还在这里设置了四个标准的 JDBC 连接属性：

<bean id="JetspeedDS" class="org.apache.commons.dbcp.BasicDataSource"

    销毁方法=“关闭”

    >

            <property name="driverClassName"><value>com.mysql.jdbc.Driver</value></property>

            <property name="url"><value>jdbc:mysql://localhost/j2test</value></property>

            <property name="username"><value>j2</value></property>

            <property name="password"><value>XXX</value></property>

    </豆>    
## 4.3. [**覆盖**](https://portals.apache.org/jetspeed-2/deployguide/config-overrides.html)

位于 中的 Spring Configuration Overrides**/WEB-INF/assembly/override/**加载在父程序集文件夹 ( **/WEB-INF/assembly/**) 中的配置文件上。使用 override 文件夹修改默认程序集配置。目录中有覆盖的示例**/WEB-INF/assembly/alternate/**。请注意，在备用目录中找到的配置文件只是示例。它们没有被积极使用。如果您想使用备用配置文件之一，请将其复制到 overrides 目录，然后从那里进行修改。

Spring bean 被名称替换。因此配置文件在覆盖时不需要按文件名匹配。但是，如果您只覆盖一个 bean，则只需将 Jetspeed Spring 主容器中的 bean 放入一个仅包含该 bean 的新文件中即可更容易。

### 4.3.1. **示例弹簧覆盖**

例如，假设我们要覆盖 Jetspeed 的 pipelines.xml 文件中的 CapabilityValve：

  <bean id="capabilityValve"

    class="org.apache.jetspeed.capabilities.impl.CapabilityValveImpl"

    初始化方法="初始化"
<构造函数参数>

   <ref bean="org.apache.jetspeed.capabilities.Capabilities" />
</constructor-arg>

</豆>

pipelines.xml 有很多 bean。我们只需要用我们的实现替换一个bean，capabilityValve。注意bean id是一样的，impl是不同的：

  <bean id="capabilityValve"

    class="com.ace.capabilities.impl.AceCapabilityValveImpl"

    初始化方法="初始化"
<构造函数参数>

   <ref bean="com.ace.services.AceDataService" />
</constructor-arg>

</豆>

将这个bean 保存在一个名为capability-valve-override.xml 的文件中将清楚地定义要覆盖的内容。

Jetspeed 中常用的覆盖是：

· DBPSML

· 版本化部署

· 添加 Jetspeed 服务

· 管道或调整功能

### 4.3.2. **DBPSML**

PSML 代表门户中的页面。可以有很多。默认实现将 PSML 文件存储在文件系统上。辅助实现将文件存储在数据库中。当部署到集群的 Jetspeed 发行版，或者当您有数以万计的用户需要性能时，存储在数据库中是必要的。在备用目录中提供的是 DBPSML 备用配置 db-page-manager.xml。您可以获取此文件并将其复制到您的覆盖目录中。它将按名称覆盖 page-manager.xml bean。

<bean id="org.apache.jetspeed.page.PageManagerImpl"

    名称="pageManagerImpl"

    初始化方法=“初始化”

    class="org.apache.jetspeed.page.impl.DatabasePageManager">

  <!-- OJB配置文件资源路径-->

  <constructor-arg index="0"><value>JETSPEED-INF/ojb/page-manager-repository.xml</value></constructor-arg>       

  <!-- 权限安全启用标志，默认=false -->

  <constructor-arg index="1"><value>false</value></constructor-arg>

  <!-- 约束安全启用标志，默认=true -->

  <constructor-arg index="2"><value>true</value></constructor-arg>

  <!-- 文件夹/页面/链接缓存 -->

  <constructor-arg index="3"><ref bean="pageManagerOidCache"/></constructor-arg>

  <!-- 文件夹/页面/链接路径缓存 -->

  <constructor-arg index="4"><ref bean="pageManagerPathCache"/></constructor-arg>
</豆>

### 4.3.3. **版本化部署**

默认的 Jetspeed Deployer，虽然它适用于 Tomcat 上的开发，但在集群环境中效果不佳。我们已经为集群环境实现了第二个版本化 Portlet 应用程序管理器。节点管理器的实现很可能在未来被弃用。在部署到具有复制数据库和复制应用程序服务器的集群时，我们遇到了基于 NodeManager 的集群支持的限制。默认的 PAM（Portlet 应用程序管理器）不适用于门户的许多部署。PAM 的第二个版本没有侦听器，并且基于 jetspeed-portlet.xml 元数据中提供的版本号的更简单的部署算法 如果未找到此字段，或者它等于或小于数据库中的版本，则不会部署 PA。这将允许在集群中放入 2..n 个 PA，而无需重新注册。重新注册的问题是注册算法从数据库中深度删除旧的 PA def，创建一个带有所有新 OID 的新 PA，使集群中其他节点上的所有其他 PA 和 portlet 无效。

<bean id="deployFactory" class="org.apache.jetspeed.tools.deploy.JetspeedDeployFactory"/>

<bean id="org.apache.jetspeed.tools.pamanager.PortletApplicationManager"

   class="org.apache.jetspeed.tools.pamanager.VersionedPortletApplicationManager" init-method="start" destroy-method="stop"
   <constructor-arg><ref bean="portletFactory"/></constructor-arg>

   <constructor-arg><ref bean="org.apache.jetspeed.components.portletregistry.PortletRegistry"/></constructor-arg>

   <constructor-arg><ref bean="org.apache.jetspeed.components.portletentity.PortletEntityAccessComponent"/></constructor-arg>

   <constructor-arg><ref bean="org.apache.jetspeed.container.window.PortletWindowAccessor"/></constructor-arg>

   <constructor-arg><ref bean="org.apache.jetspeed.security.PermissionManager"/></constructor-arg>       

   <constructor-arg><ref bean="org.apache.jetspeed.search.SearchEngine"/></constructor-arg>              

   <constructor-arg><ref bean="org.apache.jetspeed.security.RoleManager"/></constructor-arg>                     

   <!-- 在部署 Portlet 应用程序期间分配默认权限的角色主体 -->

   <构造函数参数>

     <列表>

        <value>用户</value>

     </列表>

   </constructor-arg>

   <!-- 应用根目录 -->

    <构造函数参数>

        <value>${applicationRoot}</value>

    </constructor-arg>
<!-- 用于自动创建部署的 web.xml 中定义的尚未存在的角色的可选配置：

       <property name="autoCreateRoles"><value>true</value></property>

   -->

<!-- 可选描述符更改监视器检查间隔，以秒为单位（0：禁用，默认值：10）：

       <property name="descriptorChangeMonitorInterval"><value>10</value></property>

   -->

<!-- 如果注册 ths PA 出错，可选的最大 PA 启动重试次数（0：不重试，默认值：10）：

   		这是因为集群环境中的数据库约束验证错误而引入的

   		见 https://issues.apache.org/jira/browse/JS2-666

       <property name="maxRetriedStarts"><value>10</value></property>

   -->

</豆>

在备用目录中提供的是部署备用配置，deployment.xml。您可以获取此文件并将其复制到您的覆盖目录中。它将按名称覆盖 deployment.xml bean。

### 4.3.4. **添加 Jetspeed 服务**

有时您可能会编写自己的服务以在 Jetspeed 中运行。您需要将服务添加到 PortalServices bean。不幸的是，这需要剪切和粘贴整个 PortalServices bean，并将您的服务添加到覆盖的 jetspeed-services.xml 中的地图中：

<豆类>

<!-- Portlet 服务 -->

<bean id="门户服务"

   类="org.apache.jetspeed.services.JetspeedPortletServices" >

   <构造函数参数>

   	<地图>

   	...

      <entry key="MyNewService">

      	<ref bean="com.ace.services.MyNewService"/>

      </entry>          

   	</地图>

   </constructor-arg>
</豆>

</beans>

在这种情况下，获取 jetspeed-services.xml，将其复制到您的 WEB-INF/assembly/override 目录，并在那里修改它以添加您的新服务

## 4.4. [**条件弹簧**](https://portals.apache.org/jetspeed-2/devguide/spring-config.html)

Jetspeed 为特定的配置设置提供了非常灵活的方法。

Jetspeed 组件最初是从**/WEB-INF/assembly/**文件夹加载的，而默认配置属性是从文件夹加载的**/WEB-INF/conf/jetspeed.properties.**

初始/默认配置可以通过**/WEB-INF/assembly/override/**文件夹覆盖，而覆盖/附加值可以通过**/WEB-INF/conf/override.properties.**

另一个新特性是有条件的 Spring 程序集加载。Jetspeed 提供了一个扩展的 BeanFactory，它根据预定义的配置检查加载的 Spring BeanDefinition 是否有一些额外的元数据（在 Spring 配置本身中定义），可以“阻止”在 Spring 中注册 BeanDefinition，从而有效地过滤掉某些定义。

### 4.4.1. **条件弹簧组件加载**

#### 4.4.1.1. **Jetspeed 类别元数据**

在 Jetspeed 程序集文件中，bean 定义应具有**j2:cat**如下示例的元数据：

<bean name="xmlPageManager" class="org.apache.jetspeed.page.psml.CastorXmlPageManager">

<meta key="j2:cat" value="xmlPageManager 或 pageSerializer" />

...
</豆>

在上面的示例中，**xmlPageManager**bean 定义包含在两个类别中：**xmlPageManager**和**pageSerializer**. 如果 Jetspeed 的 Spring 过滤器键设置包含其中一个类别，则**xmlPageManager**bean 定义将被注册。否则，bean 定义将被忽略。通过 Spring 过滤键设置，程序集文件中的 bean 定义将根据它们的类别进行过滤。

#### 4.4.1.2. **Spring过滤器键和类别设置**

Jetspeed 的 Spring 过滤器设置在**/WEB-INF/conf/spring-filter.properties**.

在该文件中，默认提供以下类别定义：


| **筛选键**                  | **映射类别**                                                                                                                  | **描述**                                                                                                   |
| --------------------------- | ----------------------------------------------------------------------------------------------------------------------------- | ---------------------------------------------------------------------------------------------------------- |
| 默认                        | 默认                                                                                                                          | 大多数常见组件的默认类别                                                                                   |
| 基地门户                    | \${默认}, jndiDS, xmlPageManager                                                                                              | 门户实例的基本类别，用于其他类别定义。在这个类别中，提供了数据源组件和基于xml的页面管理器。                |
| 门户网站                    | \${basePortal}, dbSecurity                                                                                                    | 门户实例的默认类别。通过basePortal类的组件，提供了基于数据库的安全组件。                                   |
| 门户网站.ldap               | \${basePortal}，ldapSecurity                                                                                                  | 门户实例的类别。通过basePortal类别的组件，提供了基于 LDAP 的安全组件。                                     |
| 门户网站.dbPageManager      | \${默认}, jndiDS, dbPageManager, dbSecurity                                                                                   | 门户实例的类别。在此类别中，提供了默认组件、数据源组件和基于数据库的页面管理器和基于数据库的安全组件。     |
| 门户网站.dbPageManager.ldap | \${default}、jndiDS、dbPageManager、ldapSecurity                                                                              | 门户实例的类别。在此类别中，提供了默认组件、数据源组件和基于数据库的页面管理器以及基于LDAP的安全组件。     |
| baseSerializer              | jdbcDS、序列化程序、功能、安全性、分析器、注册表、搜索、事务、缓存、首选项、springProperties、noRequestContext、noPageManager | Jetspeed串行器的基本类别，用于其他串行器类别定义。在此类别中，提供了播种和序列化 Jetspeed 数据的必要组件。 |
| 串行器                      | \${baseSerializer}, dbSecurity                                                                                                | 序列化程序的默认类别。在此类别中，提供了基于数据库的安全组件。                                             |
| 序列化程序.ldap             | \${baseSerializer}, ldapSecurity                                                                                              | 序列化程序的类别。在此类别中，提供了基于LDAP的安全组件。                                                   |
| 页面序列化器                | jdbcDS、基础、pageSerializer、事务、springProperties、安全、dbSecurity、缓存                                                  | 页面序列化程序的类别。                                                                                     |

注意：**\${} **括起来的表达式将被引用的属性值扩展。

默认情况下，门户实例的过滤器键设置为**portal**。要更改这一点，您可以**spring.filter.key**在以下属性文件之一中 定义一个属性**/WEB-INF/conf/spring-filter-key.properties**：**/WEB-INF/conf/override.properties**或**/WEB-INF/conf/jetspeed.properties**. 例如，您可以将 Jetspeed Portal 与基于 LDAP 的安全组件一起使用：

spring.filter.key = 门户.ldap

#### 4.4.1.3. **Spring 过滤器键和动态 Bean 别名**

因为每个 bean 的 id 在 bean 所在的 BeanFactory 或 ApplicationContext 中必须是唯一的，所以我们不能对多个不同的 bean 使用相同的 bean id。

例如，可以有两个选项来选择页面管理器 bean 组件：基于 xml 的页面管理器或基于数据库的页面管理器。如果其他一些 bean 应该引用过滤页面管理器，则它们应该与过滤页面管理器分组在同一类别中。因此，应该有许多冗余的 bean 定义，这使得维护非常困难。

因此，Jetspeed 提供了一种使用 spring bean 过滤解决方案动态别名 bean 的方法。在以下示例中，前两个 bean 定义没有 id，但它们具有相同的**j2:alias**元数据值。Jetspeed 自定义 BeanFactory 根据此元数据动态注册别名。最后，最后一个 bean 定义可以使用别名来引用选定的 bean **org.apache.jetspeed.page.PageManager**，。

<bean class="org.springframework.beans.factory.config.BeanReferenceFactoryBean">

<meta key="j2:cat" value="xmlPageManager" />

<meta key="j2:alias" value="org.apache.jetspeed.page.PageManager" />

<property name="targetBeanName" value="xmlPageManager" />

</豆>

<bean class="org.springframework.beans.factory.config.BeanReferenceFactoryBean">

<meta key="j2:cat" value="dbPageManager" />

<meta key="j2:alias" value="org.apache.jetspeed.page.PageManager" />

<property name="targetBeanName" value="dbPageManager" />

</豆>

<bean id="org.apache.jetspeed.portalsite.PortalSite" name="portalSite"

class="org.apache.jetspeed.portalsite.impl.PortalSiteImpl">

<meta key="j2:cat" value="default" />

<constructor-arg index="0">

<ref bean="org.apache.jetspeed.page.PageManager" />
</constructor-arg>

</豆>

注意：多个别名可以通过逗号或空格分隔的字符串设置为** j2:alias **元数据值。

# 5. **JetUI**

## 5.1. [**JetUI 配置**](https://portals.apache.org/jetspeed-2/deployguide/guide-jetui.html)

Jetspeed 2.2.1 版引入了JetUI 渲染引擎。JetUI 是现已弃用和删除的 Jetspeed 桌面管道的替代品。JetUI 主要关注高级门户定制和渲染功能。使用 JetUI，我们并没有放弃纯服务器端渲染。Jetspeed 仍将完全支持门户页面的经典服务器端渲染。在 2.2.1 版中，您可以直接从安装程序中使用两个渲染引擎：

1. 经典（门户页面）渲染引擎
2. JetUI 渲染引擎

在本文档中，我们介绍了 JetUI 的许多新功能......

· [Jetspeed Spaces](#spaces)，门户网站的安全区域，用于工作组和项目

· [空间导航器](#spacesNavigator)，快速导航到空间

· JetUI 使用更简单的算法将[URL](#mappingURLs)直接映射到空间和页面，它不使用分析器

· [拖放** portlet**](#dragDrop)

· [停靠工具栏](#docking)

· [分离和关闭** portlet**](#detached)

· [调整** portlet **的大小](#resizing)

· [Jetspeed 工具箱](#toolbox)，一个可停靠的 portlet 选择器、布局选择器和主题选择器

· [Jetspeed Navigator](#navigator)导航空间，维护页面、文件夹、链接

· 从 Jetspeed Toolbox[预览** Portlet **模式](#preview)

· 从 Jetspeed Toolbox[克隆** Portlet**](#clone)

· JetUI 中内置的用于门户定制和注册表操作的[JAX RS 服务](http://portals.apache.org/jetspeed-2/devguide/guide-rest-api.html)

· [与页面和动态模板](https://portals.apache.org/jetspeed-2/deployguide/guide-page-templates.html)集成

· [扩展** PSML **以支持 JetUI 结构](#extensions)

· [Jetspeed 属性配置](#properties)

· [管道配置](#pipeline)

从 Jetspeed 2.3.0 版开始，JetUI 目前可以做的事情有一些限制：

· 不支持自定义嵌套布局

· 仅支持四个主题（一栏、二栏、三栏、四栏）

· 不支持[高级模板](https://portals.apache.org/jetspeed-2/deployguide/guide-page-templates.html)（DPSML、TPSML）定制

· JetUI 不适用于 Jetspeed Profiler。JetUI 不支持子站点。使用 Spaces 功能代替子网站。

**开启 JetUI**

有几个选项可以打开 JetUI 渲染和自定义引擎。第一个选项是使用我们[打包](http://portals.apache.org/jetspeed-2/download.html) 的安装程序安装 Jetspeed 安装程序会询问您是否要安装**JetUI**或**Classic**门户管道。您不能同时运行两者。默认为 JetUI。

![](file:///C:\Users\johnfeng\AppData\Local\Temp\ksohtml11556\wps49.jpg)

第二个选项是使用[Custom Builder](http://portals.apache.org/jetspeed-2/buildguide/jetspeed-mvn-plugin.html)构建 Jetspeed 。[构建指南](http://portals.apache.org/jetspeed-2/buildguide/index.html)有点冗长，并且有很多关于 Maven 内部的信息。这里有一些命令可以帮助你克服所有这些......

列出自定义构建器中可用的所有构建命令：

mvn jetspeed:mvn -Dlist

使用多个 portlet 应用程序构建和部署整个支持 JetUI 的门户演示，并将其部署到 Tomcat

mvn jetspeed:mvn -Dtarget=ui

仅使用 j2-admin portlet 应用程序构建和部署启用 JetUI 的最小应用程序并将其部署到 Tomcat

mvn jetspeed:mvn -Dtarget=min-ui

上述两个选项的变体，启用了[DBPSML](#DBPSML) L

mvn jetspeed:mvn -Dtarget=ui-dbpsml

mvn jetspeed:mvn -Dtarget=min-ui-dbpsml

第三个选项是手动切换到在部署的 Jetspeed 安装上使用 JetUI 门户。**编辑 WEB-INF/conf/jetspeed.properties（或 WEB-INF/conf/override.properties），您可以通过将jetui.customization.method**设置为 Classic手动从 Classic 模式切换到 JetUI 模式：**server** ; 或 JetUI: **ajax**。

jetui.customization.method=ajax

此外，您可以设置默认管道，但如果您通过使用 /jetspeed/ui 而不是 /jetspeed/portal 寻址所有 URL 直接命中 JetUI 管道，则没有必要

pipeline.default = jetui-pipeline

最后，如果您希望 /jetspeed/portal 进入 JetUI 管道，请将 pipelines.xml 管道映射 bean 更改为：

    <入口键='/门户'>

      <value>jetui-管道</value>

    </entry>
### 5.1.1. **捷速空间**

如果您要部署 JetUI 站点，了解空间的配置方式非常重要。空间是 Jetspeed 站点的顶级组织。您可以使用空间将项目或团队组织或分组到一个公共区域。空间与文件夹有很多共同点，它们支持所有文件夹功能和元数据。就像文件夹一样，空间可以对它们有特定的安全限制。有两种管理工具可用于管理空间：[空间管理器](https://portals.apache.org/jetspeed-2/adminguide/space-manager.html) 和空间导航器。空间管理器允许您维护空间，例如，如果您想添加或修改空间，请使用空间管理器。

**配置空间** 除了两个例外，空间只能是顶级文件夹。您可以通过编辑任何空间的**folder.metadata**文件来配置您的空间。在任何顶级目录的**folder.metadata文件中，您可以通过添加空间所有者**元数据属性将该文件夹设为空间：

<metadata name='space-owner' xml:lang='en'>admin</metadata>  

添加此单个属性后，该文件夹将从普通文件夹提升为空间。您还可以使用空间管理器来创建空间。还有另外两种空间：

· 默认或公共空间

· 用户空间，每个用户都有自己的空间

公共空间实际上是 Jetspeed 站点的根目录。它具有**public-view**的安全约束，这意味着只有管理员可以编辑它，并且所有其他用户都可以查看公共空间。公共空间很重要，因为您可以在此处设置系统中所有其他空间和文件夹继承的元数据。例如，您可以在根公共空间的 folder.metadata 文件中为整个站点设置主题或默认安全策略。当然 Spaces 可以覆盖这些设置。

每个用户都有自己的空间。用户空间位于**/\_user/{username}**文件夹中。用户名通常在空间所有者元数据标签中设置为空间所有者。

当新用户添加到系统中时，Jetspeed 将为该用户创建一个主空间，并将模板文件夹的内容复制到该用户的默认主空间中。**您可以在/\_template/new-user**文件夹中配置新用户模板。在这里，您将找到一个 folder.metadata 文件，以及其他几个页面文件，这些文件在创建该用户时都被复制到一个新的用户主空间中。空间所有者元数据标签由 Jetspeed 自动添加到文件夹元数据中。此外，某些正则表达式规则用于构建来自 Jetspeed Page Navigator 的菜单。下面的正则表达式是默认的，它告诉页面导航器显示当前目录中页面和文件夹的菜单，以及用户主空间中的所有链接。

<menu name="space-navigations" regexp="true" options="+/*/,+/*.psml" depth="-1"/>

<menu name="space-links" regexp="true" options="+/*.link"/>

还有一个模板用于创建新空间时使用。此模板位于**/\_template/space**下。您可以在此处配置在创建新空间时应用哪些默认页面、链接和安全约束。随意修改文件，或在 /\_template 中为您的系统找到的用户和空间模板中添加更多页面。

**未来方向 - 空间**

空间还支持称为环境的额外内容组织。环境是空间的集合。JetUI 目前不支持环境管理。Spaces 与 JetUI 一起被引入 Jetspeed 2.2.1 版。Jetspeed 的未来版本将支持到空间的完整域映射。域映射将启用诸如白标门户之类的用例，其中不同的 URL 映射到不同的空间或环境。在即将发布的版本中，Jetspeed 将支持多域安全。这意味着您可以设置用户域，并将这些用户与域和空间集相关联。

### 5.1.2. **太空导航器**

Space Navigator 是一个特殊的导航portlet，使用户可以快速访问空间。从 Space Navigator，您可以导航到系统中您可以安全访问的任何空间以查看该空间。此外，管理员可以从 Space Navigator 编辑当前空间以及创建新空间。Space Navigator 是使用 JetUI 引入的两个新特性实现的：页面模板和分离的 portlet。为了让 Space Navigator 出现在系统中的每个页面上，我们在名为**template.tpsml**的页面模板的根文件夹中配置了 Space Navigator 。由于这个 portlet 定义在系统范围的页面模板中，它会自动出现在系统中的每个页面上，让您的用户始终可以访问空间导航。

<fragment id="jsSpaceNavigator" type="portlet" name="j2-admin::SpaceNavigator" decorator='clear'>

        <property name="y" value="300"></property>

        <property name="x" value="20"></property>            

        <property name="state" value="detach"></property>                        

</片段>
此外，Space Navigator 是一个分离的 portlet。**JetUI 为名为state**的片段引入了一个新的特殊属性。我们将此属性设置为值**detach**。如果一个portlet 被分离，它不限于大多数门户页面的流布局控制。相反，它可以放置在页面上的特定区域。请参阅**x 和 y**属性，它们用于在页眉区域中的特定位置定位 portlet。分离的 portlet 也可以拖动和移动。但是，我们不想移动 portlet，所以我们使用了一个**清晰**的装饰器，这意味着 portlet 没有标题栏。由于 JetUI 通过标题栏拖放 portlet，如果我们使用清晰的装饰器，portlet 就无法移动。

![](file:///C:\Users\johnfeng\AppData\Local\Temp\ksohtml11556\wps50.jpg)

### 5.1.3. **映射 URL**

[在** Classic Jetspeed **中，使用Jetspeed Profiler](https://portals.apache.org/jetspeed-2/deployguide/guide-profile.html)映射 URL 。Profiler 使用一组强大的规则来定位页面，基于语言、国家代码或媒体类型等运行时参数。虽然分析器功能强大，但配置起来也很复杂。JetUI 通过不使用分析器来简化 URL 映射。这意味着 URL 直接映射到 Jetspeed 站点中的逻辑文件夹或页面。JetUI 不支持子站点，因为子站点由配置文件规则驱动。

### 5.1.4. **拖放 portlet**

通过单击其标题栏、按住鼠标并将 Portlet 拖动到页面上的另一个位置，可以在页面中移动 Portlet。默认情况下，您只能通过标题栏拖动 portlet。拖放有两种模式：

· 流控制拖放

· Z 顺序拖放

通过流控制拖放，portlet 将始终保持在行和列中。如果您拖动另一个 portlet，该 portlet 将被移开，以便为放置拖动的 portlet 腾出空间。Z-Order 拖放仅在分离 portlet 时可用。无论您将portlet 拖放到哪里，它都会停留在哪里。拖动的 portlet 实际上可以与其他 portlet 重叠。最后拖动的 portlet 获得最高的 z 顺序，这意味着它将保持在所有其他 portlet 的顶部，直到选择（通过单击其标题栏）或移动一个新的 portlet。默认情况下，所有 portlet 都使用流控制。您可以按下 portlet 标题栏上的分离按钮来分离 portlet 并将其置于 z 顺序拖放模式。同样地，

在 jetspeed.properties 中配置了一个 CSS 样式来指示门户的哪个 div 是可拖动的部分。此属性是**jetui.style.drag.handle**，默认为名为**.PTitle的装饰器样式**

### 5.1.5. **停靠工具栏**

JetUI 支持两个工具栏，一个停靠在页面的左侧，一个停靠在页面的右侧。这些工具栏是可选的，但开箱即用，它们被配置为启用。在 JetUI 的演示分发中，我们将工具栏放置在系统范围的[页面模板](https://portals.apache.org/jetspeed-2/deployguide/guide-page-templates.html)**template.tpsml**中，这意味着默认情况下所有页面都会显示工具栏。通过编辑 template.tpsml 文件并删除两个片段定义，您可以轻松地将页面模板配置为没有工具栏或只有一个工具栏。按照惯例，片段定义必须使用特殊的片段 ID。对于左侧工具栏，片段 id 必须是**jstbLeft**。对于右侧工具栏，片段 id 必须是**jstbRight**. 如果在页面上找不到这些片段，则不会显示工具栏。

<fragment id="jstbLeft" type="layout" name="jetspeed-layouts::VelocityOneColumn">

    <property name="row" value="0"></property>

    <property name="column" value="0"></property>

    <property name="state" value="normal"></property>

    <property name='toolbar' value='true'></property>                                

    <property name='class' value='jsLeftToolbar'></property>                                

    <fragment id="jsPageNavigator" type="portlet" name="j2-admin::PageNavigator">

  	        <property name="row" value="0"></property>

            <property name="column" value="0"></property>

            <property name="state" value="normal"></property>

            <property name="tool" value="true"></property>                        

    </片段>

</片段>
请注意，工具栏有一些特殊属性。工具栏是一种布局。它需要一个特殊的属性来表示它是一个工具栏。该属性被恰当地命名为**工具栏**并设置为 true。工具栏片段在页面上具有由**行**和**列**属性指定的位置。它还有一个**state** 属性，可以是**normal**也可以是**closed**. 工具栏顶部有箭头按钮，可让您隐藏或打开工具栏。此状态在片段的 state 属性中为每个用户保留。工具栏打开时为正常状态，关闭时为关闭状态。最后，工具栏有一个 CSS 类，用于格式化布局。布局是包含一个 portlet 的单列，即 Page Navigator，它被标记为工具。使用流控制拖放时，工具不能作为放置目标。在这种情况下，工具栏中只有一个 portlet。当然，工具栏中可以放置多个 portlet。

这是右侧工具栏的定义，其中包含 Jetspeed 工具箱

<fragment id="jstbRight" type="layout" name="jetspeed-layouts::VelocityOneColumn">

    <property name="row" value="0"></property>

    <property name="column" value="2"></property>    

    <property name="state" value="normal"></property>                                

    <property name='toolbar' value='true'></property>

    <property name="state" scope="user" scopeValue="guest" value="close"></property>	  

    <property name='class' value='jsRightToolbar'></property>                                

    <fragment id="jsToolbox" type="portlet" name="j2-admin::JetspeedToolbox">

            <property name="row" value="0"></property>

            <property name="column" value="0"></property>

            <property name="state" value="normal"></property>                        

            <property name="tool" value="true"></property>	                                  

    </片段>
</片段>    

![](file:///C:\Users\johnfeng\AppData\Local\Temp\ksohtml11556\wps51.jpg)![](file:///C:\Users\johnfeng\AppData\Local\Temp\ksohtml11556\wps52.jpg)

### 5.1.6. **分离和关闭 portlet**

JetUI 引入了三个新的 portlet 窗口操作：分离、附加和关闭。实际上分离和附加是切换，一个portlet要么是分离的，要么是附加的，它永远不可能两者兼而有之。仔细查看 portlet 标题栏会显示两个新的操作图标，X 是关闭按钮，它将从页面中删除 portlet。右侧的按钮，箭头钩在左侧，是分离按钮。![](file:///C:\Users\johnfeng\AppData\Local\Temp\ksohtml11556\wps53.jpg)一旦一个 portlet 被分离，分离按钮就变成了一个重新附加按钮，那个带有钩在右边的箭头![](file:///C:\Users\johnfeng\AppData\Local\Temp\ksohtml11556\wps54.jpg) 分离 portlet 会将 portlet 置于 Z-Order 拖放模式，这意味着它总是试图保持在所有其他 portlet 之上。通过按下附加按钮，portlet 被放回到列中最近的槽中，返回到流控制拖放和呈现。分离状态存储在片段上，并且状态可以基于每个用户。在这里，我们看到了在该片段上设置的行、列和 x,y 属性。行和列或仅与以流控制模式呈现的附加 portlet 相关。x,y 属性仅在分离 portlet 时才相关。还要注意这个片段的状态是**detach**。**此外，还有一个名为scope**的属性的新属性。您可以在下面看到 x,y 值是针对用户的，其中**scopeValue**设置为用户名 admin。每个用户都可以根据他们的设置定制他们的 portlet 定位。如您所见，XML 在有很多用户时会变得非常大。因此，建议始终使用 JetUI 将 PSML 存储在数据库中。

<fragment id="dp-22" type="portlet" name="j2-admin::ForgottenPasswordPortlet">

        <property name="row" value="1"></property>

        <property name="column" value="0"></property>

        <property name="x" scope="user" scopeValue="admin" value="536.0"></property>

        <property name="y" scope="user" scopeValue="admin" value="88.0"></property>

        <property name="width" scope="user" scopeValue="admin" value="1121.0"></property>

        <property name="height" scope="user" scopeValue="admin" value="120.0"></property>

        <property name="state" scope="user" scopeValue="admin" value="detach"></property>

        <property name="row" scope="user" scopeValue="admin" value="4"></property>

    </片段>
这是一组全部分离的 portlet 的屏幕截图。如您所见，它就像一个桌面。单击时，所有 portlet 都可以获取焦点，转到页面呈现顺序的顶部。

![](file:///C:\Users\johnfeng\AppData\Local\Temp\ksohtml11556\wps55.jpg)

### 5.1.7. **调整 portlet 的大小**

只有分离的 portlet 可以调整大小。调整大小相当容易。只需抓住 portlet 的右下角，您将在该处看到一个渐变图标，然后将其拖开以使其变大，或向其自身拖动以使 portlet 窗口更小。![](file:///C:\Users\johnfeng\AppData\Local\Temp\ksohtml11556\wps56.jpg)如果附加了 portlet，渐变将不可见。当一个portlet 被调整大小时，两个新属性与片段一起存储，**height** 和**width**。这就是 Jetspeed 存储已调整大小的 portlet 的宽度和高度的方式。注意 height 和 witdth 属性是如何与**用户**范围一起存储的，对于 scopeValue ，用户的名称存储为**dave**. 每个用户都可以根据他们的设置定制他们的 portlet 窗口大小。如您所见，XML 在有很多用户时会变得非常大。因此，建议始终使用 JetUI 将 PSML 存储在数据库中。

<fragment id="dp-22" type="portlet" name="j2-admin::ForgottenPasswordPortlet">

...

        <property name="width" scope="user" scopeValue="dave" value="1121.0"></property>

        <property name="height" scope="user" scopeValue="dave" value="120.0"></property>

        <property name="state" scope="user" scopeValue="dave" value="detach"></property>

    </片段>
### 5.1.8. **Jetspeed 工具箱**

Jetspeed Toolbox 是一个可停靠的 portlet，旨在使用户只需单击一下即可轻松进行自定义。工具箱可以停靠在页面的左侧或右侧，也可以在页面顶部自由浮动。该工具箱包含三个面板，可让您快速访问添加 portlet、更改布局或更改主题：

· Portlet 选择器

· 布局

· 主题

**Portlet 选择器**

Portlet 选择器是第一个选项卡。这个新特性允许您按关键字或类别搜索 portlet，然后一键将 portlet 添加到您的页面，从而使您可以快速访问页面定制。您将看到的第一个功能是工具箱的搜索功能。您可以输入搜索字符串，portlet 选择器将返回与您的搜索条件匹配的 portlet 列表。搜索完全索引的 portlet 元数据，如关键字和标题，搜索 portlet 注册表中所有自动索引的内容。搜索索引为Lucene，也支持Solr企业搜索引擎。

![](file:///C:\Users\johnfeng\AppData\Local\Temp\ksohtml11556\wps57.jpg)

此外，portlet 可以根据类别进行分类和过滤（请参阅下拉列表）。现在可以一键添加 portlet，而无需离开正在定制的页面。Portlet 也通过安全访问进行过滤。只有配置为对当前用户可见的 portlet 才会显示在 Jetspeed Toolbox 中。

类别在 j2-admin portlet.xml 部署描述符中配置，或者使用 Portlet Application Manager 配置，如下所示。记住在添加新类别时，要给它一个新的类别名称，前缀为**Keywords:**，然后在相应的 Value 字段中以逗号分隔的列表中添加与该类别相关的所有关键字。当搜索引擎搜索portlet 内容时，它会将关键字与搜索结果进行匹配。名为**Categories的首选项**也很重要，不要忘记将您的类别名称添加到此逗号分隔列表中，否则您的类别将不会显示。最后，显示在 portlet 选择器中的 portlet 的行数由 Rows 首选项控制。忽略列首选项。还有一个 DefaultCategory 首选项，它是显示在 portlet 选择器中的初始类别。

![](file:///C:\Users\johnfeng\AppData\Local\Temp\ksohtml11556\wps58.jpg)

**主题选择器**

为当前页面选择主题就像选择主题选项卡然后单击主题一样简单。Jetspeed 在 2.2.1 中引入了几个新主题。主题仍然作为页面装饰器实现，在页面装饰器 decorator.properties 中进行了一些扩展。您可以在 Jetspeed webapp 中的 decorators/layout 目录下找到页面装饰器。目前支持 JetUI 的布局有：Green Earth、Jetspeed、Purple Planet 和 Turbo。为了让装饰器出现在主题选择器中，您需要在 decorator.properties 文件中添加两个属性。

图标 = 图像/greenearth.png

兼容性=2.2.1

兼容性设置告诉 JetUI 这个装饰器兼容哪个版本。为了与 JetUI 一起使用，兼容性属性的值必须为 2.2.1 或更高。图标属性在工具箱中用于提供将在主题中使用的颜色的视觉效果。该文件应放置在 decors/layout/{decoratorName}/images 目录中。

![](file:///C:\Users\johnfeng\AppData\Local\Temp\ksohtml11556\wps59.jpg)

**布局选择器**

从“布局”选项卡中选择的页面布局允许最终用户一键自定义页面布局。有四种支持的布局：OneColumn、TwoColumn、ThreeColumn 和 FourColumn。JetUI 中的布局目前仅限于这四种选择。我们希望在新的未来对此有所改进。您看到的图像存储在布局目录中的 Jetspeed webapp 下。

![](file:///C:\Users\johnfeng\AppData\Local\Temp\ksohtml11556\wps60.jpg)

### 5.1.9. **预览 Portlet 模式**

Portlet Selector 支持预览 portlet，以防您在第一次查看之前不想将 portlet 放在页面上。Portlet 支持预览的方式有两种。首先，portlet 可以提供 portlet 的图像，并在 portlet 应用程序的 jetspeed-portlet.xml 部署描述符中告诉 Jetspeed 为给定的 portlet 输入一个**js:metadata**，并将 name 属性设置为**portlet.preview。 image**其中图像路径是预览图像的 Portlet 应用程序相对路径。

<portlet id="WeatherPortlet">

    <portlet-name>WeatherPortlet</portlet-name>

    <js:metadata name="portlet.preview.image">/images/preview/weatherportlet.png</js:metadata>

</portlet>

<portlet id="GoogleMapsPortlet">

    <portlet-name>GoogleMapsPortlet</portlet-name>

    <js:metadata name="portlet.preview.image">/images/preview/googlemapsportlet.png</js:metadata>

</portlet>
Portlet 还可以实现扩展的自定义预览模式。这需要在 portlet 中进行实际编码，以及 portlet 定义中 portlet.xml 中的以下部署元素：

<支持>

  <mime-type>文本/html</mime-type>
...

  <portlet-mode>预览</portlet-mode>
此外，必须为 portlet 应用程序声明自定义 portlet 模式

. ..   

<custom-portlet-mode>

<description>自定义预览模式</description>

<portlet-mode>预览</portlet-mode>
</custom-portlet-mode>

![](file:///C:\Users\johnfeng\AppData\Local\Temp\ksohtml11556\wps61.jpg)

### 5.1.10. **克隆 Portlet**

Portlet 可以从 Jetspeed 工具箱中克隆。克隆 portlet 会在 portlet 注册表中创建 portlet 的实际副本（克隆）。克隆 portlet 时，最终用户会看到一个对话框，用于为克隆的 portlet 输入不同的首选项值。这个新特性旨在促进 portlet 变体的创建，而无需在 portlet.xml 中剪切和粘贴定义。一个典型的用例可能是如下所示的 Weather portlet。对于每个城市，最终用户可以使用 Clone 对话框创建基本 Weather portlet 的克隆变体。变化基于偏好，例如更改标题和城市。请注意，您必须始终更改 portlet 的名称，否则将不允许您创建新的 portlet。Portlet 名称在 Portlet 应用程序中必须是唯一的。请注意，重新部署 portlet 应用程序时，不会删除 portlet 克隆。还可以从 Portlet 应用程序管理器创建和删除克隆

![](file:///C:\Users\johnfeng\AppData\Local\Temp\ksohtml11556\wps62.jpg)

### 5.1.11. **Jetspeed 页面导航器**

Jetspeed Page Navigator 使最终用户能够导航和管理他们自己的空间、页面和文件夹。此外，在管理员手中，可以使用 Jetspeed Navigation 轻松管理整个站点。导航器的视图分为三个部分：

· 顶部显示当前文件夹及其所有内容

· 可选的第二部分，显示当前文件夹中的链接

· 用于添加新页面、文件夹和链接的第三部分

前两个部分实际上只是菜单，可以自定义。在当前文件夹或空间文件夹中查找菜单。元数据。如果没有菜单定义，则菜单导航器将向上搜索文件夹树以找到菜单的更高定义。对于空格，默认菜单使用正则表达式定义：

<menu name="space-navigations" regexp="true" options="+/*/,+/*.psml" depth="-1"/>

<menu name="space-links" regexp="true" options="+/*.link"/>

**上下文菜单**

所有菜单选项都有一个上下文菜单。上下文菜单仅在您将鼠标悬停在菜单选项名称附近时出现，显示为向下箭头。文件夹只有一个上下文菜单：文档排序。

![](file:///C:\Users\johnfeng\AppData\Local\Temp\ksohtml11556\wps63.jpg)

文档排序允许您更改导航器菜单中菜单选项（页面）的顺序。页面项目有四个用于管理页面的上下文菜单选项：

1. 改名
2. 移动
3. 复制
4. 删除

可以使用导航器底部的添加按钮将页面、文件夹和链接添加到当前文件夹或空间。要添加页面，请为其命名，选择模板，然后按添加。

![](file:///C:\Users\johnfeng\AppData\Local\Temp\ksohtml11556\wps64.jpg)

添加文件夹和链接的工作方式与添加页面相同。在模板选项中提供的模板在 j2-admin 应用程序的 portlet.xml 中配置

<portlet 首选项>

  <偏好>

    <name>默认模板页面</name>

    <值>

      /_template/new-user/min.psml

    </值>

  </偏好>

  <偏好>

    <name>模板页面</name>

    <值>

      /_template/new-user/min.psml

      /_template/new-user/default-page.psml

    </值>

  </偏好>

  <!-- 如果以下首选项为空，则使用默认管理员角色和管理员用户。-->

  <偏好>

    <name>空间管理员角色</name>

    <值></值>

  </偏好>

</portlet-首选项>
模板也可以在 Portlet Application Manager 中配置

### 5.1.12. **PSML 的扩展**

PSML 在 2.2.1 版中得到了扩展，以支持许多 JetUI 功能。[PSML 模板](https://portals.apache.org/jetspeed-2/deployguide/guide-page-templates.html)是一项新功能，允许工具栏和空间导航器出现在所有页面中，而无需为每个页面声明 portlet 和布局。相反，片段可以使用页面模板或片段引用自动与任何页面合并。

片段添加了两个新属性以支持片段属性的多用户自定义。这两个属性是**scope**和**scopeValue**。支持的一个范围是**user**，其中 scopeValue 设置为用户名。这允许每个用户片段自定义。请注意，如果许多用户开始自定义片段，您可能希望将页面存储在数据库中而不是文件系统中。Scope 和 scopeValue 可以与任何片段属性组合，包括下面描述的新属性集。

<fragment id="dp-22" type="portlet" name="j2-admin::ForgottenPasswordPortlet">

...

        <property name="width" scope="user" scopeValue="dave" value="1121.0"></property>

        <property name="height" scope="user" scopeValue="dave" value="120.0"></property>

        <property name="state" scope="user" scopeValue="admin" value="detach"></property>

    </片段>
添加了新属性以支持拖放、调整大小、分离和停靠。这里有些例子：

...

        <property name="y" value="300"></property>

        <property name="x" value="20"></property>            

        <property name="state" value="detach"></property>                        
...

    <property name='toolbar' value='true'></property>

    <property name="state" scope="user" scopeValue="guest" value="close"></property>	  

    <property name='class' value='jsRightToolbar'></property>                                

    <fragment id="jsToolbox" type="portlet" name="j2-admin::JetspeedToolbox">

            <property name="row" value="0"></property>

            <property name="column" value="0"></property>

            <property name="state" value="normal"></property>                        

            <property name="tool" value="true"></property>	                                  

    </片段>
...


| **财产** | **价值观**       | **描述**                                                           |
| -------- | ---------------- | ------------------------------------------------------------------ |
| 状态     | 正常，分离，关闭 | 片段的窗口状态，分离或附加（正常）或关闭（对于一个用户或一组用户） |
| 工具栏   | 真假             | 这个片段是工具栏吗                                                 |
| 工具栏   | 真假             | 这个片段是工具栏中的工具吗？                                       |
| X        | 数字屏幕值       | 分离的portlet的 x 位置                                             |
| 是的     | 数字屏幕值       | 分离的portlet的 y 位置                                             |
| 宽度     | 数字屏幕值       | 调整大小、分离的portlet的宽度                                      |
| 高度     | 数字屏幕值       | 调整大小、分离的portlet的高度                                      |
| 班级     | CSS类名          | 应用于给定片段的CSS样式                                            |

### 5.1.13. **Jetspeed 属性配置**

要手动配置 JetUI 属性，请编辑 WEB-INF/conf/jetspeed.properties（或 WEB-INF/conf/override.properties）


| **财产**                   | **价值观**                   | **描述**                                                                                                                         |
| -------------------------- | ---------------------------- | -------------------------------------------------------------------------------------------------------------------------------- |
| jetui.customization.method | 阿贾克斯，服务器             | 要使用JetUI定制引擎，请设置为**ajax**。要打开Jetspeed Classic渲染引擎，请设置为**服务器**                                        |
| jetui.render.engine        | 企业社会责任, SSRE           | 将JetUI渲染引擎设置为 Client Side Rendering Engine 或 Server Side Rendering Engine。                                             |
| jetui.ajax.transport       | json                         | JetUI定制引擎进行的所有[REST API调用的传输。](http://portals.apache.org/jetspeed-2/devguide/guide-rest-api.html)目前仅支持JSON。 |
| jetui.render.template      | /WEB-INF/jetui/yui/jetui.jsp | 开箱即用的JetUI渲染 JSP 模板，用于渲染合并页面                                                                                   |
| jetui.drag.mode            | 满的                         | 仅支持full，即将整个窗口拖到完整大小，拖放到其他 portlet 目标上。未来的支持会拖一个小图标。                                      |
| jetui.style.portlet        | .portal-layout-cell          | JetUI portlet窗口的 CSS 样式，也用于识别和查找所有 portlet                                                                       |
| jetui.style.layout         | .portal-layout-column        | JetUI布局窗口的 CSS 样式，也用于识别和查找所有布局容器                                                                           |
| jetui.style.drag.handle    | .PTtitle                     | JetUI标题栏的 CSS 样式，也用作要从中拖动的 portlet 窗口的句柄                                                                    |
| 管道.default               | jetspeed-管道                | 设置默认管道，但如果您通过使用/jetspeed/ui而不是 /jetspeed/portal 寻址所有 URL 直接命中 JetUI 管道，则没有必要                   |

### 5.1.14. **JetUI 管道配置**

Jetspeed-2 门户引擎的一个关键组件是它的请求管道。对门户的所有请求都通过一组 Spring 可配置管道运行，其中管道流中的每个节点称为 Valve。管道在**WEB-INF/assembly/pipelines.xml**文件中配置。有关更多信息，请参阅[管道指南](https://portals.apache.org/jetspeed-2/devguide/guide-pipeline.html)。JetUI 渲染引擎通过它自己的管道在 pipelines.xml 中进行配置。查找名为**jetui-pipeline**的配置 bean 。

<bean id="jetui-pipeline" class="org.apache.jetspeed.pipeline.JetspeedPipeline" init-method="initialize">

<meta key="j2:cat" value="default" />

<构造函数参数>

  <value>JetuiPipeline</value>

</constructor-arg>

<构造函数参数>

  <列表>

    <ref bean="capabilityValve" />

    <ref bean="portalURLValve" />

    <ref bean="securityValve" />
...

    <ref bean="jetuiValve" />

    <ref bean="cleanUpValve" />

  </列表>

</constructor-arg>
</豆>

您可能希望完全关闭经典管道。开箱即用，事实并非如此。要让 /jetspeed/portal 进入 JetUI 管道，请将 pipelines.xml 管道映射 bean 更改为：

<bean id='pipeline-map' 类='java.util.LinkedHashMap'>

<meta key="j2:cat" value="default" />

<构造函数参数>

  <地图>
...

    <入口键='/门户'>

      <value>jetui-管道</value>

    </entry>
# 6. **安全组件**

## 6.1. [**安全配置**](https://portals.apache.org/jetspeed-2/deployguide/security-config.html)

本指南的这一部分为部署人员提供了几个 Jetspeed Security 的快速部署配置选项。

### 6.1.1. **授权：权限与约束**

Jetspeed 支持两种不同的授权策略：

1. 权限 - 使用标准的 Java 安全策略。Jetspeed 将此策略存储在关系数据库中
2. 约束 - Jetspeed 特定的基于约束的安全性

默认情况下，Jetspeed 使用 Spring 配置文件中安全访问控制器 bean 的服务配置中所示的约束**administration.xml**。约束通常在 Jetspeed 站点中的资源本身上定义，例如在页面或文件夹上。请参阅[约束指南](https://portals.apache.org/jetspeed-2/deployguide/guide-security-declarative-psml.html)以及有关基于约束的安全性的更多信息。

Java 安全策略更高级一些。有关在关系数据库中配置 Jetspeed 的 JAAS 安全策略的更多信息，请参阅[JAAS 安全策略指南](https://portals.apache.org/jetspeed-2/devguide/atz-jaas.html)

<bean id="org.apache.jetspeed.security.SecurityAccessController"

  类='org.apache.jetspeed.security.impl.SecurityAccessControllerImpl'>

	<构造函数参数索引='0'>

		<ref bean="org.apache.jetspeed.page.PageManager"/>

	</constructor-arg>

	<!--

	   安全模式：

	      1 = 权限 = 使用 Jetspeed Java 安全策略

	      2 = 约束 = 使用 Jetspeed (PageManager) 基于约束的安全性  

	 -->

	 <constructor-arg index="1">

        <值>2</值>

    </constructor-arg>
</豆>

### 6.1.2. **登录和授权选项**

Jetspeed 提供了一些通用的登录和授权选项来帮助您自定义门户的行为。下面显示的 Portal Authentication Configuration bean 的服务配置，来自 Spring 配置文件**administration.xml**，用于自定义门户的两个关键行为。

1. 登录时创建新会话 - 默认情况下，当用户使用 Jetspeed 登录 portlet 之一进行身份验证（登录）时，不会创建新会话。来宾用户的会话被传递给经过身份验证的用户。如果要更改此行为以创建新会话，请将此值设置为 true。此设置为假的原因是模拟一个在线商店，您在其中购买东西然后最后登录。
2. 硬会话超时 - 对于需要以秒为单位设置硬会话超时限制的配置，无论（在）活动如何。设置为 0 会关闭此功能。注意：此功能应与“身份验证时创建新会话”功能一起使用

<bean id='org.apache.jetspeed.administration.PortalAuthenticationConfiguration'

类='org.apache.jetspeed.administration.PortalAuthenticationConfigurationImpl'>
<!-- 认证时创建新会话-->

<构造函数参数索引='0'>

	<值>假</值>
</constructor-arg>

<!-- 以秒为单位的硬会话超时限制，无论（不）活动如何，设置为 0 将关闭此功能

   		 注意：此功能应与“身份验证时创建新会话”功能一起使用

   -->

<构造函数参数索引='1'>

	<值>0</值>
</constructor-arg>

<!-- 硬会话过期的重定向位置 -->

<构造函数参数索引='2'>

	<value>/登录/注销</value>
</constructor-arg>

</豆>    

### 6.1.3. **Jetspeed 安全弹簧配置**

配置 Jetspeed 安全性时涉及的文件位于 *\${jetspeed-source-home}/portal/src/webapp/WEB-INF/assembly/*下。本节向您介绍这些部署描述符文件。在正常使用中，您不需要修改这些文件。本文档用于 Jetpeed 安全性的高级使用，例如用您自己的替换默认的安全性实现。

#### 6.1.3.1. **安全-atn.xml**

该配置文件提供登录模块配置。不是每个人都需要这个，因为某些应用程序可能决定使用提供的登录模块以外的另一个登录模块。

#### 6.1.3.2. **安全-atz.xml**

这个配置文件配置了授权策略，在 J2 的例子中是 [RdbmsPolicy](https://portals.apache.org/jetspeed-2/devguide/atz-jaas.html) 。

#### 6.1.3.3. **安全管理器.xml**

出于安全目的，此配置文件配置所有管理器。

#### 6.1.3.4. **安全提供者.xml**

此配置文件配置各种提供程序并将 SPI 编织在一起。

· **AuthenticationProviderProxy** ：配置列表 **AuthenticationProvider** 和默认验证器。

<bean id="org.apache.jetspeed.security.AuthenticationProviderProxy"

class="org.apache.jetspeed.security.impl.AuthenticationProviderProxyImpl">  

<构造函数参数>

  <列表>

     <ref bean="org.apache.jetspeed.security.AuthenticationProvider"/>

  </列表>
</constructor-arg>

<constructor-arg><value>DefaultAuthenticator</value></constructor-arg>

</豆>

·

· **AuthenticationProvider** ：为当前门户实现配置身份验证提供程序。下面的示例配置使用 RDBMS 管理/存储用户信息的默认身份验证器。

<bean id="org.apache.jetspeed.security.AuthenticationProvider"

   class="org.apache.jetspeed.security.impl.AuthenticationProviderImpl">  	   
<constructor-arg index="0"><value>DefaultAuthenticator</value></constructor-arg>

<constructor-arg index="1"><value>默认验证器</value></constructor-arg>

<constructor-arg index="2"><value>login.conf</value></constructor-arg>

<constructor-arg index="3">

  <ref bean="org.apache.jetspeed.security.spi.CredentialHandler"/>
</constructor-arg>

<constructor-arg index="4">

  <ref bean="org.apache.jetspeed.security.spi.UserSecurityHandler"/>
</constructor-arg>

</豆>

·

· **AuthorizationProvider** ：配置策略并实例化 **SecurityPolicies** 用于强制执行权限的策略。默认情况下，Jetspeed 2 不加载任何其他可能已配置的安全策略。为了使用默认策略，设置 **useDefaultPolicy**为**true**

<bean id="org.apache.jetspeed.security.AuthorizationProvider"

  class="org.apache.jetspeed.security.impl.AuthorizationProviderImpl">  	   

<constructor-arg index="0">

    <ref bean="org.apache.jetspeed.security.impl.RdbmsPolicy"/>

</constructor-arg>

<!-- 不使用默认策略作为默认行为 -->

<constructor-arg index="1"><value>false</value></constructor-arg>   
</豆>

·

#### 6.1.3.5. **安全-spi.xml**

此配置文件包含身份验证和授权 SPI 通用的配置。


| **豆**                                          | **描述**                                                                                                                                         |
| ----------------------------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------ |
| org.apache.jetspeed.security.spi.SecurityAccess | 由默认的基于OJB的 SPI 在内部使用。提供对各种 SPI 实现的通用操作/方法的访问。 Authentication 和 Authorization SPI 都使用 SecurityAccess*bean。* |

#### 6.1.3.6. **安全-spi-atn.xml**

此配置文件包含配置身份验证 SPI 的所有配置。


| **豆**                                               | **描述**                                                                                                                                                                                                                                                                                                  |
| ---------------------------------------------------- | --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| org.apache.jetspeed.security.spi.CredentialHandler   | *CredentialHandler* 封装了涉及凭据操作的操作 。 *默认实现为PasswordCredentialProvider定义的密码*保护提供支持 ；以及通过 *InternalPasswordCredentialInterceptor对凭证进行生命周期管理* 它可以配置为管理参数，例如最大身份验证失败次数、凭证的最长生命周期（以天为单位）以及为给定凭证保留多少历史记录。 |
| org.apache.jetspeed.security.spi.UserSecurityHandler | *UserSecurityHandler* 封装了围绕用户主体的所有操作 。                                                                                                                                                                                                                                                    |

**CredentialHandler**Jetspeed 目前默认提供 以下简单配置：

<!-- 需要一个非空密码 -->

<bean id="org.apache.jetspeed.security.spi.CredentialPasswordValidator"

 class="org.apache.jetspeed.security.spi.impl.DefaultCredentialPasswordValidator"/>
<!-- MessageDigest 使用 SHA-1 编码密码 -->

<bean id="org.apache.jetspeed.security.spi.CredentialPasswordEncoder"

 class="org.apache.jetspeed.security.spi.impl.MessageDigestCredentialPasswordEncoder">

 <constructor-arg index="0"><value>SHA-1</value></constructor-arg>       
</豆>       

<!-- 允许多个 InternalPasswordCredentialInterceptor 用于 DefaultCredentialHandler -->

<bean id="org.apache.jetspeed.security.spi.InternalPasswordCredentialInterceptor"

 class="org.apache.jetspeed.security.spi.impl.InternalPasswordCredentialInterceptorsProxy">

 <constructor-arg index="0">

   <列表>

     <!-- 强制要求更改持久存储中的无效预设密码值 -->

     <bean class="org.apache.jetspeed.security.spi.impl.ValidatePasswordOnLoadInterceptor"/>

     <!-- 确保持久存储中的预设明文密码将在首次使用时进行编码-->

     <bean class="org.apache.jetspeed.security.spi.impl.EncodePasswordOnFirstLoadInterceptor"/>

   </列表>

 </constructor-arg>
</豆>

<bean id="org.apache.jetspeed.security.spi.PasswordCredentialProvider"

 class="org.apache.jetspeed.security.spi.impl.DefaultPasswordCredentialProvider">

 <constructor-arg index="0">

   <ref bean="org.apache.jetspeed.security.spi.CredentialPasswordValidator"/>

 </constructor-arg>       

 <constructor-arg index="1">

   <ref bean="org.apache.jetspeed.security.spi.CredentialPasswordEncoder"/>

 </constructor-arg>       
</豆>       

<bean id="org.apache.jetspeed.security.spi.CredentialHandler"

 class="org.apache.jetspeed.security.spi.impl.DefaultCredentialHandler">       

 <constructor-arg index="0">

   <ref bean="org.apache.jetspeed.security.spi.SecurityAccess"/>

 </constructor-arg>       

 <constructor-arg index="1">

   <ref bean="org.apache.jetspeed.security.spi.PasswordCredentialProvider"/>

 </constructor-arg>       

 <constructor-arg index="2">

   <ref bean="org.apache.jetspeed.security.spi.InternalPasswordCredentialInterceptor"/>

 </constructor-arg>
</豆>

上面的配置要求密码不能为空，MessageDigest 使用 SHA-1 对其进行编码。

并且，确保在 pipelines.xml 中为安全相关的阀门设置了类似以下的配置：

<bean id="passwordCredentialValve"

  class="org.apache.jetspeed.security.impl.PasswordCredentialValveImpl"

  初始化方法="初始化">
<构造函数参数>

<!-- expirationWarningDays -->

<列表>

 <值>2</值>

 <值>3</值>

 <值>7</值>
</列表>

</constructor-arg>

</豆>

<bean id="loginValidationValve"

  class="org.apache.jetspeed.security.impl.LoginValidationValveImpl"

  初始化方法="初始化">
<!-- maxNumberOfAuthenticationFailures

       此值应与值同步

       org.apache.jetspeed.security.spi.impl.MaxPasswordAuthenticationFailuresInterceptor

       （如果使用）有意义。

       任何值 < 2 将抑制 LoginConststants.ERROR_FINAL_LOGIN_ATTEMPT

       在凭证之前只能进行最后一次尝试时的错误代码

       将在下一次身份验证失败后禁用。

  -->

<constructor-arg index="0"><value>3</value></constructor-arg>  

</豆>

另外，确保在**jetspeed-pipeline**bean 中配置了上述阀门。

有关这些阀门的描述及其与拦截器配置的关系， 请参阅[凭证管理文档。](https://portals.apache.org/jetspeed-2/deployguide/credentials.html)

#### 6.1.3.7. **安全-spi-atz.xml**

该配置文件包含配置授权 SPI 的所有配置。


| **豆**                                                  | **描述**                                                                                                                                                                                                                                                                                                     |
| ------------------------------------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ |
| org.apache.jetspeed.security.spi.RoleSecurityHandler    | *RoleSecurityHandler* 封装了围绕角色主体的所有操作 。                                                                                                                                                                                                                                                       |
| org.apache.jetspeed.security.spi.GroupSecurityHandler   | *GroupSecurityHandler* 封装了围绕组主体的所有操作 。                                                                                                                                                                                                                                                        |
| org.apache.jetspeed.security.spi.SecurityMappingHandler | *SecurityMappingHandler* 封装了所有涉及主体之间映射的操作 。 它包含管理分层主体（角色或组）的层次结构解析的逻辑。提供的默认层次结构解析是按泛化的层次结构（请参阅定义概述）。可以将 *contructor-arg* 添加到 *SecurityMappingHandler* 以更改层次结构解析策略。Jetspeed 2 还支持通过聚合进行层次结构解析。 |

示例 **SecurityMappingHandler** 配置可能是：

<!-- 安全 SPI: SecurityMappingHandler -->

<bean id="org.apache.jetspeed.security.spi.SecurityMappingHandler"

  class="org.apache.jetspeed.security.spi.impl.DefaultSecurityMappingHandler">  	   
<构造函数参数>

  <ref bean="org.apache.jetspeed.security.spi.SecurityAccess"/>
</constructor-arg>

<!-- 默认角色层级策略是泛化。  

        添加constructor-arg来改变策略。-->

<!-- 默认组层次结构策略是泛化。  

        添加constructor-arg来改变策略。-->

</豆>

## 6.2. [**证书**](https://portals.apache.org/jetspeed-2/deployguide/credentials.html)

尽管**DefaultCredentialHandler**提供了对凭据的细粒度管理，但它无法向用户提供直接反馈，例如显示当前密码即将过期的警告。但是，配备 jetspeed 的特殊要求处理管道阀可以做到这一点。

这些阀门的配置可以在**pipelines.xml**弹簧配置文件中找到并设置。

### 6.2.1. **LoginValidationValveImpl**

[LoginValidationValveImpl](https://portals.apache.org/jetspeed-2/apidocs/org/apache/jetspeed/security/impl/LoginValidationValveImpl.html)向用户提供有关登录尝试失败的原因的反馈 。

它检索指定用户名的**UserPrincipal**及其当前**PasswordCredential**，并（如果找到）根据其状态确定特定的错误代码。此错误代码通过会话传回，因此可以向用户呈现适当的错误消息。

可以返回以下可能的错误代码（均在 [LoginConstants](https://portals.apache.org/jetspeed-2/apidocs/org/apache/jetspeed/login/LoginConstants.html)接口中定义）：

1. ERROR\_UNKNOWN\_USER
2. ERROR\_INVALID\_PASSWORD
3. ERROR\_USER\_DISABLED
4. ERROR\_FINAL\_LOGIN\_ATTEMPT
5. ERROR\_CREDENTIAL\_DISABLED
6. ERROR\_CREDENTIAL\_EXPIRED

在上述错误代码中，只有在阀门配置为与上述相关的相同值**ERROR\_FINAL\_LOGIN\_ATTEMPT**时才会报告：**maxNumberOfAuthenticationFailuresMaxPasswordAuthenticationFailuresInterceptor**

<bean id="loginValidationValve"

    class="org.apache.jetspeed.security.impl.LoginValidationValveImpl"

    初始化方法="初始化">

<!-- maxNumberOfAuthenticationFailures

     此值应与值同步

     org.apache.jetspeed.security.spi.impl.MaxPasswordAuthenticationFailuresInterceptor

     （如果使用）有意义。

     任何值 < 2 将抑制 LoginConststants.ERROR_FINAL_LOGIN_ATTEMPT

     在凭证之前只能进行最后一次尝试时的错误代码

     将在下一次身份验证失败后禁用。

-->

<constructor-arg index="0"><value>3</value></constructor-arg>

<constructor-arg index="1">

  <列表>

    <value>org.apache.jetspeed.powertool.actions</value>

  </列表>

</constructor-arg>
</豆>

除了启用登录验证阀外，请确保将 MaxPasswordAuthenticationFailuresInterceptor 添加到凭据策略管理器并确保登录尝试值同步。开箱即用，未配置 MaxPasswordAuthenticationFailuresInterceptor。

<bean id="org.apache.jetspeed.security.spi.impl.UserPasswordCredentialPolicyManagerImpl"

class="org.apache.jetspeed.security.spi.impl.UserPasswordCredentialPolicyManagerImpl">

<meta key="j2:cat" value="默认或安全" />

<constructor-arg index="0" ref="org.apache.jetspeed.security.CredentialPasswordEncoder" />

<constructor-arg index="1" ref="org.apache.jetspeed.security.CredentialPasswordValidator" />

<constructor-arg index="2">

  <列表>

    <!-- 强制要求更改持久存储中的无效预设密码值 -->

    <bean class="org.apache.jetspeed.security.spi.impl.ValidatePasswordOnLoadInterceptor" />

    <!-- 确保持久存储中的预设明文密码将在首次使用时进行编码-->

    <bean class="org.apache.jetspeed.security.spi.impl.EncodePasswordOnFirstLoadInterceptor" />

    <bean class="org.apache.jetspeed.security.spi.impl.MaxPasswordAuthenticationFailuresInterceptor">

         <constructor-arg index="0"><value>3</value></constructor-arg>

    </豆>

    <!-- 密码过期拦截器。启用密码过期时需要。本例设置为 30 天 -->

    <bean class="org.apache.jetspeed.security.spi.impl.PasswordExpirationInterceptor">

                <constructor-arg index="0"><value>30</value></constructor-arg>

            </豆>

  </列表>

</constructor-arg>
</豆>

### 6.2.2. **PasswordCredentialValveImpl**

它[PasswordCredentialValveImpl](https://portals.apache.org/jetspeed-2/apidocs/org/apache/jetspeed/security/impl/PasswordCredentialValveImpl.html)旨在与特殊门户页面 (PSML) 上的特殊 Portlet 一起使用，以自动请求甚至要求用户更改其密码。

该阀门评估**PasswordCredential.isUpdateRequired()**和可选的 **expirationDate**,**lastAuthenticationDate**和**previousAuthenticationDate** 字段以确定是否需要用户或仅要求用户更改其密码。

这个阀门可以选择 **expirationWarningDays**在其构造函数中配置一个数字列表：

<bean id="passwordCredentialValve"

  class="org.apache.jetspeed.security.impl.PasswordCredentialValveImpl"

  初始化方法="初始化">
<构造函数参数>

<!-- expirationWarningDays -->

<列表>

 <值>2</值>

 <值>3</值>

 <值>7</值>
</列表>

</constructor-arg>

</豆>

这些数字中的每一个都代表当前密码凭证的前一天，**expirationDate**当用户应该被警告其密码即将到期并被要求更改它时。和 **lastAuthenticationDate**用于**previousAuthenticationDate**确定何时应该发生这种情况。对于每个配置的**expirationWarningDay**. 如果用户使用上述示例配置首次登录（几天后），在密码过期前 6 天，他或她将收到警告。再过 3 或 2 天。

当用户在密码过期前的最后一天或何时登录**updateRequired** 时**true**，无论是否配置了 expireWarningDays，都将要求用户更改密码。

为了能够自动向用户提供此信息并允许或要求在登录后直接更改密码，使用了特殊**ProfileLocator**[SECURITY\_LOCATOR](#SECURITY_LOCATOR)功能。然后**PageProfilerValve**（应该 在管道中的这个阀门之后配置）将使用这个强制定位器来查找相关的门户页面以呈现给用户。

为此，**"security"**必须像 Jetspeed 提供的默认规则一样设置 Profiler 规则：

![](file:///C:\Users\johnfeng\AppData\Local\Temp\ksohtml11556\wps65.png)

从上图中可以看出，将呈现给用户的默认页面 **/my-account.psml**位于根目录中。

此默认页面仅包含一个 portlet，即**ChangePasswordPortlet**来自安全 Portlet 应用程序的 portlet。

与as 它**ChangePasswordPortlet**一起**PasswordCredentialValveImpl** 检查 [PASSWORD\_CREDENTIAL\_DAYS\_VALID\_REQUEST\_ATTR\_KEY](#PASSWORD_CREDENTIAL_DAYS_VALID_REQUEST_ATTR_KEY)请求参数，该参数将由该阀门设置，密码仍然有效的天数。对于所需的密码更改，这将设置为 Integer(0)。

默认**my-account.psml**页面仅包含**ChangePasswordPortlet** 以确保需要更改密码的用户在更改密码后不能以任何其他方式与门户网站交互。

尽管用户可能会尝试选择指向不同页面的链接（例如，从门户菜单中），但如果需要，此阀门将确保仅返回配置的“安全”定位器页面。但是，一旦更改密码，URL 中的目标页面将自动导航到。

## 6.3. [**LDAP**](https://portals.apache.org/jetspeed-2/deployguide/ldap.html)

· [](http://directory.apache.org/)

· 阿帕奇** DS**

· [打开** LDAP**](http://www.openldap.org/)

· [骨牌](http://www-306.ibm.com/software/lotus/)

· [孙德](http://www.sun.com/software/products/directory_srvr_ee/dir_srvr/index.xml)

本入门部分仅涵盖 Apache DS 入门

### 6.3.1. **阿帕奇 DS 1.0.2**

开始使用 Apache DS 的第一步是下载并安装它。一旦启动并运行，您需要将 Jetspeed LDAP 模式添加到 Apache DS 服务器配置。对于 ApacheDS 1.0.2 版本，此处记录了添加自定义模式的一般说明。但是，从 2.2.0 开始，Jetspeed 预构建仅适用于 0.9.3 版本。从 Jetspeed 2.2.0 开始，我们建议使用此处描述的 1.0.2 版指南而不是 Jetspeed 版本，因为我们已弃用 Jetspeed 2.2 版的所有 0.9.3 支持。

[http://directory.apache.org/apacheds/1.0/custom-schema.html](http://directory.apache.org/apacheds/1.0/custom-schema.html)

Apache DS 1.0 不支持通过 LDAP 协议进行动态模式更新。将来会添加此功能，但您仍然可以更改 Apache DS 使用的模式。它只需要重新启动。*要在 Apache DS 中包含其他模式，只需将模式定义添加到 Apache DS 发行版中/conf*目录下的 Apache DS server.xml 配置文件。找到名为“bootstrapSchemas”的属性配置。由于我们对添加 Jetspeed 模式特别感兴趣，因此我们想添加一个适合 Jetspeed 的 bean 定义。这看起来像：

<property name="bootstrapSchemas">

  <set> 

    <bean class="org.apache.directory.server.core.schema.bootstrap.AutofsSchema"/> 

    <bean class="org.apache.directory.server.core.schema .bootstrap.CorbaSchema"/> 

... 

<bean class="org.apache.jetspeed.security.ldap.JetspeedSchema"/>		 

  </set> 
</property>

对于 Apache LDAP 0.9.3 版本（我从未尝试过），使用相同的：

<bean class="org.apache.jetspeed.security.ldap.JetspeedSchema"/>
我们只是在 bean 定义列表的末尾添加了 Jetspeed 模式定义。bean 引用了一个名为*org.apache.jetspeed.security.ldap.JetspeedSchema*的类。此类包含在 Jetspeed 为您提供的 JAR 文件中，见下文。

接下来，我们需要为 jetspeed 模式创建一个名为**SevenSeas**的新域。以下步骤将在 Apache DS 中创建 SevenSeas 域。

要添加后缀为**"o=sevenSeas"**和 ID 为**"sevenSeasPartitionConfiguration"**的分区，请在 Apache DS 中编辑 conf/server.xml 文件。在您喜欢的编辑器中打开它，然后查找名为 contextPartitionConfigurations 的以下元素。为 SevenSeas 分区添加第二个 ref 元素：

<property name="contextPartitionConfigurations">

<set>

<ref bean="examplePartitionConfiguration"/> 

<ref bean="sevenSeasPartitionConfiguration"/> 
</set>

</property>

接下来，通过将此代码粘贴到 examplePartitionConfiguration 之后为七大洋创建实际分区（您也可以删除示例分区并根据需要引用）：

<bean id="sevenSeasPartitionConfiguration" class="org.apache.directory.server.core.partition.impl.btree.MutableBTreePartitionConfiguration">     

<!-- 优化器是默认开启的，但可能并不总是这样 --> 

<! -- 如果你的查询真的很简单，你想要 --> 

<!--<property name="optimizerEnabled" value="true" />--> 



<property name="name" value="七大洋" /> 

<property name="cacheSize" value="100" /> 

<property name="suffix" value="o=sevenSeas" /> 

<property name="optimizerEnabled" value="true" /> 

<property name="synchOnWrite" value="true" /> 


<!--

  写入同步不等待同步操作

  刷新脏页。写入会立即持续到磁盘，

  但会降低性能并提高数据完整性。否则

  ，周期性同步操作将使用

  主配置中的 synchPeriodMillis 参数刷新脏页。

--> 



<property name="indexedAttributes"> 

  <set> 

    <bean class="org.apache.directory.server.core.partition.impl.btree.MutableIndexConfiguration"> 

      <property name="attributeId" value="dc" /> 

      <property name="cacheSize" value="100" /> 

    </bean> 

    <bean class="org.apache.directory.server.core.partition.impl.

      <property name="attributeId" value="ou" /> 

      <property name="cacheSize" value="100" /> 

    </bean> 

    <bean class="org.apache.directory.server.core.partition.impl .btree.MutableIndexConfiguration"> 

      <property name="attributeId" value="krb5PrincipalName" /> 

      <property name="cacheSize" value="100" /> 

    </bean> 

    <bean class="org.apache.directory.server .core.partition.impl.btree.MutableIndexConfiguration"> 

      <property name="attributeId" value="uid" /> 

      <property name="cacheSize" value="100" /> 

    </bean> 

    <bean class="org.apache.directory.server.core.partition.impl.btree.MutableIndexConfiguration">

      <property name="attributeId" value="objectClass" /> 

      <property name="cacheSize" value="100" /> 

    </bean> 

  </set> 

</property> 

<property name="contextEntry"> 

  <value > 

    objectClass: top 

    objectClass: domain 

    objectClass: extensibleObject 

	o: SevenSeas 

  </value> 

</property> 
</bean>

</bean>

请注意，如果您需要自定义分区，则可能需要更改的重要区域是分区的名称：

<bean id="sevenSeasPartitionConfiguration"

后缀：

<property name="suffix" value="o=sevenSeas" />

现在剩下的最后一个属性是上下文条目。对象类 top 和 extensibleObject 是通用的，因此它们仍然存在。但是对象类域被对象类组织所取代，因为我们的分区不应该代表一个域而是一个组织：

<property name="contextEntry">

+ <value>
+ objectClass: top
+ objectClass: organization
+ objectClass: extensibleObject
+ o: SevenSeas
+ </value>

+</property>

保存 server.xml 后，您需要下载 jar 文件并将其放入Apache DS 发行版的*/lib目录中。*JAR 包含 LDAP 的 Jetspeed 模式的 Java 实现。对于 ApacheDS 版本 1.0.2，请从此处下载 Jetspeed LDAP 模式 JAR 文件：

[Apache DS 1.0.2 - Jetspeed 模式文件](http://people.apache.org/~taylor/LDAP/jetspeed-security-schema-2.1.3.jar)

对于 ApacheDS 0.9.3 版，请从此处下载 Jetspeed LDAP 模式 JAR 文件：

[Apache DS 0.9.3 - Jetspeed 模式文件](http://people.apache.org/~taylor/LDAP/jetspeed-security-schema-2.1.3-0.9.3.jar)

放入jar文件后，重新启动服务器。Apache DS 现在应该可以支持 Jetspeed 模式了。当服务器启动时，确保控制台上没有打印出与此配置相关的错误消息

### 6.3.2. **Jetspeed 配置**

那么，既然 ApacheDS 具有所需的模式，那么您如何将 Jetspeed 与 ApacheDS 联系起来呢？有两个步骤。

首先，您需要修改 Jetspeed 中 LDAP 安全性的 Spring 配置文件。

其次，您需要在 LDAP 目录中设置一个有效的管理员帐户，以便您能够登录到 Jetspeed。

在我们开始之前，Jetspeed 中的 LDAP 代码直到最近才被破坏，因此如果不手动更改 Java 代码就无法使用（根据我们的测试，至少使用 Apache DS）。因此，您应该确保您使用的是 Jetspeed 2.1.3 或更高版本。

第一步，您需要下载三个 Spring 配置文件。Jetspeed 部署到 Tomcat 时，应该放在*WEB-INF/assembly/override/*目录下。从这里下载：

[http://people.apache.org/\~taylor/LDAP/security-spi-ldap.xml](http://people.apache.org/~taylor/LDAP/security-spi-ldap.xml)

[http://people.apache.org/\~taylor/LDAP/security-spi-ldap-atn.xml](http://people.apache.org/~taylor/LDAP/security-spi-ldap-atn.xml)

[http://people.apache.org/\~taylor/LDAP/security-spi-ldap-atz.xml](http://people.apache.org/~taylor/LDAP/security-spi-ldap-atz.xml)

需要修改*security-spi-ldap.xml*文件。其他两个不需要修改。

最后一步是从*WEB-INF/assembly*目录中删除两个文件：


| mv security-spi-atn.xml备用/ |
| ---------------------------- |
| mv security-spi-atz.xml备用/ |

### 6.3.3. **配置 security-spi-ldap.xml**

Jetspeed 中用于LDAP的*security-spi-ldap.xml*配置文件实际上是一个配置Jetspeed LDAP 实现的XML 文件。总共有 36 个参数（真的！）。虽然并非所有这些参数都可能真正被您使用，但必须全部指定，否则 Jetspeed 将无法初始化。这是您需要修改以指向 LDAP 服务器的基本程序集：

<beans>

<!-- ************** Ldap 配置 ********** -->

<bean id="org.apache.jetspeed .security.spi.impl.ldap.LdapBindingConfig"

  class="org.apache.jetspeed.security.spi.impl.ldap.LdapBindingConfig"> 

  <!-- LDAP 初始上下文工厂。--> 

  <constructor-arg index="0"><value>com.sun.jndi.ldap.LdapCtxFactory</value></constructor-arg> 

  <!-- LDAP 服务器名称。--> 

  <constructor-arg index="1"><value>localhost</value></constructor-arg> 

  <!-- LDAP 服务器端口。--> 

  <constructor-arg index="2"><value>10389</value></constructor-arg> 

  <!-- LDAP 服务器根上下文。-->

  <constructor-arg index="3"><value>o=sevenSeas</value></constructor-arg> 

  <!-- LDAP 服务器根 dn。--> 

  <constructor-arg index="4"><value>uid=admin,ou=system</value></constructor-arg> 

  <!-- LDAP 服务器根密码。--> 

  <constructor-arg index="5"><value>secret</value></constructor-arg> 

  <!-- 角色过滤器。--> 

  <constructor-arg index="6"><value>(objectclass=jetspeed-2-role)</value></constructor-arg> 

  <!-- 组过滤器。--> 

  <constructor-arg index="7"><value>(objectclass=jetspeed-2-group)</value>< 

  /constructor-arg> <!-- 用户过滤器。--> 

  <constructor-arg index="8"><value>(objectclass=jetspeed-2-user)</value></constructor-arg>

  <!-- 角色成员属性。--> 

  <constructor-arg index="9"><value>j2-role</value></constructor-arg> 

  <!-- userRoleMembershipAttributes。--> 

  <constructor-arg index="10"><value>j2-role</value></constructor-arg> 

  <!-- groupMembershipAttributes。--> 

  <constructor-arg index="11"><value>uniqueMember</value></constructor-arg> 

  <!-- userGroupMembershipAttributes。--> 

  <constructor-arg index="12"><value>j2-group</value></constructor-arg> 

  <!-- groupMembershipForRoleAttributes。--> 

  <构造函数参数索引=“

  <constructor-arg index="14"><value></value></constructor-arg>      

  <!-- 默认搜索库。--> 

  <constructor-arg index="15"><value>o=sevenSeas</value></constructor-arg> 

  <!-- roleFilterBase。--> 

  <constructor-arg index="16"><value>ou=Roles,ou=rootOrg</value></constructor-arg> 

  <!-- groupFilterBase。--> 

  <constructor-arg index="17"><value>ou=Groups,ou=rootOrg</value></constructor-arg> 

  <!-- userFilterBase。--> 

  <constructor-arg index="18"><value>ou=People,ou=rootOrg</value></constructor-arg> 

  <!-- 角色对象类。--> 

  <constructor-arg index="19"><value>top,groupOfUniqueNames,jetspeed-2-role</value></constructor-arg>

  <!-- groupObjectClasses。--> 

  <constructor-arg index="20"><value>top,groupOfUniqueNames,jetspeed-2-group</value></constructor-arg> 

  <!-- userObjectClasses。--> 

  <constructor-arg index="21"><value>top,person,organizationalPerson,inetorgperson,jetspeed-2-user</value></constructor-arg> 

  <!-- roleIdAttribute。--> 

  <constructor-arg index="22"><value>cn</value></constructor-arg> 

  <!-- groupIdAttribute。--> 

  <constructor-arg index="23"><value>cn</value></constructor-arg> 

  	<!-- userIdAttribute。--> 

  < 

  constructor-arg index="24"><value>cn</value></constructor-arg> <!-- UidAttribute。-->

  <constructor-arg index="25"><value>uid</value></constructor-arg> 

  <!-- MemberShipSearchScope。--> 

  <constructor-arg index="26"><value>1</value></constructor-arg> 

  <!-- roleUidAttribute。--> 

  <constructor-arg index="27"><value>cn</value></constructor-arg> 

  <!-- groupUidAttribute。--> 

  <constructor-arg index="28"><value>cn</value></constructor-arg> 

  <!-- userUidAttribute。--> 

  <constructor-arg index="29"><value>uid</value></constructor-arg> 

  <!-- roleObjectRequiredAttributeClasses。-->

  <!-- groupObjectRequiredAttributeClasses。--> 

  <constructor-arg index="31"><value>cn,j2-classname,uid,uniqueMember</value></constructor-arg> 

  <!-- 用户属性。--> 

  <constructor-arg index="32"><value>sn={u},cn={u},uid={u}</value></constructor-arg> 

  <!-- 角色属性。--> 

  <constructor-arg index="33"><value></value></constructor-arg> 

  <!-- groupAttributes。--> 

  <constructor-arg index="34"><value></value></constructor-arg> 

  <!-- userPasswordAttribute。--> 

  <constructor-arg index="35"><value> 

  userPassword</value></constructor-arg> <!-- knownAttributes。-->

  <constructor-arg index="36"><value>cn,sn,o,uid,ou,objectClass,userPassword,member,uniqueMember,memberOf,j2-role,j2-group</value></constructor-arg> 
</bean>

</beans>

让我们介绍最常用的修改。在此页面上的文档中，我们更详细地介绍了每个参数。您可能需要在以下位置进行更改，以使其适用于您的设置。我根据它在 XML 文件中使用的构造函数参数列出了它们。标有**(!)**的可能更改将需要对 LDIF 文件进行相应更改（稍后解释），因此除非您了解您在这两个文件中所做的事情，否则不要更改它们。


| 1. LDAP服务器的主机名。在我们的例子中，它是“localhost”。如果您的 LDAP 服务器位于运行 Jetspeed 的同一台计算机上，您可能希望将其设置为“localhost”。                                                                                                                                                       |
| ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| 2.我们的 LDAP 服务器在 10389 端口上运行。大多数 LDAP 服务器的默认端口是 389。                                                                                                                                                                                                                               |
| 3.（！）我们将组织名称设置为“o=sevenSeas”，就像在 ApacheDS 示例中所做的那样。如果您想使用不同的组织名称，可以将其更改为“o=yourOrganizationName”形式的任何名称。                                                                                                                                         |
| 15.（！）如果您在#3 中更改了组织名称，则需要在此处进行完全相同的更改。                                                                                                                                                                                                                                      |
| 16.（！）我们将所有 Jetspeed 密钥存储在一个名为“ou=rootOrg”的组中。您可以将其名称更改为您想要的任何名称，只要它的格式为“ou=yourOrganizationalUnit”，并且您的更改会反映在#17、#18 和 LDIF 文件中。在“ou=rootOrg”目录中，我们将所有角色存储在一个名为“ou=Roles”的子目录中。您可能也不需要更改该名称。 |
| 17.(!)正如#16 中提到的，如果你改变了“ou=rootOrg”的名字，你需要相应地改变这个值。                                                                                                                                                                                                                          |
| 18.（！）与#17相同。                                                                                                                                                                                                                                                                                        |

除非更改 LDAP 模式本身，否则其他参数不太可能需要更改。现在，我们需要在 LDAP 目录中设置至少一个 Jetspeed 帐户。而且我们不能使用 Jetspeed 管理 portlet 来执行此操作，因为我们需要以管理员身份登录才能执行此操作（此时不存在任何类型的帐户）。幸运的是，我们创建了一个可以导入 ApacheDS 的 LDIF 文件，并且与上面的 Jetspeed 配置完全匹配。

### 6.3.4. **LDIF 导入**

LDAP 数据交换格式 (LDIF) 是一种标准数据交换格式，用于表示 LDAP 目录内容以及目录更新（添加、修改、删除、重命名）请求。以下文本是 LDIF 文件的内容，可帮助您开始使用 Jetspeed LDAP 基本配置。LDIF 示例中的条目包括用于创建基本 Jetspeed 管理员用户的定义以及启动和运行最小门户所需的角色。为方便起见，您可以从此处下载此 LDIF 文件：

[http://people.apache.org/\~taylor/LDAP/jetspeed-apacheds.ldif](http://people.apache.org/~taylor/LDAP/jetspeed-apacheds.ldif)

使用 Apache DS，我们无法使用 LDIF 导入创建根域。相反，我们必须如上所述创建一个分区。另请查看[root.ldif](http://people.apache.org/~taylor/LDAP/root.ldif)文件，因为它包含您在不同 LDAP 服务器上可能需要的 SevenSeas 组织的根定义。

我们建议使用[LDAP Studio](http://directory.apache.org/studio/)通过 File->Import 将 Jetspeed LDIF 文件导入 Apache DS 服务器

dn：ou=rootOrg，o=sevenSeas

objectClass：organizationalUnit

objectClass：top

ou：rootOrg

dn：ou=People，ou=rootOrg，o=sevenSeas

objectClass：organizationalUnit

objectClass：top

ou：People

dn：ou=Groups，ou=rootOrg， o=sevenSeas

objectClass:organizationalUnit

objectClass:top

ou:Groups

dn:ou=Roles,ou=rootOrg,o=sevenSeas

objectClass:organizationalUnit

objectClass:top

ou:Roles

dn:cn=accounting,ou=Groups,ou=rootOrg,o= SevenSeas

objectClass：jetspeed-2-group

objectClass：groupOfUniqueNames

objectClass：top

cn：accounting

j2-classname：accounting

uid:accounting

uniquemember:user,local,sublocal

dn:cn=engineering,ou=Groups,ou=rootOrg,o=sevenSeas

objectClass:jetspeed-2-group

objectClass:groupOfUniqueNames

objectClass:top

cn:engineering

j2-classname:engineeringuid

:工程

uniquemember：用户

dn：cn=marketing，ou=Groups，ou=rootOrg，o=sevenSeas

objectClass：jetspeed-2-group

objectClass：groupOfUniqueNames

objectClass：top

cn：marketing

j2-classname：marketing

uid：marketing

uniquemember：用户

dn： cn=admin,ou=Roles,ou=rootOrg,o=sevenSeas

objectClass: jetspeed-2-role

objectClass: groupOfUniqueNames

objectClass: top

cn: admin

j2-classname: admin

uid: admin

uniquemember: admin

dn: cn=manager,ou=Roles,ou=rootOrg,o=sevenSeas

objectClass: jetspeed-2-role

objectClass: groupOfUniqueNames

objectClass: top

cn: manager

j2-classname: manager

uid: manager

uniquemember: admin,jetspeed,manager

dn: cn=user,ou=Roles,ou=rootOrg,o=sevenSeas

objectClass: jetspeed-2-role

objectClass: groupOfUniqueNames

objectClass: top

cn: user

j2-类名：用户

uid：用户

唯一成员：用户、管理员、经理、本地

dn：cn=guest，ou=Roles，ou=rootOrg，o=sevenSeas

objectClass：jetspeed-2-role

objectClass: groupOfUniqueNames

objectClass: top

cn: guest

j2-classname: guest

uid: guest

uniquemember: guest

dn: cn=subsite,ou=Roles,ou=rootOrg,o=sevenSeas

objectClass: jetspeed-2-role

objectClass: groupOfUniqueNames

objectClass: top

cn: subsite

j2-classname: subsite

uid: subsite

uniquemember:

subsite dn: cn=subsite2,ou=Roles,ou=rootOrg,o=sevenSeas

objectClass: jetspeed-2-role

objectClass: groupOfUniqueNames

objectClass: top

cn: subsite2

j2-classname : subsite2

uid: subsite2

uniquemember: subsite

dn: cn=dev,ou=Roles,ou=rootOrg,o=sevenSeas

objectClass: jetspeed-2-role

objectClass: groupOfUniqueNames

objectClass: top

cn: dev

j2-classname: dev

uid: dev

uniquemember: dev

dn: cn=devmgr,ou=Roles,ou=rootOrg,o=sevenSeas

objectClass: jetspeed-2-角色

objectClass: groupOfUniqueNames

objectClass: top

cn: devmgr

j2-classname: devmgr

uid: devmgr

uniquemember: devmgr

dn: cn=admin,ou=People,ou=rootOrg,o=sevenSeas

objectClass: organizationsPerson

objectClass: person

objectClass: jetspeed-2-用户

objectClass：inetOrgPerson

objectClass：top

cn：admin

给定名称：Admin

j2-role：admin

j2-role: manager

j2-role: user

sn: admin

uid: admin

userpassword:: c2VjcmV0

dn: cn=manager,ou=People,ou=rootOrg,o=sevenSeas

objectClass: organizationsPerson

objectClass: person

objectClass: jetspeed-2-user

objectClass: inetOrgPerson

objectClass: top

cn: manager

givenname: Manager

j2-role: manager

j2-role: user

sn: manager

uid: manager

userpassword:: c2VjcmV0

dn: cn=user,ou=People,ou=rootOrg,o=sevenSeas

objectClass ：organizationPerson

objectClass：person

objectClass：jetspeed-2-user

objectClass：inetOrgPerson

objectClass：top

cn: user

givenname: User

j2-role: user

sn: user

uid: user

userpassword:: c2VjcmV0

dn: cn=local,ou=People,ou=rootOrg,o=sevenSeas

objectClass: organizationsPerson

objectClass: person

objectClass: jetspeed-2-用户

objectClass: inetOrgPerson

objectClass: top

cn: local

givenname: Local

j2-role: user

sn: local

uid: local

userpassword:: c2VjcmV0

dn: cn=sublocal,ou=People,ou=rootOrg,o=sevenSeas

objectClass: organizationsPerson

objectClass:人

objectClass: jetspeed-2-user

objectClass: inetOrgPerson

objectClass: top

cn: sublocal

给定名称：子本地j2-

角色：用户

sn：子本地

uid：子本地用户

密码：：c2VjcmV0

dn：cn=tomcat，ou=People，ou=rootOrg，o=sevenSeas

objectClass：organizationalPerson

objectClass：person

objectClass：jetspeed-2-user

objectClass： inetOrgPerson

objectClass: top

cn: tomcat

givenname: tomcat

sn: tomcat

uid: tomcat

userpassword:: c2VjcmV0

dn: cn=jetspeed,ou=People,ou=rootOrg,o=sevenSeas

objectClass: organizationsPerson

objectClass: person

objectClass: jetspeed-2-user

objectClass: inetOrgPerson

objectClass: top

cn: jetspeed

givenname: jetspeed

j2-role: manager

sn: jetspeed

uid: jetspeed

userpassword:: c2VjcmV0

dn: cn=guest,ou=People,ou=rootOrg,o=sevenSeas

objectClass: organizationsPerson

objectClass: person

objectClass: jetspeed-2-user

objectClass:inetOrgPerson

objectClass:顶部

cn: 访客

给定名称: 访客

sn: 访客

uid: 访客

用户密码:: c2VjcmV0

dn: cn=subsite,ou=People,ou=rootOrg,o=sevenSeas

objectClass: organizationsPerson

objectClass: person

objectClass: jetspeed-2-user

objectClass: inetOrgPerson

objectClass: top

cn:

subsite givenname: subsite

j2-role: subsite

j2-role: subsite2

j2-role: user

sn: subsite

uid:

subsite userpassword:: c2VjcmV0

dn: cn=subsite2,ou=People,ou=rootOrg,o=sevenSeas

objectClass: organizationsPerson

objectClass: person

objectClass: jetspeed-2-user

objectClass: inetOrgPerson

objectClass: top

cn: subsite2 givenname

: subsite2

j2-role : subsite j2-

role: subsite2

j2-role: user

sn: subsite2

uid: subsite2

userpassword:: c2VjcmV0

dn: cn=devmgr,ou=People,ou=rootOrg ,o=sevenSeas

objectClass：organizationalPerson

objectClass：person

objectClass：jetspeed-2-user

objectClass：inetOrgPerson

objectClass: top

cn: devmgr givenname

: devmgr

j2-role: devmgr

j2-role: dev

j2-role: user

sn: devmgr

uid: devmgr

userpassword:: c2VjcmV0

那么，从 Jetspeed 的角度来看，它究竟产生了什么？


| \* Jetspeed在关系数据库上开箱即用的所有相同角色、用户和组，是 Jetspeed 正常运行所必需的。                                                           |
| --------------------------------------------------------------------------------------------------------------------------------------------------- |
| \*创建了三个组（会计、工程、营销）。它们不是 Jetspeed 正常操作的严格要求，但它们显示了如何声明组。                                                  |
| \*创建了八个角色（guest、admin、devmgr、jetspeed、local、manager、sublocal、subsite、subsite2、tomcat、user），与 Jetspeed 的演示分发中的角色集相同 |
| \*管理用户名为**admin**。该用户同时具有“admin”和“manager”角色，因此它具有对所有管理 portlet 的完全访问权限。                                    |
| \*所有用户都是使用密码创建**的**。                                                                                                                  |

**警告：**如果您修改了 security-spi-ldap.xml 中解释旁边带有 (!) 的任何参数，则上述 LDIF 文件将不起作用。它会很好地导入您的 LDAP 服务器，但 Jetspeed 将无法使用它。这是您需要对 LDIF 文件进行更改的列表，根据您修改的参数（如果您没有在 XML 文件中更改它，则不需要在 LDIF 文件中更改它）：


| 3.如果您更改了您的组织名称（默认为“o=sevenSeas”），您需要在每次出现在 LDIF 文件中时更改它。一个简单的“查找/替换”（几乎所有现代文本编辑器都支持）应该就可以了，但是如果留下任何对“o=sevenSeas”的引用（即如果你错过了一两个），那么 LDAP 服务器将拒绝 LDIF 文件为格式错误。 |
| ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| 15.与#3 相同。                                                                                                                                                                                                                                                                  |
| 16.如果您更改了您的组织单位（默认为“ou=rootOrg”），您需要在每次出现在 LDIF 文件中时对其进行更改。您可以使用与#3 相同的“查找/替换”技巧。与 #3 一样，此处的错误将导致 LDIF 文件格式错误。                                                                                     |
| 17.同#16。                                                                                                                                                                                                                                                                      |
| 18.同#16。                                                                                                                                                                                                                                                                      |

### 6.3.5. **LDAP 配置参考**

本节是 Jetspeed 中 LDAP 安全模块配置示例的参考。开箱即用，Jetspeed 在关系数据库中搜索用户、组和角色信息。但是，它也可以在 LDAP 目录中搜索此信息。

Jetspeed 将其 LDAP 配置存储在名为 [security-spi-ldap.xml 的 Spring XML 文件中](http://svn.apache.org/viewcvs.cgi/portals/jetspeed-2/trunk/components/security/etc/security-spi-ldap.xml?content-type=text/plain&view=co)

此 XML 文件描述了一个包含 LDAP 配置参数的对象（Jetspeed 内部使用）。这些配置参数通过构造函数参数传递给对象：

<!-- LDAP 初始上下文工厂。-->

<constructor-arg index="0">

<value>com.sun.jndi.ldap.LdapCtxFactory</value>

</constructor-arg>

每个构造函数参数都包含一个索引来指定正确的顺序。该文件定义了以下参数：


| **指数** | **姓名**                             | **例子**                                                             |
| -------- | ------------------------------------ | -------------------------------------------------------------------- |
| 0        | 初始上下文工厂                       | com.sun.jndi.ldap.LdapCtxFactory                                     |
| 1        | LDAP服务器主机                       | 本地主机                                                             |
| 2        | LDAP服务器端口                       | 389                                                                  |
| 3        | 根上下文                             | o=七海                                                               |
| 4        | LDAP服务器根 dn                      | uid=admin,o=sevenSeas                                                |
| 5        | LDAP服务器根密码                     | 秘密                                                                 |
| 6        | 角色过滤器                           | (objectclass=groupOfUniqueNames))                                    |
| 7        | 组过滤器                             | (objectClass=groupOfNames)                                           |
| 8        | 用户过滤器                           | （对象类=inetorgperson）                                             |
| 9        | 角色会员属性                         | 唯一会员                                                             |
| 10       | userRoleMembershipAttributes         |                                                                      |
| 11       | groupMembershipAttributes            | 成员                                                                 |
| 12       | userGroupMembershipAttributes        |                                                                      |
| 13       | groupMembershipForRoleAttributes     | 唯一会员                                                             |
| 14       | roleGroupMembershipForRoleAttributes |                                                                      |
| 15       | 默认搜索库                           |                                                                      |
| 16       | 角色过滤器库                         | ou=角色，ou=rootOrg                                                  |
| 17       | groupFilterBase                      | ou=组，ou=rootOrg                                                    |
| 18       | 用户过滤器库                         | ou=人，ou=rootOrg                                                    |
| 19       | 角色对象类                           | 顶部，groupOfUniqueNames                                             |
| 20       | 组对象类                             | 顶部，名称组                                                         |
| 21       | 用户对象类                           | 顶部,人,组织人,inetorgperson                                         |
| 22       | 角色标识属性                         | cn                                                                   |
| 23       | groupId属性                          | cn                                                                   |
| 24       | 用户标识属性                         | uid                                                                  |
| 25       | Uid属性                              | uid                                                                  |
| 26       | 会员搜索范围                         | 1                                                                    |
| 27       | 角色Uid属性                          | cn                                                                   |
| 28       | groupUid属性                         | cn                                                                   |
| 29       | userUidAttribute                     | uid                                                                  |
| 30       | roleObjectRequiredAttributeClasses   | 唯一会员                                                             |
| 31       | groupObjectRequiredAttributeClasses  | 成员                                                                 |
| 32       | 用户属性                             | sn={u},cn={u}                                                        |
| 33       | 角色属性                             | sn={u}                                                               |
| 34       | 组属性                               | sn={u}                                                               |
| 35       | 用户密码属性                         | 密码                                                                 |
| 36       | 已知属性                             | cn,sn,o,uid,ou,objectClass,userPassword,member,uniqueMember,memberOf |

### 6.3.6. **将 Jetspeed 2 配置为使用 LDAP**

为 LDAP 使用配置 jetspeed 只需准备好适当的配置文件即可。这些配置文件将放置在**WEB-INF/assembly**扩展的 jetspeed WAR 的文件夹中。

如果要将 Jetspeed2 连接到 LDAP 服务器，需要将以下文件复制到该目录中。

· [*security-spi-ldap.xml *](http://svn.apache.org/viewcvs.cgi/portals/jetspeed-2/trunk/components/security/etc/security-spi-ldap.xml?content-type=text/plain&view=co)*：* 提供 LDAP 绑定的配置信息，下面详细解释。

· [*security-spi-ldap-atn.xml *](http://svn.apache.org/viewcvs.cgi/portals/jetspeed-2/trunk/components/security/etc/security-spi-ldap-atn.xml?content-type=text/plain&view=co)*：* 提供用于身份验证的 SPI 配置。*它将CredentialHandler*和*UserSecurityHandler*的默认实现替换为 LDAP 特定的实现。

· [*security-spi-ldap-atz.xml *](http://svn.apache.org/viewcvs.cgi/portals/jetspeed-2/trunk/components/security/etc/security-spi-ldap-atz.xml?content-type=text/plain&view=co)*：* 为授权提供 SPI 配置。*它将RoleSecurityHandler*、 *GroupSecurityHandler*和*SecurityMappingHandler*的默认实现替换为 LDAP 特定实现。

需要从该程序集目录中删除 默认的身份验证和授权 SPI 配置（称为**security-spi-atn.xml**和的文件）。**security-spi-atz.xml**

在 Jetspeed 源代码树中，可以在以下位置找到示例 ldap 配置文件：

${jetspeed-source-home}/components/security/etc/

如果您的应用程序部署在 Tomcat 中，则目标程序集目录位于：

${tomcat-home}/webapps/jetspeed/WEB-INF/assembly/

此外，Jetspeed 安全组件的源代码树提供了几个使用不同配置的测试以及用于测试 ApacheDS、OpenLDAP、Domino 和 sunDS LDAP 服务器的 ldiff 样本数据。这些位于：

${jetspeed-source-home}/components/security/src/test/JETSPEED-INF/directory/config/

我们将在下面详细讨论 security-spi-ldap.xml 文件。

#### 6.3.6.1. **LDAP 连接属性**

Jetspeed 需要知道的第一个问题是它如何连接到目录存储。

这是通过提供以下属性来完成的：

**initialContextFactory**

初始上下文工厂

<constructor-arg index="0">

<value>com.sun.jndi.ldap.LdapCtxFactory</value>

</constructor-arg>

**ldapServerName**

LDAP 服务器的名称

<constructor-arg index="1">

<value>localhost</value>

</constructor-arg>

**ldapServerPort**

LDAP 服务器的端口

<constructor-arg index="2">

<value>389</value>

</constructor-arg>

**rootContext**

LDAP 服务器的根上下文

<constructor-arg index="3">

<value>o=sevenSeas</value>

</constructor-arg>

**rootDn**

用户名

<constructor-arg index="4">

<value>uid=admin,ou=system</value>

</constructor-arg>

**rootPassword**

密码

<constructor-arg index="5">

<value>秘密</value>

</constructor-arg>

使用 LDAP 浏览器验证连接：

![](file:///C:\Users\johnfeng\AppData\Local\Temp\ksohtml11556\wps66.jpg)

#### 6.3.6.2. **LDAP 对象过滤器**

目录服务可以在任何地方存储任何类型的对象。由于 Jetspeed 需要使用目录中定义的角色、组和用户，因此需要一些帮助才能找到它们。

以下 3 个属性定义 Jetspeed 如何从目录存储中查找角色、组和用户。

· 角色过滤器

· 组过滤器

· 用户过滤器

属性值必须是在 LDAP 模式中定义的有效对象类。

大多数 LDAP 供应商通常通过定义目录存储中可用的每个属性和对象类的 LDIF 文件公开他们的模式。

基于 Lotus Domino 的配置可能如下所示

RoleFilter=(&(objectclass=groupOfUniqueNames)(!(objectClass=dominoGroup)))

GroupFilter=(objectclass=dominoGroup)

UserFilter=(objectclass=dominoPerson)

Domino 使用**dominoGroup** objectClass 定义组，**使用 dominoPerson**定义用户，使用**groupOfUniqueNames**定义角色。由于 group 也有 groupOfUniqueNames 作为对象类，我们需要为角色定义一个过滤器，以便它只会选择角色。如果我们将 RoleFilter 定义为 (objectclass=groupOfUniqueNames)，那么过滤器也会拾取这些组。

**RoleFilter**

此属性告诉 Jetspeed，可以通过查找值为**groupOfUniqueNames的objectClass**属性 来识别角色。

<constructor-arg index="6">

<value>=(objectclass=groupOfUniqueNames)</value>

</constructor-arg>

**GroupFilter**

该属性告诉 Jetspeed，可以通过查找值为**groupOfNames的objectClass**属性 来识别组。

<constructor-arg index="7">

<value>=(objectclass=groupOfUniqueNames)</value>

</constructor-arg>

**UserFilter**

**该属性告诉 Jetspeed，可以通过查找objectClass**属性值 来识别用户**organizationsPerson**。

<constructor-arg index="8">

<value>=(objectclass= organizationsPerson)</value>

</constructor-arg>

除了这些过滤器，我们还可以为每个对象（角色、组和用户）定义一个过滤器基础。

#### 6.3.6.3. **组/角色成员资格**

在 LDAP 中，基本上有 2 种方法来定义组和角色成员身份（用户属于组或角色的事实）：

· 用户对象具有指定他所属的组的属性。这通常通过 memberOf 属性来完成。Microsoft Active Directory 和 Sun Directory Server 在用户对象上使用 memberOf 和 nsrole 属性。

· 组/角色对象通过多值属性包含组成员信息。用户没有属性来指定成员资格。每个组/角色对象都有一个成员列表，其中包含属于该组的用户

Jetspeed 支持这两种型号。

有关 LDAP 成员资格的主要任务是

· 确定用户是否属于特定组/角色

· 获取属于特定组/角色的用户列表

我们刚刚介绍的 2 个模型会影响这些任务的执行方式

· 用户对象的属性

o 确定用户是否属于特定组/角色：

§ 在特定组/角色的用户对象上查找成员资格属性（例如：memberOf）

o 获取属于特定组/角色的用户列表：

§ 遍历所有用户，并检查组的 memberOf 属性值

· 组/角色对象的属性

o 要确定用户是否属于特定组：

§ 在组的成员列表中搜索用户

o 要确定属于特定组的用户：

§ 遍历组上的成员列表

我们现在将详细讨论如何配置组/角色成员资格。

#### 6.3.6.4. **角色成员资格**

如前所述，Jetspeed 在角色成员资格方面支持 2 种模型：

1. 将属性放在用户身上
2. 将属性放在角色上

Jetspeed 要求为 2 个属性中的 1 个设置一个值来确定模型：

· RoleMembershipAttributes

· UserRoleMembershipAttributes

**RoleMembershipAttributes**

为了在角色上存储角色成员资格，我们将通过在包含成员资格信息的角色对象上指定属性来设置**RoleMembershipAttributes属性。**我们不为**UserRoleMembershipAttributes**属性提供值。

<constructor-arg index="9">

<value>成员</value>

</constructor-arg>

这将确保在角色对象上设置成员属性，如以下屏幕截图所示。在下一个示例中，RoleMembershipAttribute 将为空白，因此属性将位于用户级别。

在下面的截图中，我们有一个由

**cn=Role3,ou=Roles,ou=rootOrg,o=sevenSeas定义的 Role 对象**

该角色包含一个成员属性，列出属于该角色的所有用户。

![](file:///C:\Users\johnfeng\AppData\Local\Temp\ksohtml11556\wps67.png)

*一个有 2 个成员的角色*

member 属性的值是用户的完全限定 DN（包括根上下文）。如您所见，用户不包含有关角色成员资格的任何属性。

![](file:///C:\Users\johnfeng\AppData\Local\Temp\ksohtml11556\wps68.png)

*一个用户*

设置此属性后，Jetspeed 将通过执行以下查询来确定特定用户的角色：

(&(member=cn=user1,ou=people,ou=rootOrg,o=sevenSeas)(objectclass=groupOfNames))

此搜索过滤器将返回目录中任意数量的角色。Jetspeed 的下一步是在内部识别这些角色。为了唯一标识一个角色，它将使用 RoleIdAttribute。

在上面的示例中，cn=Role1 将在搜索结果中。Jetspeed 将使用 RoleIdAttribute 来获取角色名称。

**UserRoleMembershipAttributes**

为了存储用户的角色成员资格，我们将通过在包含成员资格信息的用户对象上指定属性来设置**UserRoleMembershipAttributes属性。**我们不为**RoleMembershipAttributes**属性提供值。

<constructor-arg index="10">

<value>memberOf</value>

</constructor-arg>

这将确保对于用户所属的每个角色，在用户对象上设置 memberOf 属性，如以下屏幕截图所示：

![](file:///C:\Users\johnfeng\AppData\Local\Temp\ksohtml11556\wps69.png)

*属于 4 个不同角色的用户*

**memberOf**属性 的值是角色的完全限定 DN（包括根上下文）。它是一个多值属性，因此用户可以拥有零个或多个**memberOf**属性值。

如您所见，用户属于

**cn=role1,ou=Roles,rootOrg,o=sevenSeas**定义的角色。

为了解析角色成员资格，Jetspeed 将使用以下过滤器在目录中搜索角色：

# 定义搜索角色/组/用户所需的过滤器

RoleFilter=(objectclass=groupOfUniqueNames)

正如您在屏幕截图中看到的，cn=role1,o=sevenSeas 对应于代表角色的对象。

注意空的 uniqueMember 属性。大多数 LDAP 模式强制您在**groupOfUniqueNames**对象上具有**uniqueMember**属性。由于 Jetspeed 需要能够创建角色（创建时为空），因此需要设置一个空的**uniqueMember属性。**这可由 Jetspeed 通过**RequiredAttributeClasses**属性进行配置。

![](file:///C:\Users\johnfeng\AppData\Local\Temp\ksohtml11556\wps70.png)

*没有任何成员的角色*

#### 6.3.6.5. **组成员**

如前所述，Jetspeed 在群组成员方面支持 2 种模型：

1. 将属性放在用户身上
2. 将属性放在组上

Jetspeed 要求为 2 个属性中的 1 个设置一个值来确定模型：

· GroupMembershipAttributes

· 用户组成员属性

**GroupMembershipAttributes**

为了在组中存储组成员资格，我们将通过在包含成员资格信息的组对象上指定属性来设置**GroupMembershipAttributes属性。**我们不为**UserGroupMembershipAttributes**属性提供值。

<constructor-arg index="11">

<value>uniqueMember</value>

</constructor-arg>

这将确保在组对象上设置了**uniqueMember**属性，如以下屏幕截图所示。在前面的示例中，**GroupMembershipAttributes**是空白的，因此在用户级别上使用 了**UserGroupMembershipAttributes ：**

![](file:///C:\Users\johnfeng\AppData\Local\Temp\ksohtml11556\wps71.png)

uniquemember 属性的值是用户的完全限定 DN（包括根上下文）。如您所见，用户不包含任何关于组成员身份的属性。

![](file:///C:\Users\johnfeng\AppData\Local\Temp\ksohtml11556\wps72.png)

**UserGroupMembershipAttributes**

为了在用户上存储组成员资格，我们将通过在包含成员资格信息的用户对象上指定属性来设置**UserGroupMembershipAttributes属性。**我们不为**GroupMembershipAttributes**属性提供值。

<constructor-arg index="12">

<value>memberOf</value>

</constructor-arg>

这将确保在用户对象上设置**memberOf**属性，如以下屏幕截图所示。

只能填写其中一个参数。如果设置了**GroupMemberShipAttributes**，Jetspeed 假定确定组成员身份的属性位于组对象上。

![](file:///C:\Users\johnfeng\AppData\Local\Temp\ksohtml11556\wps73.jpg)

*属于 2 个不同角色的用户*

memberOf 属性的值是角色的完全限定 DN（包括根上下文）。它是一个多值属性，因此用户可以拥有零个或多个 memberOf 属性值。在上面的截图中，我们可以看到 user1 属于 2 个角色。

如您所见，角色在**cn=role1,o=sevenSeas**中定义。（注意空的 uniqueMember 属性）。

![](file:///C:\Users\johnfeng\AppData\Local\Temp\ksohtml11556\wps74.png)

*角色定义*

#### 6.3.6.6. **组成员（角色）**

除了将用户存储在一个组中，Jetspeed 还支持将角色存储到组中。

同样，就像用户的基本组成员资格一样，Jetspeed 在角色的组成员资格方面支持 2 种模型：

1. 将属性放在角色上
2. 将属性放在组上

Jetspeed 要求为 2 个属性中的 1 个设置一个值来确定模型：

· GroupMembershipForRoleAttributes

· RoleGroupMembershipForRoleAttributes

**GroupMembershipForRoleAttributes**

为了在组中存储组成员资格，我们将通过在包含成员资格信息的组对象上指定属性来设置 GroupMembershipAttributes 属性。我们不为 UserGroupMembershipAttributes 属性提供值。

<constructor-arg index="13">

<value>uniqueMember</value>

</constructor-arg>

这将确保在组对象上设置了 uniqueMember 属性，如以下屏幕截图所示。在前面的示例中，GroupMembershipAttributes 是空白的，因此在用户级别上使用了 UserGroupMembershipAttributes。

![](file:///C:\Users\johnfeng\AppData\Local\Temp\ksohtml11556\wps75.jpg)

uniquemember 属性的值是用户的完全限定 DN（包括根上下文）。如您所见，用户不包含任何关于组成员身份的属性。

![](file:///C:\Users\johnfeng\AppData\Local\Temp\ksohtml11556\wps76.jpg)

**RoleGroupMembershipForRoleAttributes**

为了在用户上存储组成员资格，我们将通过在包含成员资格信息的用户对象上指定属性来设置**UserGroupMembershipAttributes属性。**我们不为**GroupMembershipAttributes**属性提供值。

<constructor-arg index="14">

<value>memberOf</value>

</constructor-arg>

这将确保在用户对象上设置**memberOf**属性，如以下屏幕截图所示。

![](file:///C:\Users\johnfeng\AppData\Local\Temp\ksohtml11556\wps77.jpg)

uniquemember 属性的值是用户的完全限定 DN（包括根上下文）。如您所见，用户不包含任何关于组成员身份的属性。

![](file:///C:\Users\johnfeng\AppData\Local\Temp\ksohtml11556\wps78.jpg)

只能填写其中一个参数。如果设置了**GroupMemberShipAttributes**，Jetspeed 假定确定组成员身份的属性位于组对象上。

![](file:///C:\Users\johnfeng\AppData\Local\Temp\ksohtml11556\wps79.jpg)

*属于 2 个不同角色的用户*

memberOf 属性的值是角色的完全限定 DN（包括根上下文）。它是一个多值属性，因此用户可以拥有零个或多个 memberOf 属性值。在上面的截图中，我们可以看到 user1 属于 2 个角色。

如您所见，角色在**cn=role1,o=sevenSeas**中定义。（注意空的 uniqueMember 属性）。

![](file:///C:\Users\johnfeng\AppData\Local\Temp\ksohtml11556\wps80.jpg)

*角色定义*

#### 6.3.6.7. **默认搜索库**

Jetspeed 允许您定义将用于搜索目录的默认搜索库

<constructor-arg index="15">

<value></value>

</constructor-arg>

#### 6.3.6.8. **LDAP 对象过滤器基础**

Jetspeed 允许您定义将应用于角色、组和用户查询的搜索库。

角色、组和用户通常存储在 LDAP 结构内定义明确的容器中。

· 角色可以存储在 ou=Roles,ou=rootOrg

· 组可以存储在 ou=Groups,ou=rootOrg

· 用户可以存储在ou=People,ou=rootOrg

这允许您在 LDAP 模式中具有以下结构。请注意 o=sevenSeas 模式中有许多组织单位。Jetspeed 将其在 LDAP 上的搜索范围限制为上面定义的属性值。这意味着 Jetspeed 将仅使用 rootOrg 中的角色、组和人员。

![](file:///C:\Users\johnfeng\AppData\Local\Temp\ksohtml11556\wps81.jpg)

因此，与对象过滤器（RoleFilter、GroupFilter、UserFilter）一起，Jetspeed 将能够在目录中定位角色、组和用户。

使用这些属性，Jetspeed 还将使用提供的 ObjectClasses 创建角色、组和用户。

**RoleFilterBase**

使用下面的属性值，Jetspeed 将在 ou=Roles,ou=OrgUnit 子树中搜索角色。

<constructor-arg index="16">

<value>ou=Roles,ou=rootOrg</value>

</constructor-arg>

![](file:///C:\Users\johnfeng\AppData\Local\Temp\ksohtml11556\wps82.jpg)

**GroupFilterBase**

使用上面的属性值，Jetspeed 将在 ou=Groups,ou=OrgUnit 子树中搜索组。

<constructor-arg index="17">

<value>ou=Groups,ou=rootOrg</value>

</constructor-arg>

![](file:///C:\Users\johnfeng\AppData\Local\Temp\ksohtml11556\wps83.jpg)

**UserFilterBase**

使用上面的属性值，Jetspeed 将在 ou=People,ou=OrgUnit 子树中搜索用户。

<constructor-arg index="18">

<value>ou=People,ou=rootOrg</value>

</constructor-arg>

![](file:///C:\Users\johnfeng\AppData\Local\Temp\ksohtml11556\wps84.jpg)

#### 6.3.6.9. **LDAP 对象类**

Jetspeed 允许您通过以下属性定义创建角色、组和用户所需的 ObjectClass

· 角色对象类

· 组对象类

· 用户对象类

通过管理界面，Jetspeed 允许管理员创建角色、组和用户。每个目录服务器都有自己定义角色、组或用户的方式。一些 LDAP 供应商使用专有的 ObjectClasses 来定义这些对象（例如 Domino LDAP 服务器使用 dominoGroup objectClass 来定义组）。

使用这些属性，Jetspeed 将使用提供的 ObjectClasses 创建角色、组和用户。

**RoleObjectClasses**

<constructor-arg index="19">

<value>top,groupOfNames</value>

</constructor-arg>

使用上面的设置，角色将像这样创建

![](file:///C:\Users\johnfeng\AppData\Local\Temp\ksohtml11556\wps85.jpg)

注意由 RoleObjectClasses 属性定义的所有 objectClasses 是如何在 LDAP 中创建的

**GroupObjectClasses**

<constructor-arg index="20">

<value>top,groupOfUniqueNames</value>

</constructor-arg>

使用上面的设置，组将像这样创建

![](file:///C:\Users\johnfeng\AppData\Local\Temp\ksohtml11556\wps86.jpg)

注意由 GroupObjectClasses 属性定义的所有 objectClasses 是如何在 LDAP 中创建的

**UserObjectClasses**

<constructor-arg index="21">

<value>top,groupOfUniqueNames</value>

</constructor-arg>

使用上面的设置，用户将像这样创建

![](file:///C:\Users\johnfeng\AppData\Local\Temp\ksohtml11556\wps87.jpg)

注意由 UserObjectClasses 属性定义的所有 objectClasses 是如何在 LDAP 中创建的

#### 6.3.6.10. **命名属性**

· RoleId 属性

· GroupId 属性

· 用户标识属性

上面的属性允许您定义角色/组和用户的命名属性。在目录中创建对象时，需要指定命名属性。命名属性是在其子目录中唯一定义对象的属性。

在下面的屏幕截图中，您可以看到 rootOrg/People 中的 admin 用户由**cn=admin**定义。

**cn**是用户对象的命名属性，因为 rootOrg/People 子目录中不能存在 2 个管理员用户

![](file:///C:\Users\johnfeng\AppData\Local\Temp\ksohtml11556\wps88.jpg)

通过更改属性，您可以控制 Jetspeed 创建用户对象的方式。

**RoleIdAttribute**

<constructor-arg index="22">

<value>cn</value>

</constructor-arg>

**GroupIdAttribute**

<constructor-arg index="23">

<value>cn</value>

</constructor-arg>

**UserIdAttribute**

<constructor-arg index="24">

<value>uid</value>

</constructor-arg>

在下面的屏幕截图中，用户将**uid**属性作为其命名属性

![](file:///C:\Users\johnfeng\AppData\Local\Temp\ksohtml11556\wps89.jpg)

#### 6.3.6.11. **UserId 属性**

当 Jetspeed 尝试查找用户时，它会根据用户在登录屏幕中提供的 userId 进行查找。这个 userId 需要通过特定的属性在对象上定义。大多数 LDAP 服务器都有一个 uid 属性，用于定义 LDAP 中用户的用户名。

Jetspeed内部构建userPrincipal时，会使用userUidAttribute的值对应的属性。

![](file:///C:\Users\johnfeng\AppData\Local\Temp\ksohtml11556\wps90.jpg)

**userUidAttribute**

<constructor-arg index="25">

<value>cn</value>

</constructor-arg>

此属性与 UidAttribute 结合使用

UserIdAttribute=cn

UidAttribute=uid

#### 6.3.6.12. **会员搜索范围**

Jetspeed 允许您在会员资格方面自定义搜索范围

<constructor-arg index="26">

<value>cn</value>

</constructor-arg>

#### 6.3.6.13. **必需的属性类**

某些 ObjectClass 强制您在将对象存储到目录之前为其添加特定属性。Jetspeed 允许您通过以下属性为角色和组指定这些属性

· roleObjectRequiredAttributeClasses

· roleObjectRequiredAttributeClasses

例如，大多数 LDAP 模式强制您在**groupOfUniqueNames**对象上具有**uniqueMember**属性。

由于 Jetspeed 需要能够通过管理控制台创建空角色，因此需要在创建角色时设置一个空的**uniqueMember**属性。

这由 Jetspeed 内部处理，可以通过设置**groupObjectRequiredAttributeClasses**属性进行自定义。

**roleObjectRequiredAttributeClasses**

以下属性指定如果创建角色，将在角色对象上创建一个空的**成员**属性，以符合 LDAP 模式。

<constructor-arg index="30">

<value>成员</value>

</constructor-arg>

**groupObjectRequiredAttributeClasses**

以下属性指定如果创建组，将在组对象上创建一个空的**uniqueMember**属性，以符合 LDAP 模式。

<constructor-arg index="31">

<value>uniqueMember</value>

</constructor-arg>

#### 6.3.6.14. **LDAP 对象属性**

Jetspeed 有一个管理控制台，允许管理员在目录中创建组、角色和用户。Jetspeed LDAP 配置有 3 个属性可以操纵这些对象的创建

· 用户属性

· 角色属性

· 组属性

每个属性都接受一个逗号分隔的属性列表。占位符可用于属性值。

**userAttributes**

例如，以下**userAttributes**值将确保当 Jetspeed 在目录中创建用户时，将创建包含用户用户名的 **sn、cn 和 uid属性。**

<constructor-arg index="32">

<value>sn={u},cn={u}</value>

</constructor-arg>

**roleAttributes**

例如，以下**roleAttributes**值将确保当 Jetspeed 在目录中创建用户时，将创建包含用户用户名的 **cn属性。**

<constructor-arg index="33">

<value>cn={u}</value>

</constructor-arg>

**groupAttributes**

例如，以下**groupAttributes**值将确保当 Jetspeed 在目录中创建用户时，将创建包含用户用户名的 **cn属性。**

<constructor-arg index="34">

<value>cn={u}</value>

</constructor-arg>

#### 6.3.6.15. **LDAP 密码属性**

在运行期间，Jetspeed 需要读取与用户关联的密码。Jetspeed 需要知道包含密码的用户对象的属性。**userPasswordAttribute**属性定义包含用户密码的 LDAP 属性

<constructor-arg index="35">

<value>cn={u}</value>

</constructor-arg>

#### 6.3.6.16. **已知属性**

当 Jetspeed 执行 LDAP 查询时，我们需要指定我们想要返回的属性集。这是通过在**knowAttributes**属性 中指定 LDAP 属性的逗号分隔值来完成的

<constructor-arg index="36">

<value>cn,sn,o,uid,ou,objectClass,userPassword,member,uniqueMember,memberOf</value>

</constructor-arg>

## 6.4. [**单点登录**](https://portals.apache.org/jetspeed-2/deployguide/config-sso.html)

SSO 或单点登录是组织将其身份管理和身份验证需求集中在跨企业多个应用程序的统一的单一解决方案中的一种方式。企业可以使用很多解决方案来实施 SSO。Jetspeed 将 SSO 分为两类：

· 捷速 SSO

· 外部身份管理解决方案

第一个是 Jetspeed SSO，它是一种相当简单的解决方案，适用于不需要强大身份管理 SSO 解决方案的复杂性的企业应用程序。在这种情况下，Jetspeed 为用户凭据提供凭据存储。Jetspeed 可以将用户或用户组的加密凭证存储到外部站点。第二种解决方案需要第三方开源项目或产品。在这种情况下，Jetspeed 与外部 SSO 解决方案集成。这些外部解决方案通常可以是组织的单点登录解决方案，甚至是组织联盟。

### 6.4.1. **捷速 SSO**

Jetspeed SSO 使用 Jetspeed 和 Java 安全性来实现一组用于存储凭证的服务和 portlet。[管理管理** portlet**](https://portals.apache.org/jetspeed-2/adminguide/sso.html)允许编辑 SSO 站点和远程凭证。Jetspeed SSO 带有一组安全的 IFrame 和 Web 内容 portlet。这些portlet 允许您保护对外部站点的访问。身份验证支持包括：

· **基本身份验证是默认设置，甚至无需设置sso.type**首选项即可得到有效支持。只需提供域的凭据和基本身份验证默认值。凭据不会被抢先发送，但如果返回 401 请求进行基本身份验证，则会得到妥善处理。这等效于设置首选项 sso.type=basic （或 sso.type=html（旧 - 现在不推荐使用，而将其称为**basic**）。如果您设置 sso.type=basic.preemptive，它将抢先发送凭据。

· **URL 身份验证**（查询参数）支持为**sso.type=url**或**sso.type=url.base64**。根据定义，这种类型的身份验证是抢先的, 所以那里没有区别。

· **sso.type=form**支持**表单身份验证**（相当于 sso.type=form.post - 如果登录表单上使用 GET 协议，您也可以指定 sso.type=form.get）。此表单还需要一堆其他数据（例如操作 URL、其他参数、凭据字段的名称等）。所有这些都在演示 portlet.xml 中的示例中。基于表单的身份验证也被认为是“抢先式”的，因为它在读取任何其他内容之前进行身份验证。但是，它只执行一次。如果成功，一切都应该很好。如果失败，用户将不得不手动登录（因为初始内容 URL 将导致重定向到登录页面）。

以下是一些可以为 SSO IFrame 和 SSO 内容 portlet 设置的首选项示例：

        <偏好>

            <name>sso.type</name>

            <value>基本 | 网址 | 形式</value>

        </偏好>

        <偏好>

            <name>sso.url.Principal</name>

            <value>sso-principal</value>

        </偏好>

        <偏好>

            <name>sso.url.Credential</name>

            <value>sso 凭证</value>

        </偏好>            

        <偏好>

            <name>SRC</name>

            <value>http://www.nytimes.com</value>

        </偏好>

        <偏好>

            <name>sso.type</name>

            <value>表格</value>

        </偏好>

        <偏好>

            <name>sso.form.Action</name>

            <value>http://www.nytimes.com/auth/login</value>

        </偏好>

        <偏好>

            <name>sso.form.Principal</name>

            <value>用户 ID</value>

        </偏好>

        <偏好>

            <name>sso.form.Credential</name>

            <value>密码</value>

        </偏好>

        <偏好>

            <name>sso.form.Args</name>

            <value>Submit2=登录；OP=;OQ=;is_continue=false</value>

        </偏好>
### 6.4.2. **与外部 SSO 集成**

要启用身份管理服务，例如 Site Minder 或 Shibbboleth（见下文），有一些将您的 SSO 解决方案与 Jetspeed 集成的一般准则。从自定义构建中删除登录 Portlet 并将身份验证委托给身份验证提供程序。身份验证成功后，重定向到门户。

1. 从您的自定义主页中删除登录 Portlet。你将不再需要它。第三方 SSO 将处理所有身份验证。您需要将第三方 SSO 配置为在成功验证后重定向到 Jetspeed 门户。从 Jetspeed 中删除所有身份验证活动。
2. 修改 Jetspeed web.xml 以包含 SSO 解决方案所需的任何设置。您可能需要启用此过滤器和映射：

<过滤器>

<filter-name>PortalFilter</filter-name>

<filter-class>org.apache.jetspeed.login.filter.PortalFilter</filter-class>   
</过滤器>

<过滤器映射>

<filter-name>PortalFilter</filter-name>

<url-pattern>/*</url-pattern>    
</filter-mapping>  

3.
4. 建议对 Jetspeed web.xml 进行其他编辑：

o 删除登录 portlet 的 security-config

<登录配置>

<auth-method>FORM</auth-method>

<realm-name>Jetspeed</realm-name>

<表单登录配置>

  <form-login-page>/login/login</form-login-page>

  <form-error-page>/login/error</form-error-page>

</form-login-config>
</login-config>

o

o 删除 servlet：LoginProxyServlet、LoginServlet、LoginErrorServlet、LoginRedirectorServlet 和 LogoutServlet

o 删除上述 servlet 的 servlet-mappings

### 6.4.3. **希博莱特**

Jetspeed 附带一个 Shibboleth 过滤器，用于通过 Shibboleth 和 Jetspeed 门户执行单点登录 (SSO)。Shibboleth 的服务提供者提供 HTTP 请求标头。过滤器读取 Shibboleth 标头并将其解释为单点登录令牌。Shibboleth 也可以配置为提供可以传递到门户的各种用户属性。有关更多详细信息，请参阅您的 Shibboleth 文档。Jetspeed Shiboleth 过滤器在 Jetspeed web.xml 中配置：

<过滤器>

<filter-name>ShibbolethPortalFilter</filter-name>

<filter-class>org.apache.jetspeed.security.impl.shibboleth.ShibbolethPortalFilter

</filter-class>   
</过滤器>

如果不存在 Shibboleth 标头，Jetspeed 将不会对用户进行身份验证。如果 HTTP 请求中有 Shibboleth 令牌，Jetspeed 将使用它们并自动验证用户，绕过 Jetspeed 的内部验证和登录机制。

要将 Jetspeed 配置为使用 Shibboleth 标头，可以在 WEB-INF/assembly/alternate/shibboleth.xml 下找到一个 Spring 配置文件：

<beans xmlns="http://www.springframework.org/schema/beans" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"

xsi:schemaLocation="http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans-2.5.xsd">

<bean id="org.apache.jetspeed.security.shibboleth.ShibbolethConfiguration"

class="org.apache.jetspeed.security.impl.shibboleth.ShibbolethConfiguration">

<!-- 常见的 jetspeed-security 主体映射到 shibboleth 标头 -->

<构造函数参数索引='0'>

  <地图>

    <入口键='用户名'>

      <value>shib-person-commonname</value>

    </entry>

  </地图>

</constructor-arg>

<!-- 始终针对 Jetspeed 进行身份验证（如果您的 jetspeed db != 身份验证用户，则应为 false）-->

<构造函数参数索引='1'>

   <value type="boolean">true</value>    

</constructor-arg>

<构造函数参数索引='2'>

 	<ref bean="PortalConfiguration" />

</constructor-arg>
</豆>

</beans>

第一个构造函数参数是常见的 jetspeed 安全名称的映射。**username**目前我们只支持从 Shibboleth 主体映射。它被配置为映射到名为 的 Shibboleth 标头/属性**sub-person-commonname**。

第二个构造函数打开或关闭 Jetspeed 身份验证。如果您只是想信任 Shibboleth 或者如果您在构造函数参数一中没有可用的密码，请关闭此选项。

### 6.4.4. **中国科学院**

中央[身份验证服务](http://www.jasig.org/cas)CAS 是 Web 的单点登录协议。与其他单点登录系统 (SSO) 一样，其目的是允许用户访问多个应用程序，同时只需提供一次凭据（例如用户 ID 和密码）。它还允许 Web 应用程序对用户进行身份验证，而无需访问用户的安全凭证，例如密码。

Jetspeed 随 CAS servlet 过滤器一起分发，用于通过 CAS 和 Jetspeed 门户执行单点登录 (SSO)。CAS 必须首先安装到您的应用程序服务器中。安装和配置后，用户可以通过 CAS 登录。当他们访问任何 Jetspeed 页面时，Jetspeed 可以检查 CAS 是否已成功验证。如果 CAS 已通过身份验证，则 Jetspeed 通过使用 CAS 内部提供的身份参与 CAS SSO。以下部分介绍如何使用 CAS 配置 Jetspeed。

#### 6.4.4.1. **配置 CAS 过滤器**

请务必在此处使用 CAS 配置您的应用程序服务器，如下所述： [使用** Java **配置 CAS](http://www.ja-sig.org/wiki/display/CASC/CAS+Client+for+Java+3.1)。使用 CAS 配置应用程序服务器并验证其工作正常后，请继续此处的 Jetpeed 配置说明。CAS 过滤器在 Jetspeed 的 web.xml 中配置。您需要将以下行添加到 web.xml。CAS 过滤器应放置在 web.xml 中，位于 Jetspeed 门户过滤器之前。请注意，init-params 值将特定于您的部署。我们在这里提供一些本地主机示例：

<过滤器>

<filter-name>CAS 过滤器</filter-name>

<filter-class>edu.yale.its.tp.cas.client.filter.CASFilter</filter-class>

<初始化参数>

   <param-name>edu.yale.its.tp.cas.client.filter.loginUrl</param-name>

   <param-value>http://localhost/login</param-value>		
</init-param>

<初始化参数>

   <param-name>edu.yale.its.tp.cas.client.filter.validateUrl</param-name>

   <param-value>http://localhost/serviceValidate</param-value>
</init-param>

<初始化参数>

   <param-name>edu.yale.its.tp.cas.client.filter.serverName</param-name>

   <param-value>本地主机</param-value>
</init-param>

</过滤器>

确保将 CAS 过滤器映射也添加到您的 web.xml：

<过滤器映射>

	<filter-name>CAS 过滤器</filter-name>

	<url-pattern>/portal/caslogin/*</url-pattern>

</filter-mapping>
#### 6.4.4.2. **配置 Jetspeed CAS 门户过滤器**

Jetspeed CAS 门户过滤器读取并解释 CAS 会话状态以参与 CAS SSO。Jetspeed CAS 门户过滤器在 Jetspeed 的 web.xml 中配置。您需要将以下行添加到 web.xml。确保将过滤器放置在上述 CAS 过滤器之后（下方）。

<过滤器>

<filter-name>PortalFilter</filter-name>

<filter-class>org.apache.jetspeed.security.impl.cas.CASPortalFilter</filter-class>   
</过滤器>

确保将过滤器映射也添加到您的 web.xml：

<过滤器映射>

  <filter-name>PortalFilter</filter-name>

  <url-pattern>/portal/*</url-pattern>    

</filter-mapping>
如果没有 CAS 会话状态，Jetspeed 将不会对用户进行身份验证。如果存在 CAS 会话状态，Jetspeed 将使用它们并自动验证用户，绕过 Jetspeed 的内部验证和登录机制。

#### 6.4.4.3. **注销**

要启用 CAS 会话注销，请将以下 init 参数添加到 Jetspeed 的 web.xml 中的 Jetspeed Logout Servlet。请注意，参数值将特定于您的 CAS 配置。

<小服务程序>

<servlet-name>LogoutServlet</servlet-name>

<servlet-class>org.apache.jetspeed.login.LogoutServlet</servlet-class>

<初始化参数>

 <param-name>casLogoutUrl</param-name>

 <param-value>http://localhost/logout</param-value>
</init-param>

</servlet>

## 6.5. [**NTLM**](https://portals.apache.org/jetspeed-2/deployguide/guide-ntlm.html)

NTLM 身份验证可用于来自 Windows 客户端/浏览器的单点登录 (SSO)。关于 NTLM 的一个很好的解释可以在[这里](http://jcifs.samba.org/src/docs/ntlmhttpauth.html)找到。Jetspeed-2 支持基于[jCIFS](http://jcifs.samba.org/) Servlet 过滤器的 NTLM 身份验证。使用下面描述的方法，您可以使用 NTLM 身份验证和可选的回退到默认的活动身份验证，因此该解决方案可以用作替代品。后备登录方法的典型应用是当用户从不同域登录到 Intranet 时：这些用户可以被重定向到登录屏幕。

下面的解决方案也可以用作默认安全阀的替代品：如果您不配置过滤器，则将应用 Jetspeed 的默认授权。

## 6.6. **配置 NTLM 身份验证**

[此处 ](https://portals.apache.org/jetspeed-2/devguide/guide-security.html)解释了 Jetspeed-2 安全配置 。

### 6.6.1. **配置 NTLM servlet 过滤器**

第一步是配置 jCIFS NTLM HTTP 身份验证，[此处](http://jcifs.samba.org/)对此进行了说明。您将 jCIFS 配置为 web 应用程序的 web.xml 中的过滤器。接下来，您必须配置第二个 Jetspeed servlet 过滤器，它必须放在jCIFS 过滤器*之后。*一个示例配置：

<过滤器>

<filter-name>NtlmHttpFilter</filter-name>

<filter-class>jcifs.http.NtlmHttpFilter</filter-class>

<初始化参数>

<param-name>jcifs.smb.client.domain</param-name>

<param-value>SOME_DOMAIN</param-value>
</init-param>

</过滤器>

<过滤器>

<filter-name>NtlmHttpServletRequestFilter</filter-name>

<filter-class>org.apache.jetspeed.security.impl.ntlm.NtlmHttpServletRequestFilter</filter-class>

<初始化参数>

<param-name>org.apache.jetspeed.security.ntlm.ignoreUrls</param-name>

<param-value>/login/login</param-value>
</init-param>

</过滤器>

<过滤器映射>

<filter-name>NtlmHttpFilter</filter-name>

<url-pattern>/*</url-pattern>

</filter-mapping>

<过滤器映射>

<filter-name>NtlmHttpServletRequestFilter</filter-name>

<url-pattern>/*</url-pattern>

</filter-mapping>

### 6.6.2. **配置 NTLM 安全阀**

上述过滤器在请求中设置了正确的凭据。要使用这些凭据，您必须**org.apache.jetspeed.security.impl.ntlm.NtlmSecurityValve**在要保护的 Jetspeed 管道中进行配置。此 Valve 可用作默认值的*替代品*SecurityValveImpl。有关如何设置管道的说明，请参见 [此处](https://portals.apache.org/jetspeed-2/deployguide/guide-pipelines.html)。如何配置 NtlmSecurityValve bean 的示例：

<bean id="securityValve" class="org.apache.jetspeed.security.impl.ntlm.NtlmSecurityValve" init-method="initialize">

<构造函数参数>

<ref bean="org.apache.jetspeed.security.UserManager" />
</constructor-arg>

<!-- 网络域。该值可以选择从经过身份验证的用户名中剥离 -->

<constructor-arg><value>SOME_DOMAIN</value></constructor-arg>

<!-- 在用户主体中省略域 -->

<constructor-arg><value>true</value></constructor-arg>

<!--

     需要 NTLM 授权。

     如果设置为 true，则只有通过 NTLM 身份验证的用户才会被授权。

  -->

<constructor-arg><value>false</value></constructor-arg>

</豆>

## 6.7. [**Tomcat SSO 跨上下文**](https://portals.apache.org/jetspeed-2/deployguide/guide-tomcat-sso-cross-context-j2-realm.html)

本指南提供了在同一 Tomcat(>=6) 容器中运行的多个 Web 应用程序之间创建共享身份验证领域的教程。

### 6.7.1. **1. Jetspeed 领域**

领域在 \$CATALINA\_HOME/conf/server.xml 的 Engine 元素中配置。将 Jetspeed Realm 元素从 $CATALINA_HOME/conf/Catalina/localhost/jetspeed.xml 移动到 $CATALINA_HOME/conf/server.xml 替换或注释掉 UserDatabase Realm。

<领域类名称="org.apache.catalina.realm.JAASRealm"

       appName="Jetspeed"

       userClassNames="org.apache.jetspeed.security.impl.UserPrincipalImpl"

       roleClassNames="org.apache.jetspeed.security.impl.RolePrincipalImpl"

       useContextClassLoader="false"

       调试="0"/>

		
### 6.7.2. **2. 启用 Tomcat SingleSignOn Valve**

在 \$CATALINA\_HOME/conf/server.xml 中取消注释 Valve 上的 Tomcat 单点登录。

<主机名="localhost" appBase="webapps">

<!-- 启用tomcat SSO *** -->

<Valve className="org.apache.catalina.authenticator.SingleSignOn" />
</主机>

### 6.7.3. **3.每个web.xml**

在每个 webapp web.xml 描述符中创建一个安全约束。

<安全约束>

<网络资源集合>

   <web-resource-name>随便</web-resource-name>

   <url-pattern>/*</url-pattern>

</web-resource-collection>

<auth-约束>

  <角色名称>经理</角色名称>

</auth-约束>
</安全约束>

<!-- 定义此应用程序的登录配置 -->

<登录配置>

<auth-method>基本</auth-method>

<realm-name>Jetspeed</realm-name>
</login-config>

<!-- 此 Web 应用程序引用的安全角色 -->

<安全角色>

<说明>

    登录 Manager Application 所需的角色

</描述>

<角色名称>经理</角色名称>
</安全角色>

### 6.7.4. **4. 已知问题**

1. 必须替换、删除或注释掉默认的Tomcat Realm。一个已知的副作用会阻止 Tomcat 管理器应用程序工作。它可以通过使用 $CATALINA_HOME/server/webapps/manager/manager.xml 中的 Jetspeed 领域来解决。

<登录配置>

<auth-method>基本</auth-method>

<realm-name>Jetspeed</realm-name>
</login-config>

2. 必须在 Jetspeed 中进行身份验证，然后才能访问其他 webapp。

## 6.8. [**用户属性**](https://portals.apache.org/jetspeed-2/deployguide/guide-user-attributes.html)

Portlet 规范定义了 Portlet 应用程序如何使用用户属性。

属性必须在 portlet.xml 中定义，例如（参见 PLT.17.1）：

<portlet-app 版本="1.0" xmlns="http://java.sun.com/xml/ns/portlet/portlet-app_1_0.xsd">

<用户属性>

  <description>用户名</description>

  <name>user.name.given</name>
</用户属性>

<用户属性>

  <description>用户姓氏</description>

  <name>user.name.family</name>
</用户属性>

<用户属性>

  <description>用户电子邮件</description>

  <name>user.home-info.online.email</name>
</用户属性>

...

</portlet-app>

一旦像这样定义属性，portlet 就可以使用 PortletRequest 接口中定义的 USER_INFO 常量（参见 PLT.17.2）从 PortletRequest 访问已登录用户的当前值作为不可修改的 Map：

映射 userInfo = (Map)request.getAttribute(PortletRequest.USER_INFO);

String givenName = (userInfo!=null) ? (String)userInfo.get("user.name.given") : "";

字符串姓氏 = (userInfo!=null) ？(String)userInfo.get("user.name.family") : "";

字符串电子邮件 = (userInfo!=null) ？(String)userInfo.get("user.home-info.online.email") : "";

Portlet 规范未定义的是门户必须如何将定义的用户属性映射到用户的具体属性。

### 6.8.1. **映射用户属性**

Jetspeed-2 提供了一种非常灵活的方式来定义具体的用户属性并定义对它们的访问。

具体的用户属性使用用户首选项存储，Jetspeed-2 为其提供了自己的数据库后端进行存储（可以像 Jetspeed-2 的几乎任何组件一样自定义）。用户属性实现利用了 Jetspeed 的 [java.util.prefs.Preferences](https://portals.apache.org/jetspeed-2/devguide/dev-prefs.html)实现。

具体的用户属性存储在用户首选项中的特定节点下，可以随意包含任何命名属性。

这些具体的用户属性可以通过两种方式映射到 portlet.xml 中定义的用户属性：

1. 使用完全匹配的属性名称
2. 在 jetspeed-portlet.xml 中使用自定义映射定义

#### 6.8.1.1. **自定义用户属性映射**

如果您使用 Jetspeed-2 作为目标门户编写新的 Portlet 应用程序，定义与门户中的具体用户属性匹配的用户属性通常会非常简单

。但是，如果您有一个想要在 Jetspeed-2 上部署的现有 Portlet 应用程序， Portlet 应用程序所需的属性名称与存储在 Jetspeed-2 用户首选项中的具体属性名称之间可能不匹配。

注意：**Portlet **规范定义了一组属性名称，建议在附录 PLT.D 中使用。

使用这些属性名称的** Portlet **应用程序和存储同样使用这些名称的具体用户属性的门户将不需要任何自定义属性映射，如下所述。

尽管** Jetspeed-2 **允许完全自由地定义具体的用户属性，但建议尽可能使用这些预定义的属性名称。

jetspeed-portlet.xml 允许指定 jetspeed 特定的配置和定制。

此部署文档不是必需的，但如果在 Portlet Application war 的 WEB-INF 文件夹中找到，则会对其进行处理。

Jetspeed 特定配置必须使用“http://portals.apache.org/jetspeed”命名空间来定义。

用户属性映射使用“user-attribute-ref”元素定义，该元素包含定义自定义用户属性名称的“name”元素和定义映射到的具体属性名称的“name-link”元素：

<portlet-app 版本="1.0"

xmlns="http://java.sun.com/xml/ns/portlet/portlet-app_1_0.xsd"

xmlns:js="http://portals.apache.org/jetspeed">

<js:user-attribute-ref>

  <js:name>用户名给定</js:name>

  <js:name-link>user.name.given</js:name-link>
[/js:用户属性](/js:%E7%94%A8%E6%88%B7%E5%B1%9E%E6%80%A7)

<js:user-attribute-ref>

  <js:name>用户名家庭</js:name>

  <js:name-link>user.name.family</js:name-link>
[/js:用户属性](/js:%E7%94%A8%E6%88%B7%E5%B1%9E%E6%80%A7)

...

</portlet-app>

以上述自定义映射为例，Portlet 现在可以访问用户属性，如下所示：

映射 userInfo = (Map)request.getAttribute(PortletRequest.USER_INFO);

String givenName = (userInfo!=null) ? (String)userInfo.get("user-name-given") : "";

字符串姓氏 = (userInfo!=null) ？(String)userInfo.get("user-name-family") : "";

字符串电子邮件 = (userInfo!=null) ？(String)userInfo.get("user.home-info.online.email") : "";

请注意，未定义自定义映射的电子邮件属性仍然可以使用精确名称匹配来访问（前提是为登录用户定义了具体属性）。

# 7. **门户组件**

## 7.1. [**聚合**](https://portals.apache.org/jetspeed-2/deployguide/guide-aggregation.html)

该门户在单个浏览器显示中提供了多个内容源或 portlet 的合并视图。将这些内容合并和呈现在一起的过程称为聚合。在 Jetspeed 中，聚合器由几个可插入 Jetspeed 引擎的可插拔 Spring 组件组成。

### 7.1.1. **支持的聚合器**

聚合器列表：


| **组件名称**                  | **描述**                                                                                          | **多线程？** | **JSR-168 缓存？** |
| ----------------------------- | ------------------------------------------------------------------------------------------------- | ------------ | ------------------ |
| 页面聚合器                    | 给定一个PSML页面，聚合该页面上所有 portlet 的内容。                                               | 不           | 是的               |
| 异步页面聚合器                | 一个多线程的异步PSML页面聚合器。                                                                  | 是的         | 是的               |
| Portlet聚合器                 | 呈现单个portlet的内容。                                                                           | 不\*         | 是的               |
| AsyncPageAggregator + CommonJ | 一个运行CommonJ Work Monitor线程的多线程异步 PSML 页面聚合器，仅使用 IBM Websphere 6.1 进行测试。 | 是的         | 是的               |

*\* 多线程是通过 Jetspeed 桌面与 PortletAggregator 结合实现的*

### 7.1.2. **聚合器弹簧配置**

    <!-- 默认 portlet 超时，以毫秒为单位：

    零表示默认情况下没有 portlet 超时选项。

    -->

    <构造函数参数>

        <值>0</值>

    </constructor-arg>			
### 7.1.3. **将页面聚合器更改为多线程**

默认聚合器是单线程的。要切换到多线程，请编辑**pipelines.xml**弹簧配置文件：

<!-- 之前 -->

<bean id="aggregatorValve"

    class="org.apache.jetspeed.aggregator.AggregatorValve"

    初始化方法="初始化"
<构造函数参数>

   <ref bean="org.apache.jetspeed.aggregator.PageAggregator"/>
</constructor-arg>

</豆>

<!-- 之后 -->

<bean id="aggregatorValve"

    class="org.apache.jetspeed.aggregator.AggregatorValve"

    初始化方法="初始化"
<构造函数参数>

   <ref bean="org.apache.jetspeed.aggregator.AsyncPageAggregator"/>
</constructor-arg>

</豆>

### 7.1.4. **jetspeed-portlet.xml 参数**

对于多线程聚合器，您可以覆盖特定 portlet 的呈现超时的默认设置。此值以毫秒为单位设置，表示 Jetspeed 在放弃之前将给予 portlet 以完成呈现的超时值。

重要提示：此参数有两个用途：(1) 它的存在启用了 portlet 的并行渲染，以及 (2) 该值确定 Jetspeed 在超时和放弃渲染 portlet 之前将给予该 portlet 多长时间来完成渲染。未来的版本将放宽第一个要求。请注意，即使启用了并行呈现，portlet 也不会呈现在主线程组之外，即按顺序呈现，除非 jetspeed-portlet.xml 中存在此超时参数。

<portlet>

    <portlet-name>PickANumberPortlet</portlet-name>

    <js:metadata name="timeout">3000</js:metadata>
</portlet>

### 7.1.5. **使用 Websphere 进行多线程聚合**

使用 Jetspeed 运行多线程聚合需要以下配置步骤。请注意，所有 Websphere 安装都需要步骤 1 和 2，并且不特定于多线程聚合。

#### 7.1.5.1. **1.登录过滤器**

通过取消注释 PortalFilter 及其映射，将 WEB-INF/web.xml 配置为使用 PortalFilter 登录：

<过滤器>

<filter-name>PortalFilter</filter-name>

<filter-class>org.apache.jetspeed.login.filter.PortalFilter</filter-class>   
</过滤器>

...

<过滤器映射>

<filter-name>PortalFilter</filter-name>

<url-pattern>/*</url-pattern>    
</filter-mapping>               

#### 7.1.5.2. **2.Portal登录Portlet**

编辑 default-page.psml，将登录 portlet 更改为基于过滤器的登录 portlet，如下所示。确保同时更改片段 ID。改变：

<fragment id="dp-12" type="portlet" name="j2-admin::LoginPortlet">

...
到 ..

<fragment id="dp-12a" type="portlet" name="j2-admin::PortalLoginPortlet">

...

        			          
#### 7.1.5.3. **3. 使用 Jetspeed 门户请求工厂**

一些 Web 容器（如 WebSphere 5.x）从当前应用程序上下文中动态获取 HttpServletRequest 的关键信息。这意味着在调用的 portlet 应用程序中，存储在 RequestContext 中的原始 Portal 请求不会返回 Portal 应用程序的 Portal contextPath、servletPath 和 HttpSession。您将获得与当前应用程序 HttpServletRequest 中相同的对象引用。正因为如此，在这些 Web 容器中，通过自定义 portlet 进行门户级登录等简单的事情是不可能的。

为了解决这个问题，将使用一个额外的 PortalRequest 包装器，它从提供的请求中注册初始（门户）对象引用并始终返回这些引用，而不是委托给包装的请求。使用哪个包装器由新的 PortalRequestFactory 处理，可以在 springframework 配置中指定。对于没有此“问题”的其他 Web 容器（如 Tomcat），无需指定任何内容（默认情况下没有指定），在这种情况下，请求将被包装在 HttpServletRequestWrapper 中以保持相同的包装级别（需要方便在 ServletPortletInvoker 中访问原始请求。

编辑 WEB-INF/assembly/wps.xml，并取消注释在那里找到的一个 bean

<豆类>   

<!-- websphere 需要，如果在 websphere 下运行，请取消注释

     见：http://issues.apache.org/jira/browse/JS2-355 -->

<bean id="org.apache.jetspeed.request.PortalRequestFactory" class="org.apache.jetspeed.request.PortalRequestFactoryImpl"/>   
</beans>

#### 7.1.5.4. **4.开启多线程聚合引擎**

用 WEB-INF/assembly/pipelines.xml 中的多线程聚合引擎替换 (org.apache.jetspeed.aggregator.PageAggregator)：

<bean id="aggregatorValve"

    class="org.apache.jetspeed.aggregator.AggregatorValve"

    初始化方法="初始化"
<构造函数参数>

   <ref bean="org.apache.jetspeed.aggregator.AsyncPageAggregator"/>
</constructor-arg>

</豆>

#### 7.1.5.5. **Portlet 请求/响应解包器的可选替换**

您可以用 WEB-INF/assembly/pluto-factories.xml 中的第三方模块替换默认的 portlet 请求/响应解包器。

由于 servlet 容器的 servlet 请求对象在 Jetspeed 并行渲染模式下不能是线程安全的，因此第三方 unwrapper 模块可以通过装饰原始请求对象来提供线程安全的实现。

这是第三方解包器模块的示例设置：

<!--  

  PortletRequestResponseUnwrapper 通过展开从 portlet 请求或 portlet 响应中找到 servlet 请求或 servlet 响应。

  第三方模块可以提供一个实现来装饰 servlet 容器的真实请求或响应对象。

  例如，servlet 容器的真实请求对象可以被修饰，因为它在 Jetspeed 并行渲染模式下不是线程安全的。

  -->

<bean id="PortletRequestResponseUnwrapper"

    class="com.bluesunrise.jetspeed.container.invoker.WebspherePortletRequestResponseUnwrapper" />

        			                        	
#### 7.1.5.6. **可选的 CommonJ 工作管理器**

如果要使用容器提供的 Commonj Work Manager，请在 WEB-INF/assembly/aggregation.xml 中取消注释：

<bean id="JetspeedWorkManager" class="org.springframework.jndi.JndiObjectFactoryBean">

    <property name="resourceRef"><value>false</value></property>

    <属性名称="jndiName">

        <value>java:comp/env/wm/jetspeed</value>

    </属性>

</豆>

<bean id="org.apache.jetspeed.aggregator.CommonjWorkerMonitor"

      class="org.apache.jetspeed.aggregator.impl.CommonjWorkerMonitorImpl"

      初始化方法=“开始”破坏方法=“停止”>

    <constructor-arg index="0">

        <ref bean="JetspeedWorkManager" />           

    </constructor-arg>

</豆>

        		
还将所有对 org.apache.jetspeed.aggregator.WorkerMonitor 的引用替换为 WEB-INF/assembly/aggregation.xml 中的 org.apache.jetspeed.aggregator.CommonjWorkerMonitor。

## 7.2. [**缓存**](https://portals.apache.org/jetspeed-2/deployguide/guide-caching.html)

特定 portlet 的过期缓存在您的 portlet.xml 部署描述符中声明。在运行时，您还可以在[注册表管理](https://portals.apache.org/jetspeed-2/adminguide/pam.html)中为您的 portlet 修改缓存。缓存内容有助于缩短用户的门户响应时间。过期机制是基于每个 portlet 提供的。小心将此特性作为缓存内容，在 Portlet 1.0 规范中，缓存不会在用户之间共享。每个用户都会收到他们自己的缓存内容。当您拥有数千名用户时，此功能可能会占用大量内存。使用 portlet 缓存的真正优势是当您要生成的内容非常昂贵、性能方面。

过期时间在 portlet.xml 中定义并以秒为单位指定：

<portlet>

<expiration-cache>300</expiration-cache>
</portlet>

· 值 0 表示从不缓存信息。

· 值 -1 表示缓存永不过期。

### 7.2.1. **Jetspeed 缓存**

Jetspeed 门户维护其多个系统缓存以提高门户性能。这些缓存可以是[分布式](https://portals.apache.org/jetspeed-2/deployguide/distributed-cache.html)的，但在默认部署中，它们不是分布式的。该**ehcache.xml**文件位于 下**WEB-INF/classes**，用于配置 Jetspeed 系统缓存。


| **Jetspeed 缓存**           |                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |
| --------------------------- | --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **缓存**                    | **描述**                                                                                                                                                                                                                                                                                                                                                                                                                                                              |
| portletContentCache         | JSR-168 Portlet内容缓存 该缓存实现了 JSR-168 缓存规范（请参阅上面的 Portlet 过期缓存）。timeToIdle 和 timeToLive 在这里设置为默认值，但始终基于 portlet 部署描述符值在每个缓存元素的基础上被覆盖。如果有超过 10000 个元素，默认情况下不会溢出到磁盘缓存，在此配置中，它将转到系统上定义 java.io.tmp 的任何位置。在标准 Linux 系统上，这将是 /tmp timeToIdleSeconds 和 timeToLiveSeconds to live 都设置为 8 小时 (28800) 这是将过期缓存设置为 -1 的 portlet 的默认设置 |
| 首选项缓存                  | 将所有首选项节点缓存为元素，包括用户和默认首选项。单个用户偏好可以由每个用户在内存中多达8个节点来表示。在计算缓存大小时，还要考虑默认首选项以及每个用户的首选项要求。**Preferences Cache Preloading**有关预加载首选项缓存的说明，另请参阅下面的部分。                                                                                                                                                                                                                 |
| portletApplicationNameCache | Portlet应用程序按应用程序名称缓存。此缓存与对象关系数据库缓存挂钩，对于门户的合理性能至关重要。                                                                                                                                                                                                                                                                                                                                                                       |
| portletApplicationOidCache  | Portlet应用程序由对象 id 缓存。此缓存与对象关系数据库缓存挂钩，对于门户的合理性能至关重要。                                                                                                                                                                                                                                                                                                                                                                           |
| portletDefinitionNameCache  | Portlet定义由 Portlet 唯一名称缓存。此缓存与对象关系数据库缓存挂钩，对于门户的合理性能至关重要。                                                                                                                                                                                                                                                                                                                                                                      |
| portletDefinitionOidCache   | Portlet定义由对象 id 缓存。此缓存与对象关系数据库缓存挂钩，对于门户的合理性能至关重要。                                                                                                                                                                                                                                                                                                                                                                               |
| 装饰配置缓存                |                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |
| portletWindowCache          | 缓存portlet窗口访问器对象以加快 portlet 片段对窗口查找的访问                                                                                                                                                                                                                                                                                                                                                                                                          |
| pageManagerOidCache         | 页面由对象id缓存。此缓存与对象关系数据库缓存挂钩，对于门户的合理性能至关重要。                                                                                                                                                                                                                                                                                                                                                                                        |
| pageManagerPathCache        | 页面由页面完整路径缓存。此缓存与对象关系数据库缓存挂钩，对于门户的合理性能至关重要。                                                                                                                                                                                                                                                                                                                                                                                  |


| **ehcache.xml 中的常规缓存设置** |                                                                                                                                                     |
| -------------------------------- | --------------------------------------------------------------------------------------------------------------------------------------------------- |
| **环境**                         | **描述**                                                                                                                                            |
| maxElementsInMemory              | 设置将在内存中创建的最大对象数                                                                                                                      |
| maxElementsOnDisk                | 设置将在DiskStore中维护的最大对象数 默认值为零，表示无限制。                                                                                        |
| 永恒                             | 设置元素是否是永恒的。如果是永恒的，则忽略超时并且元素永不过期。                                                                                    |
| 溢出到磁盘                       | 设置当内存存储达到maxInMemory限制时元素是否可以溢出到磁盘。                                                                                         |
| timeToIdleSeconds（可选）        | 设置元素过期前的空闲时间。即元素过期之前访问之间的最大时间量仅在元素不是永恒的情况下使用。可选属性。值0表示元素可以无限空闲。默认值为 0。           |
| timeToLiveSeconds（可选）        | 设置元素过期前的生存时间。即创建时间和元素过期之间的最长时间。仅在元素不是永恒的情况下使用。可选属性。值0意味着 Element 可以无限存在。默认值为 0。  |
| memoryStoreEvictionPolicy        | 策略将在达到maxElementsInMemory限制时强制执行。默认策略是最近最少使用（指定为 LRU）。其他可用策略 - 先进先出（指定为 FIFO）和较少使用（指定为 LFU） |

### 7.2.2. **首选项缓存预加载**

为了帮助提高首选项的性能，可以在系统启动时预加载首选项。请参阅 Spring 配置文件**prefs.xml**以修改在 Jetspeed 启动时将首选项加载到首选项缓存中。可以选择预加载默认和用户（实体）首选项。默认设置是预加载 j2-admin portlet 应用程序的所有首选项。请参阅服务上的构造函数参数 2 **PreferencesProviderImpl**，以修改要预加载的 portlet 应用程序默认首选项列表。将列表留空以不预加载默认首选项。第三个构造函数参数确定是否所有用户（实体）首选项都已预加载。默认为不预加载。使用此设置要非常小心，因为它可能会导致启动时快速耗尽内存。

    <!-- 要预加载的 portlet 应用程序默认首选项列表，将列表留空不预加载 -->

    <构造函数参数索引='2'>

    <列表>

		<value>j2-admin</value>

    </列表>

    </constructor-arg>

    <!-- 预加载所有实体：警告这会占用大量内存 -->

    <constructor-arg index='3'><value type="boolean">false</value></constructor-arg>
## 7.3. [**设备功能**](https://portals.apache.org/jetspeed-2/deployguide/guide-device-capabilities.html)

Jetspeed 功能提供了一种机制，用于将用于访问门户的客户端（浏览器）映射到用于页面呈现的媒体类型。

设备与功能列表相关联，允许门户了解设备可以处理的内容类型（例如 Javascript、DHTML..）

将设备映射到媒体类型和功能的规则存储在数据库中。这些的原始值首先用 XML 数据填充。

您的自定义构建应使用设备和媒体类型的默认 XML 数据进行设置。目前没有用于编辑设备信息的管理 portlet。

XML 测试数据提供了一整套功能、设备、媒体类型和 mime 类型。

Jetspeed-2 功能引擎将客户端映射到媒体类型到 MIME 类型。以下是一些更详细的定义：

· 客户端：向 Jetspeed-2 门户引擎发起请求的应用程序。Jetspeed-2 使用用户代理来确定发起请求的客户端。

· 媒体类型：请求内容的媒体类型（HTML、WML 等）。Jetspeed-2 中的内容可以由不同类型的设备通过不同的媒体请求。

· Mime Type：被请求的内容类型。

· 支持的媒体类型：HTML、XHTML-BASIC、XML、WML、VXML

定义默认的 mime 类型

<MimeTypes>

<MimeType>应用程序/xhtml+xml</MimeType>

<MimeType>文本/html</MimeType>

<MimeType>文本/vnd.wap.wml</MimeType>

<MimeType>文本/vxml</MimeType>

<MimeType>文本/xhtml</MimeType>

<MimeType>文本/xml</MimeType>
</MimeTypes>

定义媒体类型（用于特殊 \_control 文件夹处理）和首选 mime 类型：

<媒体类型名称="html">

<charcterSet value="UTF-8"/>

<title value="HTML"/>

<description value="HTML 4.0 兼容浏览器的富 HTML"/>

<功能></功能>

<mimeTypes>文本/html</mimeTypes>
</媒体类型>

按门户及其设备功能定义支持的客户端（浏览器）。客户端通过首选的 mime 类型映射到媒体类型

<客户端名称="ie5mac" evalOrder="1" preferredMimeTypeID="text/html">

<userAgentPattern value=".*MSIE 5.*Mac.*"/>

<version value="5.*"/>

<模型值="无"/>

<制造商价值="微软"/>

<功能>

	HTML_3_2、HTML_JAVA、HTML_JAVASCRIPT、HTML_TABLE、HTML_FORM、HTML_FRAME、HTML_IMAGE、HTML_PLUGIN、HTML_CSS1、HTML_DOM_NS4、HTTP_COOKIE

</功能>

<mimeTypes>文本/html</mimeTypes>
</客户>

## 7.4. [**管道**](https://portals.apache.org/jetspeed-2/deployguide/guide-pipelines.html)

管道基于控制模式的反转。请求处理管道被组装以在 Spring 容器中运行。门户主要由请求/响应处理数据流驱动，很像 servlet 或 HTTP 请求/响应范例。请求由客户端代理（如 HTML 或 WAP 浏览器）发出，门户在运行 Jetspeed 的应用程序服务器提供的线程上处理请求。请求处理是在像管道这样的工作流中实现的，其中阀门被插入到请求管道中。阀门的工作流程是可配置的，就像任何其他 Spring 组件一样。管道引用（通过基于 Spring 构造函数的依赖项）一个或多个阀门。阀门也是弹簧组件。

对门户的请求始终通过门户 URL 进入。Jetspeed 有 URI 入口点。servlet 上下文 (/jetspeed) 也很容易配置。此外，请求 URL 可以映射到 portlet 管道。默认管道聚合 portlet 页面。Portlet 页面通常使用扩展名 .PSML 定义。如果未提供页面，则可以配置默认页面。

### 7.4.1. **流水线驱动处理**

对门户的请求始终通过门户 URL 进入。Jetspeed 有 URI 入口点。servlet 上下文 (/jetspeed) 也很容易配置。此外，请求 URL 可以映射到 portlet 管道。默认管道聚合 portlet 页面。Portlet 页面通常使用扩展名 .PSML 定义。如果未提供页面，则可以配置默认页面。

![](file:///C:\Users\johnfeng\AppData\Local\Temp\ksohtml11556\wps91.png)

### 7.4.2. **管道架构**

在 Jetspeed-2 中，请求是通过一系列组装在一起的 Valve 作为管道处理的。

![](file:///C:\Users\johnfeng\AppData\Local\Temp\ksohtml11556\wps92.png)

### 7.4.3. **管道映射**

管道映射允许将 / 上下文路径 + servlet 路径的前缀映射映射到管道。例如：

/jetspeed/portal --> Jetspeed 管道

/jetspeed/ajax --> Ajax 管道

/jetspeed/portlet --> Portlet 管道

/jetspeed/fileserver/file.pdf --> 文件 Servlet 管道

/jetspeed/fileserver.file.html --> 文件 Servlet 管道

/jetspeed/desktop --> 桌面管道

### 7.4.4. **管道映射配置**

管道映射配置可以在 中找到**/WEB-INF/assembly/pipelines.xml**。

<bean id='管道图'

    类='java.util.HashMap'>

<构造函数参数>

    <地图>

        <入口键='/portlet'>

            <value>portlet 管道</value>

        </entry>            

        <入口键='/门户'>

            <value>jetspeed-管道</value>

        </entry>

        <入口键='/ajaxapi'>

            <value>ajax 管道</value>

        </entry>

        <入口键='/登录'>

            <value>jetspeed-管道</value>

        </entry>            

        <入口键='/文件服务器'>

            <value>文件服务器管道</value>

        </entry>

        <入口键='/ajax'>

            <value>ajax 直接管道</value>

        </entry>

        <入口键='/桌面'>

            <value>桌面管道</value>

				<!-- 对于 jetspeed 桌面，/desktop、/action 和 /render 键不能更改 -->

				<!-- 无需编辑 src/webapp/javascript/jetspeed/common.js 和这些 bean：-->

				<!-- JetspeedDesktop bean 需要 /desktop 的参数（构造函数中的第三个参数）-->

				<!-- DesktopPluto bean 需要 /desktop、/action 和 /render 的参数 -->

				<!-- DesktopPortalURL bean 需要 /render 和 /action 的参数 -->

				<!-- desktopEncoderRedirectValve bean 需要 /desktop 和 /render 的参数 -->

        </entry>            

        <入口键='/动作'>

            <value>桌面操作管道</value>

        </entry>

        <入口键='/渲染'>

            <value>桌面渲染管道</value>

        </entry>

        <入口键='/配置'>

            <value>配置管道</value>

        </entry>            

        <入口键='/dtconfigure'>

            <value>dtconfigure-pipeline</value>

        </entry>                        

        <entry key='/healthcheck'>

            <value>健康检查管道</value>

        </entry>

    </地图>        

</constructor-arg>        
</豆>

### 7.4.5. **管道阀门**

阀门是管道工作流程中的工作单元。通常，阀门代表对 Jetspeed 功能或组件的访问，例如聚合、安全、动作处理或设备功能。

![](file:///C:\Users\johnfeng\AppData\Local\Temp\ksohtml11556\wps93.png)

Jetspeed 管道有一个与整个请求管道相关联的请求上下文。使用请求上下文 API，阀门可以向管道请求过程添加或检索信息位。


| **阀门**    | **描述**                                                                                                                                                    |
| ----------- | ----------------------------------------------------------------------------------------------------------------------------------------------------------- |
| 能力阀      | 为请求上下文标识浏览器的能力映射、字符编码、媒体和Mime类型，在响应中设置内容类型。                                                                          |
| 门户URL阀门 | 使用导航状态组件从请求URL和参数创建内部门户 URL。                                                                                                           |
| 安全阀      | 为请求构建Java安全主题，并在特权操作下为此请求运行所有剩余的阀门，启用针对默认 Jetspeed (JAAS) 安全策略或其他标准 JAAS 策略（如果已配置）的 Java 安全检查。 |
| 定位阀      | 将语言环境(java.util.Locale)设置为 Java 标准国际化支持的请求上下文。                                                                                        |
| 探查阀      | 使用Profiler、站点管理器和页面管理器组件来定位请求的页面和菜单“站点”导航。                                                                                |
| 动作阀      | 确定请求中的目标操作窗口，如果找到，则通过portlet容器执行操作。这是标准的“动作阶段”，阻止所有渲染。在动作阶段完成时，动作阀重定向回门户以处理渲染阶段。   |
| 装饰阀      | 构建页面和所有portlet窗口上可用的操作。                                                                                                                     |
| 集料阀      | 执行标准的“渲染阶段”，在此实际渲染所有 portlet 和页面装饰。                                                                                               |
| 台式阀门    | 渲染Jetspeed桌面的骨架。所有桌面 portlet 呈现都在客户端通过 javascript 和 portlet 管道进行控制。                                                            |
| 台式动作阀  | 在一个请求的范围内执行Jetspeed Desktop操作。客户端桌面控制动作阶段的执行，然后是后续的渲染阶段，实现客户端的并行处理。                                      |

## 7.5. [**探查器**](https://portals.apache.org/jetspeed-2/deployguide/guide-profile.html)

Jetspeed Profiler 是一个基于门户资源定位规则的引擎。探查器定位以下类型的门户资源：

· PSML 页面

· 文件夹

· 菜单

当门户收到请求时，分析器将根据一组规范化的运行时参数和状态（例如请求参数、HTTP 标头和会话属性）将请求映射到资源。Profiler 在 Profiler Valve 中的 Jetspeed 请求处理管道期间被调用。此阀门要求请求上下文已填充门户请求和响应、功能、语言和用户信息。运行时参数构成分析器用来定位门户资源的分析标准。分析器与站点和页面管理器组件协同工作。

### 7.5.1. **Profiler 规则和规则标准**

分析规则定义了在评估请求以确定特定资源的位置时使用的标准列表。概要分析器使用概要分析规则来根据已知 portlet 请求数据的解耦标准一般地定位门户资源。规则由应按给定顺序应用的标准的有序列表组成。按照此规则的顺序，分析引擎使用不太具体的算法应用规则的每个标准，直到考虑到最不具体的资源标准。当所有条件都用尽时，规则将失败并且需要备用资源。

规则标准是用于定位配置文件属性的模板。Jetspeed 有一个基于资源特定 URL、Mime 类型和语言偏好的分析策略。更复杂的实现将需要在映射到资源时使用其他输入，例如 Cookie、IP 地址范围、统计资源使用分析、servlet 或 EJB 内部的业务规则……

### 7.5.2. **解析器**

解析器是尝试匹配条件以查找资源的 Java 类。Jetspeed 提供了几个“开箱即用”的解析器。


| 要求            | 匹配请求参数                        |
| --------------- | ----------------------------------- |
| 会议            | 匹配会话参数                        |
| 小路            | 将URL的路径部分与 PSML 页面匹配     |
| 硬编码          | 硬编码值，例如“default-page.psml” |
| 用户            | 匹配当前认证用户的名字              |
| 媒体类型        | 匹配媒体类型（HTML，XHTML ..）      |
| 语言            | 浏览器的首选语言                    |
| 国家            | 浏览器首选国家代码                  |
| 用户属性        | 匹配命名用户属性（Portlet API）     |
| 用户代理        | 代理（浏览器）的名称                |
| 主机名          | 匹配URL中的主机名                   |
| 导航            | 指令：移动算法以在新位置开始搜索    |
| group.role.user | 使用回退算法                        |

### 7.5.3. **PSML 页面**

Profiler 搜索 PSML 页面的目录树，试图找到要显示的 PSML 页面。默认情况下，此目录结构位于**/WEB-INF/pages**. “目录”也可以存储在数据库中。探查器已知几个系统目录：


| \_用户         | 保存所有用户特定的页面。           |
| -------------- | ---------------------------------- |
| \_角色         | 包含所有特定于角色的页面。         |
| \_团体         | 保存所有特定于组的页面。           |
| \_subsite-root | 包含完整的子站点树，就像根树一样。 |

![](file:///C:\Users\johnfeng\AppData\Local\Temp\ksohtml11556\wps94.png)

### 7.5.4. **提供的通用探查器规则**


| J1           | 使用Jetspeed-1中最具体到最不具体的算法（页面路径 + 用户 + 媒体类型 + 语言 + 国家/地区） |
| ------------ | --------------------------------------------------------------------------------------- |
| J2           | 默认。查看与用户+媒体相结合的 URL 路径。（页面路径 + 用户 + 媒体类型）                  |
| 角色后备     | 在给定用户的每个角色目录中查找页面。                                                    |
| 用户角色回退 | 在用户的主目录中查找页面，如果未找到，请在给定用户的每个角色目录中查找。                |
| 变体         | 路径、组回退、用户角色组合回退、子站点滚动回退。                                        |

### 7.5.5. **Profiler 组件配置**

profiler.xml Spring 配置文件配置分析器组件。


| **构造函数参数**                              | **描述**                                                                                |
| --------------------------------------------- | --------------------------------------------------------------------------------------- |
| (0) JETSPEED-INF/ojb/profiler\_repository.xml | 将OJB数据库保存到 POJO 映射器，用于将配置文件信息编组到持久存储区和从持久存储区中提取。 |
| (1) j1                                        | 默认分析规则。如果用户没有在关联表中定义分析规则，则使用此分析规则。                    |
| (2) ProfileResolvers (ref bean)               | 分析器解析器名称到实现解析器类的映射。应该将新的解析器添加到ProfileResolver表中。       |

## 7.6. [**登记处**](https://portals.apache.org/jetspeed-2/deployguide/guide-registry.html)

Portlet Registry 将 Portlet 部署描述符的全部内容持久保存在 Jetspeed 数据库中：

· portlet.xml

· jetspeed-portlet.xml（Jetspeed 特定的扩展）

部署 portlet 应用程序时，Jetspeed 使用这些 portlet 描述符中定义的定义更新注册表，包括：

· 一个 Portlet 应用程序定义

· 一个或多个 portlet 定义

· 支持的用户属性

· 支持的自定义 portlet 模式和窗口状态

### 7.6.1. **portlet.xml**

portlet.xml 是portlet 的Portlet API 描述符。该文件的全部内容被索引并存储在 Jetspeed 注册数据库中。典型内容包括：

· Portlet 名称、描述、显示名称

· 实现类

· 初始化参数

· 支持的 Mime 类型/模式

· 支持的语言环境

· 资源包信息/本地化（标题、关键字）

· 默认 Portlet 首选项

有关 portlet.xml 的更多信息，请参阅 Portlet 规范。

### 7.6.2. **jetspeed-portlet.xml**

jetspeed-portlet.xml 用于配置其他门户中没有的特定 Jetspeed 功能，例如并行渲染。jetpeed-portlet.xml 由一组扩展 portlet 应用程序定义的元素组成，然后是每个 portlet 的可重复部分（非常类似于 portlet.xml）。下面是一个示例 portlet 应用程序元素：

<js:security-constraint-ref>管理员[/js:security-constraint-ref](/js:security-constraint-ref)

<dc:title>Jetspeed-2 管理门户</dc:title>

<dc:title xml:lang="en">Jetspeed-2 管理门户</dc:title>

<dc:creator>J2 团队</dc:creator>

<js:metadata name="pa-version">2.2</js:metadata>
请注意，**dc:**前缀设置指的是 Dublin Core XML 模式。该**js:metadata**标记提供 portlet 应用程序的版本号。Jetspeed 的集群版本化[部署](https://portals.apache.org/jetspeed-2/deployguide/config-cluster.html)使用它来确定应用程序 WAR 的新版本何时可以部署。

此外，可以使用 js:security-constraint-ref 标记保护 portlet 应用程序，从而引用安全约束。 [安全约束](https://portals.apache.org/jetspeed-2/adminguide/constraints.html)允许您安全地保护整个 portlet 应用程序。例如，您可能希望在此应用程序中的所有 portlet 上要求“管理员”角色限制编辑模式。或者，您可能需要“开发者”角色来限制用户查看此应用程序中的 portlet。约束对 portlet 或应用程序的安全访问。

默认情况下，这些全局安全约束的渲染时检查被禁用。因此对于“查看”，如果具有适当权限的人已将 portlet 添加到用户可见的页面，则用户将能够查看（但只能查看）该 portlet。即使存在旨在阻止用户查看所有 portlet 实例的全局 portlet 级别约束，也会发生这种情况。因此，访问由 PSML 中的页面和片段以及对选择和添加 portlet 的控制来控制。

如果启用渲染时检查（默认值：false），则无论当前页面或片段如何，用户都无法访问以查看的 portlet 将不会被渲染，并且将渲染“拒绝访问”错误消息反而。要启用此功能，请更改 WEB-INF/assembly/aggregation.xml 中的 Spring 配置设置。找到 id="org.apache.jetspeed.aggregator.PortletRenderer" 的 bean，并将第 5 个构造函数参数元素从 false -> true 更改（另请参见 bean 定义中的内联注释）

<!-- Portlet 渲染器 -->

<bean id="org.apache.jetspeed.aggregator.PortletRenderer"

class="org.apache.jetspeed.aggregator.impl.PortletRendererImpl"

init-method="start" destroy-method="stop">

<meta key="j2:cat" value="default" />

<构造函数参数>

<ref bean="org.apache.pluto.PortletContainer" />

</constructor-arg>

<构造函数参数>

<ref bean="org.apache.jetspeed.aggregator.WorkerMonitor" />

</constructor-arg>

<构造函数参数>

<ref bean="PortalStatistics" />

</constructor-arg>

<构造函数参数>

<ref bean="org.apache.jetspeed.aggregator.PortletTrackingManager" />

</constructor-arg>

<!-- 指示是否检查 jetspeed-portlet.xml 安全性的标志

约束

在呈现 portlet 之前。如果安全检查失败，不显示

portlet 内容

-->

<constructor-arg type="boolean">

<值>真</值>

</constructor-arg>

<构造函数参数>

<ref bean="org.apache.jetspeed.security.SecurityAccessController" />

</constructor-arg>

<构造函数参数>

<ref bean="portletContentCache" />

</constructor-arg>

</豆>

Portlet 也可以在**jetspeed-security.xml**文件中进一步定义。该**portlet-name**标记允许我们映射回主**portlet.xml**文件，按名称匹配 portlet。同样，我们有一个 js:security-constraint-ref 标签。这一次，我们只为一个 portlet 分配了一个安全约束。此约束覆盖 portlet 应用程序范围的安全约束标记。我们也有类似的都柏林核心标签用于扩展元数据。

<portlet>

    <portlet-name>登录Portlet</portlet-name>

    <js:security-constraint-ref>公共视图</js:security-constraint-ref>

    <dc:title>登录 Portlet</dc:title>

    <dc:creator>J2 团队</dc:creator>

</portlet>
另一个设置是 Jetspeed Customizer 的 Portlet Selector 功能的提示：

            <js:metadata name="selector.conditional.role">管理员</js:metadata>
将 name 属性设置为 的 js:metadata 标记**selector.conditional.role**意味着只有具有命名角色的用户 **admin**才能在 portlet 选择器中看到此 portlet。所有其他用户将不会在选择器中看到此 portlet。通过将条件角色设置为**\***，您是在告诉 Jetspeed 该 portlet 永远不应出现在 portlet 选择器中。

[jetspeed.properties](https://portals.apache.org/jetspeed-2/deployguide/jetspeed-properties.html)文件中有一个全局设置，允许您将 servlet 请求参数与 portlet 参数合并。这在需要共享呈现参数的 Portlet 1.0 应用程序中很有用，或者如果您需要在极少数情况下通过 URL 与您的 portlet 通信。此全局功能也可通过**merge.portal.parameters.with.portlet.parameters**设置在每个 portlet 的基础上使用。下面的第二行，**merge.portal.parameters.before.portlet.parameters** 简单的判断servlet参数是在portlet参数之前还是之后合并

     <js:metadata name="merge.portal.parameters.with.portlet.parameters">true</js:metadata>

     <js:metadata name="merge.portal.parameters.before.portlet.parameters">true</js:metadata>
当您在某些框架中拥有 portlet 时，它们可能会在应该提交呈现导航时提交操作。如果是这种情况，我们认为这种非标准的动作行为。在这种情况下，我们不希望缓存的 portlet 在浏览 portlet 时需要刷新。为了解决这个问题，我们有**nonStandardAction**设置。

<js:metadata name="nonStandardAction">true[/js:metadata](/js:metadata)

Jetspeed 允许您在 jetspeed-portlet.xml 中定义映射窗口状态。在下面的示例中，我们将名为的窗口状态映射到名为**popup**的现有窗口状态**solo**。请注意，此设置适用于 portlet 应用程序。

<自定义窗口状态>

  <name>弹出窗口</name>

  <mapped-name>独奏</mapped-name>

</自定义窗口状态>
最后，为了启用[并行渲染](https://portals.apache.org/jetspeed-2/deployguide/guide-aggregation.html)，您可以设置元数据属性**timeout**。该值以毫秒为单位。它有两个用途：(1) 它的存在启用并行渲染，以及 (2) 该值确定 Jetspeed 在超时和放弃渲染 Portlet 之前将给予该 portlet 多长时间来完成渲染。

<js:metadata name="timeout">3000[/js:metadata](/js:metadata)

还可以使用 Dublin Core 将扩展元数据添加到 portlet。此元数据符合[都柏林核心** DCMI **格式](http://dublincore.org/) DCMI 允许扩展元数据，包括本地化数据，例如：

<dc:title>标题 1[/dc:title](/dc:title)

<dc:title xml:lang="en">英文标题</dc:title>

<dc:title xml:lang="fr">Fr 标题</dc:title>

<dc:subject xml:lang="sp">西班牙语主题</dc:subject>

<dc:creator>默认杰里米·福特</dc:creator>

<dc:coverage>默认覆盖率</dc:coverage>

<dc:contributor>默认贡献者</dc:contributor>

<dc:description>默认说明</dc:description>

<dc:format>默认格式</dc:format>

<dc:identifer>默认标识符</dc:identifer>

<dc:language>默认语言</dc:language>

<dc:publisher>默认发布者</dc:publisher>

<dc:relation>默认关系</dc:relation>

<dc:right>默认权限</dc:right>

<dc:source>默认来源</dc:source>

<dc:type>默认类型</dc:type>
### 7.6.3. **服务**

jetspeed-portlet.xml 也用于定义所需的 Jetspeed 服务。如果您的 portlet 需要[Jetspeed 服务](https://portals.apache.org/jetspeed-2/deployguide/guide-services.html)，它必须在描述符中按名称引用该服务，例如：

<js:服务>        

    <js:service name='ApplicationServerManager'/>

    <js:service name='DeploymentManager'/>

	<js:service name='EntityAccessor'/>

    <js:service name='GroupManager'/>    

    <js:service name='PageManager'/>    

</js:服务>
### 7.6.4. **注册管理**

Jetspeed 提供了几个注册表管理 portlet：

· [Portlet 应用程序管理器](https://portals.apache.org/jetspeed-2/adminguide/pam.html)

· [Portlet 应用程序生命周期管理器](https://portals.apache.org/jetspeed-2/adminguide/palm.html)

## 7.7. [**搜索**](https://portals.apache.org/jetspeed-2/deployguide/guide-search.html)

Jetspeed-2 提供与流行的 Apache Lucene 搜索引擎和 Apache Solr 搜索引擎的集成，高性能、全功能的文本搜索引擎库；适用于几乎所有需要全文搜索的应用程序的技术，尤其是跨平台的应用程序。您可以在 Jetspeed-2 中嵌入基于 Solr 的搜索引擎组件，也可以通过 http 连接连接到外部 Solr 引擎。默认情况下，使用基于 Apache Lucene 的搜索引擎组件，但您可以通过复制备用 Spring xml 配置文件之一轻松切换到基于 Solr 的搜索引擎组件。

默认情况下，Jetspeed-2 索引所有注册表信息：作为可搜索实体的 portlet 实例和 portlet 定义。

### 7.7.1. **基于 Lucene 的默认搜索引擎配置**

搜索引擎的配置位于 Spring 配置文件**search.xml** 中 您可以在此 Spring 配置文件中配置搜索索引的位置。请注意，您可能希望将索引的位置移到 Jetspeed Web 应用程序之外

<bean id="org.apache.jetspeed.search.SearchEngine"

class="org.apache.jetspeed.search.lucene.SearchEngineImpl"
<constructor-arg index="0"><value>${applicationRoot}/WEB-INF/search_index</value></constructor-arg>

……
### 7.7.2. **基于嵌入式 Solr 的搜索引擎配置**

如果将 /WEB-INF/assembly/alternate/search-embedded-solr-override.xml 复制到 /WEB-INF/assembly/override/ 文件夹，则可以切换到基于嵌入式 Solr 的搜索引擎组件，而不是默认的基于 Lucene一。

……

<bean id="org.apache.solr.core.CoreContainer" class="org.apache.solr.core.CoreContainer" destroy-method="shutdown">

<meta key="j2:cat" value="默认或搜索" />

<constructor-arg value="${search.embedded.solr.solr.home}" />

<构造函数参数>

  <bean class="java.io.File">

    <meta key="j2:cat" value="默认或搜索" />

    <constructor-arg value="${search.embedded.solr.solr.home}/solr.xml" />

  </豆>

</constructor-arg>
</豆>

<bean id="org.apache.solr.client.solrj.SolrServer" class="org.apache.solr.client.solrj.embedded.EmbeddedSolrServer" 依赖于="_embeddedSolrDataDirPropSetter">

<meta key="j2:cat" value="默认或搜索" />

<constructor-arg ref="org.apache.solr.core.CoreContainer" />

<constructor-arg value="js" />
</豆>

<bean id="org.apache.jetspeed.search.SearchEngine" class="org.apache.jetspeed.search.solr.SolrSearchEngineImpl">

<meta key="j2:cat" value="默认或搜索" />

<constructor-arg ref="org.apache.solr.client.solrj.SolrServer" />

<constructor-arg type="boolean" value="${search.index.optimizeAfterUpdate}" />

<constructor-arg ref="org.apache.jetspeed.search.HandlerFactory" />
</豆>

在上面的示例配置中，基于嵌入式 Solr 的搜索引擎组件将按照 /WEB-INF/conf/jetspeed.properties 中的属性配置来初始化搜索索引：

# 您可以选择配置嵌入式 solr 主目录和数据目录路径

# 如果你启用嵌入式 solr 而不是默认的 lucene

search.embedded.solr.solr.home=${applicationRoot}/WEB-INF/solr

search.embedded.solr.data.dir=${applicationRoot}/WEB-INF/solr/data

Solr 配置位于 /WEB-INF/solr 目录中。为了获得更多可扩展性，它以多核设置的形式提供，如下所示：

<solr 持久=“真”>

<cores adminPath="/admin/cores">

<core name="js" instanceDir="js"></core>
</核心>

</solr>                    

### 7.7.3. **基于外部 Solr 的搜索引擎配置**

如果将 /WEB-INF/assembly/alternate/search-http-solr-override.xml 复制到 /WEB-INF/assembly/override/ 文件夹，则可以切换到基于外部 Solr 的搜索引擎组件，而不是默认的基于 Lucene一。

……   

<bean id="org.apache.solr.client.solrj.SolrServer" class="org.apache.solr.client.solrj.impl.CommonsHttpSolrServer">

<meta key="j2:cat" value="默认或搜索" />

<constructor-arg value="${search.http.solr.url}" />

<property name="soTimeout" value="1000" />

<property name="connectionTimeout" value="100" />

<property name="defaultMaxConnectionsPerHost" value="100" />

<property name="maxTotalConnections" value="100" />

<property name="followRedirects" value="false" />

<property name="allowCompression" value="true" />

<property name="maxRetries" value="1" />

<属性名称="解析器">

  <bean class="org.apache.solr.client.solrj.impl.XMLResponseParser">

    <meta key="j2:cat" value="默认或搜索" />

  </豆>

</属性>
</豆>

<bean id="org.apache.jetspeed.search.SearchEngine" class="org.apache.jetspeed.search.solr.SolrSearchEngineImpl">

<meta key="j2:cat" value="默认或搜索" />

<constructor-arg ref="org.apache.solr.client.solrj.SolrServer" />

<constructor-arg type="boolean" value="${search.index.optimizeAfterUpdate}" />

<constructor-arg ref="org.apache.jetspeed.search.HandlerFactory" />
</豆>

……

在上面的示例配置中，基于 Solr 的搜索引擎组件将连接到 /WEB-INF/conf/jetspeed.properties 中的属性配置的外部 Solr 引擎：

# 您可以选择配置外部 solr http(s) url

# 注意：如果你有多核设置，你应该把核心名称放在最后。例如，'/js'。

search.http.solr.url=http://localhost:8983/solr/js

### 7.7.4. **基于 Solr 的搜索模式配置**

Jetspeed-2 的示例模式配置可以在 /WEB-INF/solr/js/conf/schema.xml 中找到。Jetspeed-2 至少需要以下字段：

<!-- 核心搜索字段 -->

<field name="fieldname.key" type="string" indexed="true" stored="true" required="true" />

<field name="fieldname.type" type="text" indexed="true" stored="true" required="false" />

<field name="fieldname.content" type="text" indexed="true" stored="false" required="false" />

<field name="fieldname.description" type="text" indexed="true" stored="true" multiValued="true" required="false" />

<field name="fieldname.title" type="text" indexed="true" stored="true" multiValued="true" required="false" />

<field name="fieldname.language" type="text" indexed="true" stored="true" multiValued="true" required="false" />

<field name="fieldname.fields" type="text" indexed="true" stored="false" multiValued="true" required="false" />

<field name="fieldname.keywords" type="string" indexed="true" stored="true" multiValued="true" required="false" />

<field name="fieldname.url" type="text" indexed="true" stored="true" multiValued="true" required="false" />

<field name="fieldname.score" type="text" indexed="true" stored="false" required="false" />

<field name="fieldname.className" type="text" indexed="true" stored="true" required="false" />

<field name="fieldname.synthetic" type="text" indexed="true" stored="false" required="false" />

<!-- 元数据搜索字段 -->

<field name="ID" type="string" indexed="true" stored="true" required="false" />

<field name="url" type="text" indexed="true" stored="true" required="false" />

<field name="portlet" type="string" indexed="true" stored="true" required="false" />

<field name="portlet_application" type="string" indexed="true" stored="true" required="false" />

<field name="title" type="string" indexed="true" stored="false" multiValued="true" required="false" />

<field name="description" type="string" indexed="true" stored="false" multiValued="true" required="false" />

<field name="subject" type="string" indexed="true" stored="false" multiValued="true" required="false" />

<field name="creator" type="string" indexed="true" stored="false" multiValued="true" required="false" />

<field name="publisher" type="string" indexed="true" stored="false" multiValued="true" required="false" />

<field name="contributor" type="string" indexed="true" stored="false" multiValued="true" required="false" />

因此，当您想使用外部 Solr 搜索引擎时，请确保应该像上面的示例一样正确配置架构。

如果您想要简单的步骤来测试基于外部 Solr 的搜索引擎组件，这里有一些简单的示例：

1. 将 /WEB-INF/assembly/alternate/search-http-solr-override.xml 复制到 /WEB-INF/assembly/override/ 文件夹。
2. 将 Solr 战争文件安装到 servlet 容器上。例如，将 solr.war 复制到 $CATALINA_HOME/webapps/。
3. 将示例 Solr 主目录和数据目录复制到要保留搜索索引的位置。例如，将 /jetspeed/WEB-INF/solr/ 目录复制到 /tmp/solr/。
4. 通过指定 Solr 主目录和数据目录来启动 servlet 容器。
5.
6. \$ export CATALINA\_OPTS="-Xmx256m -XX:MaxPermSize=128m -Dsolr.solr.home=/tmp/solr -Dsolr.data.dir=/tmp/solr/data"
7. 如果您没有再次部署 portlet 应用程序并且搜索索引没有刷新，那么重新部署所有 portlet 应用程序或刷新 Portlet Application Manager portlet 中每个 portlet 应用程序的搜索索引。

### 7.7.5. **搜索用户界面**

#### 7.7.5.1. **Portlet 应用程序管理器页面中的注册表应用程序列表 Portlet**

![](file:///C:\Users\johnfeng\AppData\Local\Temp\ksohtml11556\wps95.jpg)

#### 7.7.5.2. **Portlet 应用程序管理器页面中的应用程序详细信息 Portlet**

![](file:///C:\Users\johnfeng\AppData\Local\Temp\ksohtml11556\wps96.jpg)

您可以刷新每个应用程序的搜索索引。

## 7.8. [**服务**](https://portals.apache.org/jetspeed-2/deployguide/guide-services.html)

Jetspeed 为portlet 提供了一种从portlet 访问Jetspeed 组件或服务的方法。尽管这是 Jetspeed 特有的功能，但它是 Jetspeed 管理 portlet 如何与自定义 Jetspeed 一起工作的。例如，下面的组管理 portlet 使用 Jetspeed 服务来操作 Jetspeed 组。

所有服务必须由 Jetspeed 在 Spring 配置**jetspeed-services.xml**文件中导出。portlet 所需的所有服务都必须在**jetspeed-portlet.xml**.

需要 jetspeed 服务的 Portlet 应用程序在其**jetspeed-portlet.xml**部署描述符中引用该服务：

<js:服务>

<js:service name='ApplicationServerManager'/>

<js:service name='PageManager'/>

<js:service name='PermissionManager'/>

<js:service name='PortalAdministration'/>

<js:service name='UserManager'/>
[/js:服务](/js:%E6%9C%8D%E5%8A%A1)

应用程序可以在 portlet 初始化阶段获取服务，例如：

组管理器 = (组管理器)

getPortletContext().getAttribute(CommonPortletServices.CPS_GROUP_MANAGER_COMPONENT);


| **Spring中定义的主要 Jetspeed 服务（请参阅 jetspeed-services.xml 以获取完整列表）** |                                                                               |
| ----------------------------------------------------------------------------------- | ----------------------------------------------------------------------------- |
| **输入键**                                                                          | **参考豆**                                                                    |
| PortletRegistry组件                                                                 | org.apache.jetspeed.components.portletregistry.PortletRegistry                |
| 搜索组件                                                                            | org.apache.jetspeed.search.SearchEngine                                       |
| 帕姆                                                                                | 帕姆                                                                          |
| 用户管理器                                                                          | org.apache.jetspeed.security.UserManager                                      |
| 页面管理器                                                                          | org.apache.jetspeed.page.PageManager                                          |
| 角色管理器                                                                          | org.apache.jetspeed.security.RoleManager                                      |
| 组管理器                                                                            | org.apache.jetspeed.security.GroupManager                                     |
| 探查器                                                                              | org.apache.jetspeed.profiler.Profiler                                         |
| 单点登录                                                                            | org.apache.jetspeed.sso.SSOProvider                                           |
| 实体访问器                                                                          | org.apache.jetspeed.components.portletentity.PortletEntityAccessComponent     |
| 窗口存取器                                                                          | org.apache.jetspeed.container.window.PortletWindowAccessor                    |
| 应用服务器管理器                                                                    | org.apache.jetspeed.tools.pamanager.servletcontainer.ApplicationServerManager |
| 小门户工厂                                                                          | 小门户工厂                                                                    |
| 部署管理器                                                                          | 部署管理器                                                                    |
| 标识符生成器                                                                        | 标识符生成器                                                                  |
| 电动工具                                                                            | 电动工具                                                                      |
| 标头资源                                                                            | org.apache.jetspeed.headerresource.HeaderResourceFactory                      |
| 模板定位器                                                                          | 模板定位器                                                                    |
| 装修定位器                                                                          | 装修定位器                                                                    |
| 装饰厂                                                                              | 装饰厂                                                                        |
| 桌面                                                                                | Jetspeed桌面                                                                  |
| 权限管理器                                                                          | org.apache.jetspeed.security.PermissionManager                                |
| 门户统计                                                                            | 门户统计                                                                      |
| 门户管理                                                                            | 门户管理                                                                      |
| 偏好提供者                                                                          | org.apache.jetspeed.prefs.PreferencesProvider                                 |
| org.apache.jetspeed.container.session.PortalSessionsManager                         | org.apache.jetspeed.container.session.PortalSessionsManager                   |
| 安全访问控制器                                                                      | org.apache.jetspeed.security.SecurityAccessController                         |
| PortletTrackingManager                                                              | org.apache.jetspeed.aggregator.PortletTrackingManager                         |
| PortalAuthentication配置                                                            | org.apache.jetspeed.administration.PortalAuthenticationConfiguration          |
| 门户配置                                                                            | 门户配置                                                                      |
| 进口商经理                                                                          | 进口商CastorPageManager                                                       |
| 装饰内容缓存                                                                        | 装饰内容缓存                                                                  |
| portletContentCache                                                                 | portletContentCache                                                           |
| 审计活动                                                                            | org.apache.jetspeed.audit.AuditActivity                                       |
| JetspeedSerializerFactory                                                           | org.apache.jetspeed.serializer.JetspeedSerializerFactory                      |
| 密码编码服务                                                                        | org.apache.jetspeed.security.PasswordEncodingService                          |

## 7.9. **事务**

所有使用数据库的 Jetspeed 组件都是事务性的。本指南帮助您了解 Jetspeed 组件如何在 Spring 事务的上下文中连接在一起。在部署 Jetspeed 时，您可能需要修改一些事务性组件。本指南将帮助您了解如何在 Jetspeed 中配置事务 bean（服务）。

### 7.9.1. **春季交易**

事务允许您将多个操作分组到一个工作单元中，这些工作要么完全发生，要么完全没有发生。Jetspeed 利用 Spring Framework 使其组件具有事务性。Spring 框架提供了跨两个或多个 Jetspeed 组件执行事务所需的事务管理。Jetspeed 事务被配置为声明性事务。Jetspeed 目前不使用程序化交易。Spring 框架通过 Spring 的 AOP 框架提供声明式事务管理。Spring 提供了三种方式在 spring 配置中声明事务边界。

1. Spring 事务拦截器，Bean 包装
2. XML 声明的事务
3. 注释

Jetspeed 使用原始的 Spring 事务支持 (1)：使用事务拦截器包装 Jetspeed 组件。在 Java 中配置 bean 时，请注意任何使用数据库的 bean 都将使用事务包装器进行包装。事务通知在事务拦截器中处理。注入依赖项时，事务拦截器，而不是实际的 Jetspeed 服务实现，作为依赖项注入到其他 Jetpeed 服务中。

### 7.9.2. **通过拦截的声明性事务**

让我们举一个事务 Jetspeed 服务的例子：权限管理器服务。该服务在**security-managers.xml**文件中配置。第一个 bean 实际上是用**Impl**后缀命名的。这是因为这是**实现**bean：bean 名称**org.apache.jetspeed.security.impl.PermissionManagerImpl**与类同名。类属性表示实现类的类名。

第二个 bean 由 interface: 命名**org.apache.jetspeed.security.PermissionManager**。这个 bean 不是实际的 Permission 实现。bean 定义是一个事务代理：它是一个 bean 包装器或拦截器。将权限管理器连接到另一个 Jetspeed 服务时，请确保使用代理对象，而不是实际的实现。这确保了 Spring 中的声明式事务支持可以拦截对权限管理器的调用。

请注意，父 bean 是**baseTransactionProxy**. 这就是我们获得事务支持的方式：通过 Spring AOP 继承声明式代理事务的基本功能。

<!-- 安全性：权限管理器 -->

<bean id="org.apache.jetspeed.security.impl.PermissionManagerImpl"

   class="org.apache.jetspeed.security.impl.PermissionManagerImpl" />
<bean id="org.apache.jetspeed.security.PermissionManager" parent="baseTransactionProxy"

	名称="权限管理器" >

	<property name="proxyInterfaces">

		<value>org.apache.jetspeed.security.PermissionManager</value>

	</属性>

	<属性名称="目标">

		<ref bean="org.apache.jetspeed.security.impl.PermissionManagerImpl"/>

	</属性>

	<property name="transactionAttributes">

		<道具>			

			<prop key="remove*">PROPAGATION_REQUIRED</prop>

			<prop key="grant*">PROPAGATION_REQUIRED</prop>

			<prop key="revoke*">PROPAGATION_REQUIRED</prop>

			<prop key="grant*">PROPAGATION_REQUIRED</prop>

			<prop key="add*">PROPAGATION_REQUIRED</prop>

			<prop key="update*">PROPAGATION_REQUIRED</prop>

			<prop key="*">PROPAGATION_SUPPORTS</prop>

		</道具>

	</属性>
</豆>

有几个事务属性控制包装 bean 上事务的行为

· **proxyInterfaces** - 自动代理调用的接口名称。只有对该接口的调用才会被拦截。这确保了 Jetspeed 服务仅沿着 Jetspeed API 的接口契约相互交互。

· **target** - 为事务代理的 bean 的名称。在这种情况下，它是我们的权限管理器实现

· **transactionalAttributes** - 可以控制代理接口上方法行为的属性。方法被列为属性键并且可以包含通配符，例如所有以 . 开头的方法**add\***。然后标签的主体可以包含 PROPAGATION\_REQUIRED 或 PROPAGATION_SUPPORTS 关键字，以及下面描述的异常处理行为。

**需要事务传播**- 如果需要传播，则该方法必须是事务的一部分。如果在调用该方法时没有活动事务，则代理（拦截器）将立即启动事务。存储到持久数据库的方法通常被标记为需要传播。

**支持事务传播**- 如果仅支持传播，则该方法不需要成为事务的一部分。如果在调用该方法时没有活动事务，则代理（拦截器）不会启动事务。如果有一个事务处于活动状态，该方法将加入该事务。未使用必需或支持属性标记的方法将不参与事务。

**异常处理和回滚**- 事务也可以基于一个或多个异常类提交或回滚。在下面的示例中，我们使用**-**减号来表示任何**RegistrationExceptions**以 开头的方法上发生的任何事情**register\*** 都会导致事务**回滚**。相反，使用**+**加号会导致事务提交给给定的方法和异常。

    <property name="transactionAttributes">

        <道具>

            <prop key="register*">PROPAGATION_REQUIRED,-org.apache.jetspeed.administration.RegistrationException</prop>

        </道具>

    </属性>
### 7.9.3. **嵌套和连接事务**

当一个服务调用另一个服务时，事务可以嵌套。例如，用户注册 portlet 使用名为**registerUser**. 用户注册需要对权限管理器和用户管理器进行事务调用。事务从 Jetspeed 管理服务开始，调用权限管理器的 grantPermission 方法，然后调用用户管理器的 storeUser 方法。如果这些方法中的任何一个失败，整个事务都会回滚。如果所有方法都成功，则提交事务，如下所示。

![](file:///C:\Users\johnfeng\AppData\Local\Temp\ksohtml11556\wps97.png)

# 8. **PSML 配置**

## 8.1. [**内容和请求 URL 映射**](https://portals.apache.org/jetspeed-2/deployguide/guide-content-mapping-psml.html)

Jetspeed 门户实现请求 URL 映射功能以支持设计用于显示来自存储库或其他网站的内容的 portlet。这使得使用虚拟 PSML 页面和反映内容源的路径或 URL 结构的层次结构来增加门户 URL 空间成为可能。这些功能由门户中的[门户站点组件](#Portal_Site_Component)实现。

虽然访问和显示内容是 portlet 的责任，但[门户网站组件](#Portal_Site_Component)允许具有这些 portlet 的[动态页面](#Dynamic_Page)模板将内容呈现为门户页面。此外，请求 URL 被映射到内容访问路径，该路径作为请求属性传递给 portlet（请参阅[PortalReservedParameters.PATH\_ATTRIBUTE](https://portals.apache.org/jetspeed-2/apidocs/org/apache/jetspeed/PortalReservedParameters.html)和[PortalReservedParameters.CONTENT\_PATH\_ATTRIBUTE](https://portals.apache.org/jetspeed-2/apidocs/org/apache/jetspeed/PortalReservedParameters.html)）。默认情况下，PSML 中定义的匹配[具体页面首先由请求匹配。](#Page)如果不匹配，则由[Content Type Mapper对请求进行分类](#Content_and_Request_URL_Mapping_Configuration)使用门户网站组件注册的实现。如果请求 URL 被识别为内容请求，则提供的实现将请求 URL 分解为内容访问路径和内容类型。门户站点组件随后使用此信息来查找可以通过请求 URL 上的路径寻址的最具体的[动态页面。](#Dynamic_Page)通过在父 PSML[文件夹](#Folder)中搜索并匹配通配符、“*”、动态页面内容类型 来执行后备[动态页面选择。](#Dynamic_Page)

### 8.1.1. **内容和请求 URL 映射配置**

门户网站内容映射使用门户 Spring 配置中指定的 Content Type Mapper 实现进行配置（通常在 page-manager.xml 程序集文件中）。提供的实现使用 Perl 正则表达式模式匹配请求 URL，以确定内容和系统请求访问路径和动态页面内容类型。与其他门户配置一样，此对象可以替换为自定义实现，该实现可能利用外部存储库或网站信息对门户请求进行分类。

提供的示例内容类型映射器配置：

<bean id="org.apache.jetspeed.portalsite.PortalSiteContentTypeMapper"

   名称="portalSiteContentTypeMapper"

   class="org.apache.jetspeed.portalsite.impl.PortalSiteContentTypeMapperImpl">

   <!-- 内容类型映射 -->

   <constructor-arg index="0">

       <列表>

           <bean class="org.apache.jetspeed.portalsite.impl.ContentTypeMapping">

               <constructor-arg index="0"><value>\w[.](\w+)$</value></constructor-arg> <!-- 使用 $ 对于'$' -->

               <constructor-arg index="1"><value>$1</value></constructor-arg> <!-- 使用 $ 对于'$' -->

           </豆>

       </列表>

   </constructor-arg>

   <!-- 动态页面路径映射 -->

   <constructor-arg index="1">

       <列表>

           <bean class="org.apache.jetspeed.portalsite.impl.RequestPathMapping">

               <constructor-arg index="0"><value>/preview/</value></constructor-arg>

               <constructor-arg index="1"><value>/</value></constructor-arg>

           </豆>

           <bean class="org.apache.jetspeed.portalsite.impl.RequestPathMapping">

               <constructor-arg index="0"><value>.domain.com</value></constructor-arg>

               <constructor-arg index="1"><value>doc</value></constructor-arg>

               <constructor-arg index="2"><value>/(?:draft|scratch)/</value></constructor-arg>

               <constructor-arg index="3"><value>/pub/</value></constructor-arg>

           </豆>

       </列表>

   </constructor-arg>

   <!-- 系统页面路径映射 -->

   <constructor-arg index="2">

       <列表>

           <bean class="org.apache.jetspeed.portalsite.impl.RequestPathMapping">

               <constructor-arg index="0"><value>/preview/</value></constructor-arg>

               <constructor-arg index="1"><value>/</value></constructor-arg>

           </豆>

       </列表>

   </constructor-arg>

   <!-- 外部内容路径映射 -->

   <constructor-arg index="3">

       <列表>

           <bean class="org.apache.jetspeed.portalsite.impl.RequestPathMapping">

               <constructor-arg index="0"><value>[.](\w+)$</value></constructor-arg> <!-- 使用 $ 对于'$' -->

               <constructor-arg index="1"><value></value></constructor-arg>

           </豆>

       </列表>

   </constructor-arg>

   <!-- 启用内容类型回退 -->

   <constructor-arg index="4"><value>true</value></constructor-arg>
</豆>

上述配置指定了以下内容和请求 URL 映射：

· 内容类型取自请求 URL 文件扩展名。

· 通过去除“/preview”前缀来修改动态页面请求路径。

· 通过将“/draft”和“/scratch”前缀替换为“/pub”来修改针对“.domain.com”服务器的“doc”内容类型的动态页面请求路径。

· 具体的门户页面和文件夹请求路径（即系统页面）也通过剥离“/preview”前缀进行修改

· 内容页面内容访问路径类型是通过去除文件扩展名从请求 URL 构造的。

· 通配符动态页面内容类型回退已启用。

有关配置这些 Spring bean 的更多信息，请参阅以下类 的[javadoc ：](https://portals.apache.org/jetspeed-2/apidocs/index.html)

· [org.apache.jetspeed.portalsite.impl.ContentTypeMapping](https://portals.apache.org/jetspeed-2/apidocs/org/apache/jetspeed/portalsite/impl/ContentTypeMapping.html)

· [org.apache.jetspeed.portalsite.impl.PortalSiteContentTypeMapperImpl](https://portals.apache.org/jetspeed-2/apidocs/org/apache/jetspeed/portalsite/impl/PortalSiteContentTypeMapperImpl.html)

· [org.apache.jetspeed.portalsite.impl.RequestPathMapping](https://portals.apache.org/jetspeed-2/apidocs/org/apache/jetspeed/portalsite/impl/RequestPathMapping.html)

## 8.2. [**菜单**](https://portals.apache.org/jetspeed-2/deployguide/guide-menus-declarative-psml.html)

声明性菜单用于在显示的门户页面中添加新的或自定义默认导航元素。这些 PSML 声明是[页面](#Page)和[文件夹](#Folder)元素的一部分。与其他 PSML 元素一样，可用于给定页面的有效菜单声明是在页面中明确定义的以及在父文件夹中定义的所有菜单声明。因此，全局站点菜单在与站点根文件夹关联的 PSML 中定义。特定页面或文件夹中的菜单定义会覆盖在父文件夹中找到的同名菜单。

门户布局装饰器在呈现门户内容时按名称访问页面菜单声明。菜单用于创建动态导航窗格、门户页面选项卡、面包屑链接和下拉菜单。Portal 站点组件负责用站点中的页面特定 PSML 元素充实动态菜单定义选项。例如，在构建门户页面时，全局菜单声明通常会涉及以下事件序列：

1. 门户布局装饰器将按名称请求菜单定义，
2. 该定义将由当前页面继承并位于根文件夹 PSML 中，
3. 门户网站组件将解释当前页面上下文中的菜单定义并填充[页面](#Page)、[文件夹](#Folder)和[链接](#Link)菜单选项，
4. 装饰器将菜单定义本身的菜单渲染标题和文本以及计算的菜单选项显示到门户导航内容中。

门户网站组件内部支持的默认全局菜单声明不需要在网站的任何页面或文件夹 PSML 元素中显式定义：

· **pages**：用于定义门户上方页面选项卡的相关页面菜单。

· **面包屑**：用于在页面选项卡下方提供历史链接的页面路径。

· **导航**：用于定义门户旁边的导航窗格的相关子文件夹和根级链接菜单。

· **back**：父文件夹菜单，用于定义门户页面选项卡上方的单个“返回”链接。

正如人们所期望的那样，这些内置菜单定义可以通过在站点 PSML 中声明具有相同名称的菜单来覆盖。

本指南的其余部分提供了有关在 Jetspeed2 中指定和使用声明性菜单定义的更多信息：

· [菜单定义](#Menu_Definition)

o [选项](#Menu_Options_Definition)

o [分隔器](#Menu_Separator_Definition)

o [包括](#Menu_Include_Definition)

o [排除](#Menu_Exclude_Definition)

· [页面布局装饰器](#Page_Layout_Decorators)

· [门户网站组件](#Portal_Site_Component)

· [PSML 文档 DTD](#PSML_DTDs)

### 8.2.1. **菜单定义**

<menu> 元素定义布局装饰器使用的菜单或另一个菜单中的嵌套菜单。菜单元素有许多有效的属性：


| **属性**   | **描述**                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      |
| ---------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| 姓名       | 标识用于从模板代码和/或菜单引用中检索的菜单名称。此属性对于顶级节点是必需的，对于嵌套菜单将被忽略。                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           |
| 选项       | 如果此菜单指定了文档和文件夹的深度包含，则指定此菜单的根文档路径。此属性还可以定义指定页面、文件夹或链接菜单选项的文档路径。此属性中指定的路径是[Page URIs](#Portal_Site_Component)；这些URI可能直接反映文件夹和页面层次结构，也可能不直接反映。门户网站[组件](#Portal_Site_Component)将这些选项路径映射到PSML文件夹和页面元素。多个选项路径可以指定为逗号分隔的路径列表和/或正则表达式模式。相对路径被解释为相对于当前页面。特殊模式“~”或“@”可用于引用当前页面。可以使用以下特殊模式之一在选项中引用当前页面路径的元素：“@0”、“@1”..“@N”或“@$”。'@0' 模式被替换为整个当前路径，（修剪前导和尾随分隔符）。'@N' 模式被替换为当前路径的第 N 个（基于一个的索引）路径元素。最后，'@$' 模式被当前路径的最后一个元素（通常是页面名称）替换。最后，特殊模式' +' 可用于引用定义菜单的文件夹的修剪路径，（如果菜单是在页面或模板上定义的，则使用父文件夹路径）。此模式可用于将菜单“固定”到特定文件夹。 |
| 深度       | 指定深度包含来自选项文件夹的文档，（深度< 0指定无限深度）。创建菜单选项以表示站点中的每个可见页面或链接；文件夹将转换为受此设置约束的嵌套菜单。                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               |
| 路径       | 启用“路径”扩展选项的布尔属性：扩展指定选项以包括从根到指定选项的路径。例如，如果将选项指定为“/folder/page.psml”，则设置此属性将导致菜单包含“/”、“/folder”和“/folder/page.psml”选项。此设置通常用于生成“历史”或“面包屑”菜单。                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |
| 正则表达式 | 布尔属性指定是否对选项值执行通配符/正则表达式处理。支持文件系统命令行正则表达式语法。                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         |
| 轮廓       | 评估选项值时要使用的配置文件定位器的指定名称。此属性还设置选项和嵌套菜单的默认配置文件值。指定“*”强制接受所有配置文件定位器名称；这可用于覆盖父菜单选择配置文件名称。                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |
| 命令       | 与列表或正则表达式文档路径值匹配的正则表达式模式的逗号分隔列表，以确定匹配选项的顺序。此属性将作为任何选项元素的默认选项值应用，但不用于重新排序多个选项子匹配项。如果未指定，则在底层文件夹文档排序返回的顺序中包含多个选项。此属性不匹配的选项路径将附加在有序匹配之后。                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |
| 皮肤       | 菜单的可选装饰器定义的布局提示。此属性还用作选项和嵌套菜单的默认外观值。Jetspeed2装饰器当前不使用此提示。                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     |

<menu> 元素包含许多其他菜单定义 PSML 元素。除了标题和元数据元素之外，这些元素的相对顺序决定了布局装饰器呈现它们的顺序：


| **元素**                             | **描述**                                                                                                                                                                 |
| -------------------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------ |
| 标题？                                 | 简单元素文本为菜单指定默认的独立于区域设置的标题。菜单的标题被认为是它的长描述，并且如果短标题可用于菜单文本，则在某些装饰器中用作翻转文本。如果未指定，将使用菜单名称。 |
| 短标题？                               | 简单元素文本为菜单指定默认的独立于语言环境的短标题。短标题（如果可用）在某些装饰器中用作菜单文本。如果未指定，则使用标题文本。                                           |
| [元数据](#PSML_Titles_and_Metadata)\*  | （可选）指定其他特定于区域设置的标题和短标题。                                                                                                                           |
| [选项](#Menu_Options_Definition)\*     | 此有序菜单元素指定此菜单定义的内容元素。                                                                                                                                 |
| [分隔符](#Menu_Separator_Definition)\* | 一个有序的菜单元素，用于指定要包含在此菜单定义中的内联文本行。                                                                                                           |
| 菜单\*                                 | 另一个用于定义包含在此菜单定义中的嵌套菜单的有序菜单元素。                                                                                                               |
| [包括](#Menu_Include_Definition)\*     | 指定要嵌套在其中的菜单或要包含在此菜单定义中的另一个菜单的选项。要包含的菜单的名称是此有序菜单元素的文本。                                                               |
| [排除](#Menu_Exclude_Definition)\*     | 指定要从该菜单定义中排除的另一个菜单的选项和嵌套菜单。包含要排除的元素的菜单的名称是此有序菜单元素的文本。                                                               |

例子：

<!-- 由2页组成的简单菜单-->

<菜单名称=“简单”>

<options>/some-top-page.psml,/custom/some-other-page.psml</options>
</菜单>

<!-- 前 2 层的站点菜单：文件夹导致嵌套菜单 -->

<menu name="top-2-levels" options="/" depth="2" skin="dhtml-pull-down"/>

<!-- 包含按角色描述的顶级元素的菜单 -->

<menu name="top-role-pages" regexp="true" options="/*" profile="roles"/>

<!-- 演示元素语法的人为示例 -->

<menu name="top-custom">

<title>顶部菜单</title>

<metadata name="title" xml:lang="fr">Haut</metadata>

<options regexp="true" profile="groups">/group-pages/*</options>

<菜单选项="/" 个人资料="页面">

    <分隔符>

        <text>-- 热门页面--</text>

        <title>首页</title>

    </分隔符>

    <options regexp="true">/*</options>

    <分隔符>

        <title>自定义页面</title>

    </分隔符>

    <options depth="2">/custom-folder/</options>

</菜单>

<exclude>顶级角色页面</exclude>

<separator>更多首页</separator>

<include nest="true">顶级角色页面</include>
</菜单>

门户网站组件内部支持的默认全局菜单声明的定义：

<!-- 标准页面标签菜单 -->

<menu name="pages" regexp="true" options="*.psml"/>

<!-- 标准历史面包屑菜单 -->

<menu name="breadcrumbs" options="~" paths="true"/>

<!-- 标准导航面板菜单 -->

<菜单名称="导航">

<separator>文件夹</separator>

<options regexp="true">./*/</options>

<include>页面导航</include>

<separator>附加链接</separator>

<options regexp="true">/*.link</options>

</菜单>

<!-- 标准父文件夹链接菜单 -->

<menu name="back" options="../"/>

请注意，这些定义的分隔符文本是在内部本地化的。

### 8.2.2. **菜单选项定义**

[<options> 元素在菜单](#Menu_Definition)中 定义一个或多个选项。这个简单元素的文本指定产生页面、文件夹或链接菜单选项的文档路径。此元素中指定的路径是[Page URIs](#Portal_Site_Component)；这些 URI 可能直接反映文件夹和页面层次结构，也可能不直接反映。门户网站[组件](#Portal_Site_Component)将这些选项路径映射到 PSML 文件夹和页面元素。多个选项路径可以指定为逗号分隔的路径列表和/或正则表达式模式。相对路径被解释为相对于当前页面。特殊模式“~”或“@”可用于引用当前页面。可以使用以下特殊模式之一在选项中引用当前页面路径的元素：“@0”、“@1”..“@N”或“@$”。'@0' 模式被替换为整个当前路径，（修剪前导和尾随分隔符）。'@N' 模式被替换为当前路径的第 N 个（基于一个的索引）路径元素。最后，'@$' 模式被当前路径的最后一个元素（通常是一页）替换。


| **属性**   | **描述**                                                                                                                                                                                                                                                                   |
| ---------- | -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| 深度       | 指定深度包含来自选项文件夹的文档，（深度< 0指定无限深度）。创建菜单选项以表示站点中的每个可见页面或链接；文件夹将转换为受此设置约束的嵌套菜单。                                                                                                                            |
| 路径       | 启用“路径”扩展选项的布尔属性：扩展指定选项以包括从根到指定选项的路径。例如，如果将选项指定为“/folder/page.psml”，则设置此属性将导致菜单包含“/”、“/folder”和“/folder/page.psml”选项。此设置通常用于生成“历史”或“面包屑”菜单。                                 |
| 正则表达式 | 布尔属性指定是否对选项值执行通配符/正则表达式处理。支持文件系统命令行正则表达式语法。                                                                                                                                                                                      |
| 轮廓       | 评估选项值时要使用的配置文件定位器的指定名称。此属性还设置选项和嵌套菜单的默认配置文件值。指定“*”强制接受所有配置文件定位器名称；这可用于覆盖父菜单选择配置文件名称。                                                                                                    |
| 命令       | 与列表或正则表达式文档路径值匹配的正则表达式模式的逗号分隔列表，以确定匹配选项的顺序。此属性将作为任何选项元素的默认选项值应用，但不用于重新排序多个选项子匹配项。如果未指定，则在底层文件夹文档排序返回的顺序中包含多个选项。此属性不匹配的选项路径将附加在有序匹配之后。 |
| 皮肤       | 菜单选项的可选装饰器定义的布局提示。如果此处未指定此提示，则每个页面、文件夹或链接的皮肤属性值将用于填充菜单选项。否则，将使用包含菜单中的皮肤提示。Jetspeed2装饰器当前不使用此提示。                                                                                      |

例子：

<菜单>

...

<options regexp="true" order="*.psml,*.link">/some-top-page.psml,/custom/some-other-page.psml,/*.link</options>

...
</菜单>

### 8.2.3. **菜单分隔符定义**

<separator> 元素定义要包含在[菜单](#Menu_Definition)中的分隔符。[只有在菜单定义中的选项](#Menu_Options_Definition)或嵌套菜单下面出现在此元素下面的选项或嵌套菜单时，将包含分隔符。分隔符的文本可以在此元素的包含文本或文本菜单定义元素中指定。分隔符元素只接受一个属性：


| **属性** | **描述**                                                                |
| -------- | ----------------------------------------------------------------------- |
| 皮肤     | 菜单分隔符的可选装饰器定义的布局提示。Jetspeed2装饰器当前不使用此提示。 |

<separator> 元素包含许多其他菜单定义 PSML 元素：


| **元素**                            | **描述**                                                                                                                                                   |
| ------------------------------------- | ---------------------------------------------------------------------------------------------------------------------------------------------------------- |
| 标题？                                | 简单元素文本为分隔符指定默认的独立于区域设置的标题。分隔符的标题被认为是它的长描述，如果分隔符文本可用，则在某些装饰器中用作翻转文本。                     |
| 文本？                                | 简单元素文本为分隔符指定默认的独立于区域设置的文本。所需的分隔符文本，无论是由该属性指定还是作为分隔符元素的包含文本，都是由布局装饰器插入到菜单中的文本。 |
| [元数据](#PSML_Titles_and_Metadata)\* | （可选）指定其他特定于区域设置的标题和分隔符文本。                                                                                                         |

例子：

<菜单>

...

<分隔符>-------------</分隔符>

...

<分隔符>

    <text>-- 前 10 页--</text>

    <metadata name="text" xml:lang="fr">Haut Pages</metadata>

    <title>Jetspeed2 用户投票选出的前 10 个页面！</title>

</分隔符>

...
</菜单>

### 8.2.4. **菜单包括定义**

<include> 元素包括来自另一个菜单的[选项](#Menu_Options_Definition)或嵌套[菜单。](#Menu_Definition)要包含的菜单的名称被指定为此元素的文本值。include 元素只有一个有效属性：


| **属性** | **描述**                                                                                                                                           |
| -------- | -------------------------------------------------------------------------------------------------------------------------------------------------- |
| 巢       | 控制指定菜单是否嵌套的布尔标志。如果此属性设置为“true”，则包含的菜单将嵌套为子菜单；否则，指定菜单中的所有选项和嵌套菜单都将内联插入到此菜单中。 |

例子：

<菜单>

...

<include nest="true">导航</include>

...
</菜单>

### 8.2.5. **菜单排除定义**

<exclude> 元素从另一个菜单中排除[选项](#Menu_Options_Definition)或嵌套[菜单。](#Menu_Definition)此选项主要用于从该菜单中删除另一个菜单中已出现在门户页面上的菜单选项。只有当它们出现在菜单定义中的该元素上方时，才会排除匹配的选项或菜单。要包含的菜单的名称被指定为这个简单元素的文本值。

例子：

<菜单>

...

<排除>页面</排除>

...
</菜单>

### 8.2.6. **页面布局装饰器**

当页面在 Jetspeed2 管道中呈现时，页面布局装饰器从 Portal 站点组件请求菜单。装饰器希望 PSML 声明提供某些菜单。在门户中显示自定义菜单之前，需要修改装饰器以呈现自定义菜单。下面是一个取自 Velocity 布局装饰器 header.vm 文件的示例：

...

#set($pagesStandardMenu = $site.getMenu("pages"))

#if(!$pagesStandardMenu.empty)

<div class="标签">

#includeTabsNavigation($pagesStandardMenu $LEFT_TO_RIGHT)

</div>

＃结尾

...

此代码块在门户页面中呈现标准页面选项卡菜单。Portal 站点组件作为*\$site* Velocity 上下文变量公开。空菜单定义的测试旨在确保空菜单不会呈现到页面内容中。最后，执行一个装饰器宏来扩展菜单内容。通常采用这种方法来支持使用宏的递归调用来呈现嵌套菜单。在这种情况下，装饰器只需要页面选项。这是用于呈现页面选项卡菜单的宏实现：

#macro (includeTabsNavigation $_menu $_orientation)

<表格边框="0" cellpadding="0" cellspacing="0">

<tr>

#foreach($_menu.elements.iterator() 中的$element)

  #if($element.elementType == "选项")

    #set($tabTitle = $element.getTitle($preferedLocale))

    #set($tabName = $element.getShortTitle($preferedLocale))

    #if($_orientation == $LEFT_TO_RIGHT)

      #if($element.isSelected($site))

        <td class="LTabLeft" nowrap="true"> </td>

        <td class="LTab" align="center" valign="middle" nowrap="true" title="$!tabTitle">${tabName}</td>

        <td class="LTabRight" nowrap="true"> </td>

      ＃别的

        #set($tabUrl = $jetspeed.getAbsoluteUrl($element.url))

        <td class="LTabLeftLow" nowrap="true"> </td>

        <td class="LTabLow" align="center" valign="middle" nowrap="true" title="$!tabTitle"><a href="$tabUrl">${tabName}</a></td >

        <td class="LTabRightLow" nowrap="true"> </td>

      ＃结尾

    ＃结尾

  ＃结尾

＃结尾
</tr>

</table>

＃结尾

该宏迭代由门户网站组件提供的计算页面菜单选项，呈现构成每个显示选项卡的一系列表格数据 HTML 元素。整个菜单呈现为具有单行的 HTML 表格。

暴露给布局装饰器的声明性菜单 Portal Site Component 对象记录在 [Jetspeed API](https://portals.apache.org/jetspeed-2/apidocs/index.html)中。以下是构成此接口的主要接口列表：

· [org.apache.jetspeed.portalsite.Menu](https://portals.apache.org/jetspeed-2/apidocs/org/apache/jetspeed/portalsite/Menu.html)

· [org.apache.jetspeed.portalsite.MenuElement](https://portals.apache.org/jetspeed-2/apidocs/org/apache/jetspeed/portalsite/MenuElement.html)

· [org.apache.jetspeed.portalsite.MenuOption](https://portals.apache.org/jetspeed-2/apidocs/org/apache/jetspeed/portalsite/MenuOption.html)

· [org.apache.jetspeed.portalsite.MenuSeparator](https://portals.apache.org/jetspeed-2/apidocs/org/apache/jetspeed/portalsite/MenuSeparator.html)

· [org.apache.jetspeed.portalsite.PortalSiteRequestContext](https://portals.apache.org/jetspeed-2/apidocs/org/apache/jetspeed/portalsite/PortalSiteRequestContext.html)

有关更多信息，请参阅这些接口的[javadocs](https://portals.apache.org/jetspeed-2/apidocs/index.html)和示例 Velocity 装饰器。

Jetspeed2 提供了许多示例装饰器，包括那些将呈现选项卡、带有嵌套子菜单的导航窗格、历史面包屑链接，甚至 DHTML JSCookMenu 嵌套下拉菜单......所有这些都来自此处记录的声明性菜单元素。

### 8.2.7. **门户网站组件**

与[Jetspeed Profiler 组件](https://portals.apache.org/jetspeed-2/devguide/guide-profiler.html)一起，门户网站组件执行两个密切相关的功能：

1. 将用户的门户请求 URL 映射到站点中的 PSML[页面](#Page)或[文件夹](#Folder)元素，以及
2. 构建站点导航菜单及其选项，以反映用户可从站点获得的内容。

乍一看，这些功能似乎相对简单：在[PSML 站点定义](https://portals.apache.org/jetspeed-2/devguide/guide-psml.html)中搜索和遍历。但是，一旦考虑到 Profiler 组合和[安全约束](https://portals.apache.org/jetspeed-2/deployguide/guide-security-declarative-psml.html) 过滤的复杂性，映射通常不是微不足道的。

菜单定义选项路径被指定为页面 URI 以利用此映射功能。页面 URI 本质上是用于寻址页面或文件夹的门户请求 URL 的尾部。将页面 URI 用于选项允许门户的所有用户共享菜单定义：应用用户特定的配置文件和有效的安全约束来生成菜单选项。这意味着不能指定页面管理器文件系统或数据库内部使用的物理路径来直接寻址特定的 PSML 元素。

例如，假设如下：

· 默认的“j2”分析规则对“某人”用户有效，

· 页面管理器中提供了以下物理 PSML 站点结构，

o .../page0.psml

o .../page1.psml

o .../page2.psml

o .../hidden-page0.psml

o .../\_user/someone/page0.psml

· 安全约束拒绝用户访问“/page2.psml”，以及

· '/hidden-page.psml' 在页面 PSML 中被声明为隐藏。

用户的当前[配置文件定位器](https://portals.apache.org/jetspeed-2/devguide/guide-profiler.html)将指定门户站点组件将以下门户请求 URL 映射到特定的 PSML 元素：


| **门户请求URL**                             | **选择PSML 元素**           |
| ------------------------------------------- | ----------------------------- |
| http://.../jetspeed/portal/page0.psml       | .../\_user/someone/page0.psml |
| http://.../jetspeed/portal/page1.psml       | .../page0.psml                |
| http://.../jetspeed/portal/page2.psml       | **未通过安全测试。**          |
| http://.../jetspeed/portal/hidden-page.psml | .../hidden-page.psml          |

相同的配置文件定位器用于评估菜单选项。以下是几个有效的菜单选项路径以及它们是如何解决的：


| **菜单选项页面URI**        | **菜单中包含的PSML 元素**                  |
| -------------------------- | -------------------------------------------- |
| /page0.psml                | .../\_user/someone/page0.psml                |
| /page0.psml,/page1.psml    | .../\_user/someone/page0.psml,.../page1.psml |
| /\*.psml                   | .../\_user/someone/page0.psml,.../page1.psml |
| /\*                        | .../\_user/someone/page0.psml,.../page1.psml |
| /\_user/someone/page0.psml | **不是有效的页面URI。**                      |

笔记：

· 尝试使用无效页面 URI 的菜单选项将被忽略。无效 URI 包括那些包含保留文件夹（例如“_user”、“_role”等）或特定于页面管理器实现的其他物理路径的 URI。

· 请求不能引用安全受限的页面或文件夹，并且不会出现在菜单中。

· 可以请求隐藏页面（或隐藏和保留文件夹），但在菜单中不可见。页面有一个例外：如果隐藏页面是请求页面，则认为隐藏页面是可见的。

## 8.3. [**PSML 声明式安全**](https://portals.apache.org/jetspeed-2/deployguide/guide-security-declarative-psml.html)

· [安全约束](#The Security Constraint)

· [声明性约束和全局约束](#Declarative and Global Constraints)

· [文件夹约束](#Folder Constraints)

· [页面约束](#Page Constraints)

· [片段约束](#Fragment Constraints)

· [弹簧配置](#Spring Configuration)

· [PSML 文档 DTD](#PSML_DTDs)

安全约束应用于页面和文件夹。安全约束允许或拒绝对页面和文件夹的访问。可以在以下四个位置之一或全部定义约束：

· 1.**全局：**作为在 PSML 树根中找到的***page.security***文件中的声明。

· 2.**文件夹：**在***folder.metadata***文件中可选地位于每个目录中。

· 3.**页面：**在 PSML 文件中限制对特定页面的访问。

· 4. **Fragment：**在页面 PSML 文件中限制对页面内特定片段的访问。

### 8.3.1. **赠款**

授予与权限、授权或授予主体列表访问页面或文件夹相关联。授予安全约束是一个或多个安全主体列表与一个或多个权限组合的关联。授予约束授予对相关权限列表的页面或文件夹的访问权限。

### 8.3.2. **否认**

使用一个或多个安全主体声明拒绝安全约束；没有相关权限。拒绝约束禁止访问给定主体列表的页面或文件夹。请注意，拒绝约束必须在授予约束之前列出。

### 8.3.3. **声明性和引用性约束**

使用页面和文件夹资源约束时，约束可以是***声明性约束***或***引用***约束。声明性约束被声明并用于特定页面或文件夹资源的正确位置。引用约束是指在集中式安全约束资源中声明的约束：***page.security***文件。每个站点或子站点都可以有一个***page.security***资源，用于声明要在任何页面或文件夹中引用的约束。

### 8.3.4. **安全约束**

安全约束是在 PSML 文件、文件夹元数据文件或全局安全声明中找到的 XML 元素。安全约束有一个属性：名称。安全约束具有以下元素：

· 角色 - 一个或多个角色主体的逗号分隔列表或 * 表示所有角色

· 组 - 一个或多个组主体的逗号分隔列表或所有组的 *

· users - 一个或多个用户主体的逗号分隔列表或 * 表示所有用户

· owner - 单个用户主体

· 权限 - 一个或多个权限的逗号分隔列表（查看、编辑、帮助）

前四个元素（角色、组、用户、所有者）都定义了被授予或被拒绝的权限的主体。

#### 8.3.4.1. **权限**

权限是安全约束授予的门户模式。请注意，仅授予权限，而不是拒绝权限。***查看***权限类似于操作系统中的***读取权限。编辑***权限类似于操作系统中的***写入权限。帮助***权限类似于某些门户网站中的信息***权限***。

#### 8.3.4.2. **角色**

对于给定资源的一组权限，可以将约束授予一个或多个角色主体。角色派生自角色主体的授权用户列表，即用户所属的角色。如果授权用户是任何列出的角色的成员，则将授予对该资源的权限。

<安全约束>

  <roles>管理员、经理</roles>    

  <permissions>查看、编辑</permissions>

</安全约束>
约束还可以拒绝角色主体访问整个资源。如果授权用户是任何列出的角色的成员，则拒绝对资源的所有访问。

<安全约束>

  <roles>管理员、经理</roles>    

</安全约束>
#### 8.3.4.3. **团体**

对于给定资源的一组权限，可以将约束授予一个或多个组主体。组派生自组主体的授权用户列表，即用户所属的组。如果授权用户是任何列出的组的成员，则将授予对该资源的权限。

<安全约束>

  <groups>会计、发展</groups>    

  <permissions>查看</permissions>

</安全约束>
约束还可以拒绝组主体访问整个资源。如果授权用户是任何列出的组的成员，则拒绝对资源的所有访问。

<安全约束>

  <groups>会计、发展</groups>    

</安全约束>
#### 8.3.4.4. **用户**

可以向一个或多个用户主体授予对给定资源的一组权限的约束：当前用户必须是逗号分隔列表中列出的主体之一才能授予资源权限。

<安全约束>

  <users>乔伊、迪迪、约翰尼</users>    

  <permissions>查看、编辑、帮助</permissions>

</安全约束>
约束还可以拒绝用户主体访问整个资源。如果授权用户在列表中，则拒绝对资源的所有访问。

<安全约束>

  <users>弗雷德</users>    

</安全约束>
#### 8.3.4.5. **组合**

请注意，您可以授予或拒绝对一个或多个主体类型的集合的权限。例如，在这里，我们授予角色（经理、开发人员）、组（QA 和研究）以及特定用户（dilbert）的查看和编辑权限： 如果授权用户是任何列出的成员角色、组或用户，将授予对资源的权限。

<安全约束>

  <roles>黑客、程序员、大师</roles>    

  <groups>unix、linux、freebsd</groups>

  <users>贝蒂、弗雷德、巴尼、威尔玛</users>      

  <permissions>查看、编辑</permissions>

</安全约束>
约束还可以拒绝主体组合访问整个资源。如果授权用户是任何列出的组、角色或用户的成员，则拒绝对资源的所有访问。

<安全约束>

  <roles>黑客、程序员、大师</roles>    

  <groups>unix、linux、freebsd</groups>

  <users>贝蒂、弗雷德、巴尼、威尔玛</users>      

</安全约束>
#### 8.3.4.6. **全部 \***

\* 可以应用于角色、组、用户或权限以暗示 ALL。

<安全约束>

  <用户>*</用户>      

  <permissions>*</permissions>

</安全约束>
#### 8.3.4.7. **所有者**

资源所有者被声明为安全约束。拥有的主体被自动授予所有权限。

<所有者>懒惰</所有者>      
### 8.3.5. **声明性约束和全局约束**

声明性约束在站点根目录的***page.security文件中定义。***声明性约束在带有***security-constraints-ref***标签的页面和文件夹中被引用。全局约束也是声明性约束。它们也在根 PSML 存储库的***page.security文件中定义和找到。***与全局约束的不同之处在于它们隐含地应用于 page.security 文件（即站点）范围内的所有文件夹和页面。请注意，Jetspeed 安装中只能有一个***page.security***文件。

<security-constraints-def name="admin">

  <安全约束>

    <角色>管理员</角色>

    <permissions>查看、编辑</permissions>

  </安全约束>

</security-constraints-def>

<global-security-constraints-ref>admin</global-security-constraints-ref>
约束名称仅限于字母、数字、“_”、“-”和“.”。人物。

#### 8.3.5.1. **约束引用表达式**

除了按名称进行约束引用之外，***security-constraints-ref***和***global-security-constraints-ref***标签还接受带有约束引用操作数的逻辑表达式来表达更复杂的授权。当安全约束列表的默认“OR”授权逻辑变得笨拙或需要诸如“AND”或“NOT”之类的替代逻辑时，通常使用表达式。

<global-security-constraints-ref>admin 和 noc</global-security-constraints-ref>

<security-constraints-ref>（支持 || 工程）&& !marketing</security-constraints-ref>
表达式是中缀并支持以下运算符：“and”、“or”、“not”、“(”、“)”、“&&”、“||” 和 ”！”。适用于逻辑表达式的常用运算符优先级规则。

#### 8.3.5.2. **默认约束**

在 Jetspeed 的默认部署中做了几个安全约束声明：


| **姓名** | **赠款**           | **权限**   | **全球的** |
| -------- | ------------------ | ---------- | ---------- |
| 行政     | 角色：管理员       | 查看、编辑 | 是的       |
| 经理     | 角色：经理         | 看法       | 不         |
| 用户     | 角色：用户、管理员 | 看法       | 不         |
| 公众视野 | 用户：\*           | 看法       | 不         |
| 公共编辑 | 用户：\*           | 查看、编辑 | 不         |

### 8.3.6. **文件夹约束**

文件夹安全约束放置在**安全约束列表**在站点中的每个文件夹中可选地找到的***folder.metadata***文件中。请注意，该文件中没有***folder.metadata***或安全约束意味着该文件夹将继承父文件夹的约束，一直到站点或子站点的根文件夹。文件夹约束不会跨子站点继承。文件夹安全约束由声明性安全约束和引用安全约束组成。这是两者的示例，第一个是引用约束，第二个是声明性约束：

<安全约束>

<security-constraints-ref>公共视图</security-constraints-ref>

<安全约束>

  <groups>工程</groups>

  <permissions>查看</permissions>

</安全约束>    
</安全约束>

请注意，所有安全约束都必须放在一个***安全约束***集合中。

### 8.3.7. **页面约束**

放置页面安全约束**安全约束列表** 在***PSML***文件中，并且是可选的。请注意，该文件中没有安全约束列表意味着该文件夹将继承其所在文件夹的约束。页面安全约束由声明性安全约束和引用安全约束组成。这是两者的示例，第一个是引用约束，第二个是声明性约束：

<安全约束>

<security-constraints-ref>全局视图</security-constraints-ref>

<安全约束>

  <groups>会计</groups>

  <permissions>查看、编辑</permissions>

</安全约束>    
</安全约束>

请注意，所有安全约束都必须放在一个***安全约束***集合中。

### 8.3.8. **片段约束**

与页面安全约束一样，片段安全约束被放置在 **安全约束列表**在***PSML***页面文件中，并且再次是可选的。正如预期的那样，没有安全约束列表意味着片段将继承它所属的页面的约束。请注意，仅针对这些约束检查查看权限。其他权限仅针对包含页面进行测试。

### 8.3.9. **Portlet 约束**

***在全球范围内，这些是使用管理界面或在应用程序的jetspeed-portlet.xml***中为 portlet 或其 portlet 应用程序设置的。请参阅门户组件 - 注册表。

但是，默认情况下，这些全局安全约束在渲染时不会检查“view”，如果用户可以看到 portlet 的包含页面，则允许“view”。

因此，安全性依赖于限制对文件夹和页面的访问，控制谁可以添加 portlet 以及在何处添加，以及通过包含的片段单独限制对页面上 portlet 实例的访问。

要启用渲染时安全约束检查作为额外的包罗万象，请参阅门户组件 - 注册表。

### 8.3.10. **弹簧配置**

声明式安全约束在页面管理器组件的 Spring 配置中默认启用。这是 ***page-manager.xml*** spring 程序集配置文件中的默认页面管理器 bean 配置：

<bean id="org.apache.jetspeed.page.PageManager"

   名称="页面管理器"

   class="org.apache.jetspeed.page.psml.CastorXmlPageManager">         

   <constructor-arg index="0"><ref bean="IdGenerator"/></constructor-arg>

   <constructor-arg index="1"><ref bean="DocumentHandlerFactory"/></constructor-arg>

   <constructor-arg index="2"><ref bean="FolderHandler"/></constructor-arg>

   <constructor-arg index="3"><ref bean="PageFileCache"/></constructor-arg>        

   <!-- 权限安全启用标志，默认=false -->

   <constructor-arg index="4"><value>false</value></constructor-arg>

   <!-- 约束安全启用标志，默认=true -->

   <constructor-arg index="5"><value>true</value></constructor-arg>
</豆>

这里的第 6 个 (index="5") 布尔构造函数参数指定是否启用“约束安全”模型。如果未启用声明性安全约束，则所有内联、引用和全局安全约束都将被忽略。

## 8.4. [**PSML 模板**](https://portals.apache.org/jetspeed-2/deployguide/guide-page-templates.html)

在 Jetspeed 2.2.1 版本中，我们引入了三种新的 PSML 模板：

· 1.[模板页面** (TPSML)**](#TPSML)

· 2.[片段定义（**FPSML**）](#FPSML)

· 3.[动态模板页面（**DPSML**）](#DPSML)

模板是一种特殊的可[重用** PSML**](https://portals.apache.org/jetspeed-2/devguide/guide-psml.html)页。模板集中了 portlet 和页面布局的声明一次，然后可以在许多页面上重复使用。模板可以节省您在页面上维护 portlet 的大量配置时间。管理员可以在模板中添加或删除 portlet，与该模板关联的所有页面都会立即选择这些 portlet。当您有很多页面时，模板可以为您节省大量的管理时间来发布对系统中每个页面的更改。还可以保护模板，以便只有管理员可以修改它们。这意味着您可以强制页面集始终显示某些 portlet，例如在左列或右列中。通过保护模板，模板化的 portlet 被锁定在适当的位置：它们不能被最终用户删除或移动，只有管理员可以编辑模板中的 portlet。但是，合并页面上声明的portlet 可以由最终用户根据目标页面的安全约束正常维护。

从 2.3.0 版开始，您无法使用 Jetspeed 配置工具编辑模板（TPSML、FPSML、DPSML）。这意味着它们必须作为 XML 进行编辑，然后导入到系统中。未来的版本将支持模板的完全自定义。

### 8.4.1. **TPSML - 模板页面**

模板页面与可寻址的 PSML 页面结合使用，以创建带有模板的 PSML 页面的合并视图。模板页面无法通过 URL 寻址：因此您永远无法访问模板页面。模板通常在封闭文件夹中定义，并自动与该文件夹和子文件夹中的所有页面合并。存在一个限制，即每个文件夹只能定义一个页面模板。放置在子文件夹中的模板将覆盖放置在父文件夹中的模板。将模板页面引入 PSML 系统就像将 .tpsml 文件放入文件系统一样简单（或者，如果您将 PSML 存储在数据库中，则 可以使用[Import管理工具）。](https://portals.apache.org/jetspeed-2/adminguide/import.html)

模板最初是在 2.2.1 版本中引入的。如果您下载并运行[Jetspeed 演示](http://portals.apache.org/jetspeed-2/download.html)，导航到[http://localhost:8080/jetspeed/portal](http://localhost:8080/jetspeed/portal)，您将在欢迎页面上看到一个正在运行的模板示例，如下面的屏幕截图所示...

![](file:///C:\Users\johnfeng\AppData\Local\Temp\ksohtml11556\wps98.png)

在最左边和最右边的列中找到的两个 portlet 是 Jetspeed Toolbox 和 Page Navigator portlet。这些 portlet 在模板中声明，而不是在实际页面 (.psml) 中。在页面导航器上，按**网站**链接，导航到[http://localhost:8080/jetspeed/portal/frames.psml](http://localhost:8080/jetspeed/portal/frames.psml)。您将再次看到 Jetspeed Toolbox 和 Page Navigator portlet。这两个 portlet 仅在页面模板中声明一次，而不是在每个页面上声明。

如下图所示，页面模板将模板与可寻址页面合并，从而显示合并页面：

![](file:///C:\Users\johnfeng\AppData\Local\Temp\ksohtml11556\wps99.jpg)

**如何创建页面模板**

在本节中，您将学习如何在 Jetspeed 中创建自己的模板页面 (TPSML)。请注意，此处包含的所有示例都是在 Jetspeed 2.3.0 版本的经典（门户）管道 (/jetspeed/portal) 上进行的测试。模板旨在与 JetUI Pipeline 和 Classic Pipeline 一起使用。但是，JetUI 管道有一些特殊要求，最值得注意的是它将 Page Navigator 和 Toolbox 视为特殊的 portlet，并希望它们始终位于所有模板上。从 2.3.0 版开始，经典管道没有任何限制。另一个需要注意的重要问题 - 从版本 2.3.0 开始，模板只能在 XML 定义中定义。没有用于使用 Jetspeed 定制器创建这些模板的定制功能。未来的版本将提供模板定制器。[JetUI 文档](https://portals.apache.org/jetspeed-2/deployguide/guide-jetui.html)。本文档的其余部分假定您使用的是经典 (/portal) 管道。要了解有关使用管道的更多信息，请阅读[管道文档](https://portals.apache.org/jetspeed-2/deployguide/guide-pipelines.html)

让我们开始创建一个新的页面模板。您需要运行 Jetspeed 以便于演示模板的工作方式。首先，启动 Jetspeed，导航到[http://localhost:8080/jetspeed/portal ，并使用](http://localhost:8080/jetspeed/portal)*admin*用户登录演示系统，密码也是*admin*。使用页面导航器导航到任何其他页面。您将始终在左列中看到 Page Navigator portlet，在右列中看到 Jetspeed Toolbox。最终用户不能使用 Jetspeed Customizer 删除这些 portlet，甚至管理员用户也不能。无论您导航到哪个页面，您都会看到演示附带的默认系统模板。这个模板文件是**template.tpsml**，它位于*演示分发的pages*目录。（如果您从源代码构建 Jetspeed，它将位于 WEB-INF/pages 中）。让我们覆盖 Admin 用户主页空间的页面模板。请记住，可以从 Jetspeed 标题的下拉菜单中访问空格。从空间菜单中，选择**我的页面**。选择 My Pages 将显示位于 URL [http://localhost:8080/jetspeed/portal/\_user/admin](http://localhost:8080/jetspeed/portal/_user/admin)的页面 在文件系统上，管理员用户的主空间实际上位于**pages/\_user/admin**下。继续并在继续之前在文件系统上找到该目录。

现在打开一个文本编辑器，并创建一个名为**template.tpsml**的空文件。将该文件放在**pages/\_user/admin**文件夹中。Jetspeed 现在将自动为该文件夹中的所有页面（以及 pages/_user/admin 空间文件夹的任何子文件夹）使用您的新模板。创建页面模板时，您需要参考 Jetspeed 2.2 XML Schemas。您可以在此处找到 XML Schema 声明：http: //portals.apache.org/jetspeed-2/2.2/schemas/tpsml.xsd ["](http://portals.apache.org/jetspeed-2/2.2/schemas/tpsml.xsd) 您的所有页面模板 TPSML 页面应按以下方式开始...

<page-template id="定义"

xmlns="http://portals.apache.org/jetspeed"

xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"

xsi:schemaLocation="http://portals.apache.org/jetspeed http://portals.apache.org/jetspeed-2/2.2/schemas/tpsml.xsd">
根标签必须始终声明为**<page-template>**。页面模板是普通 PSML 页面的扩展。页面模板可以具有许多与页面相同的 XML 元素，例如标题和片段。建议在继续之前熟悉[标准** PSML **页面](https://portals.apache.org/jetspeed-2/devguide/guide-psml.html)。但是，有一些重要的区别：

· 您在页面模板中定义的片段将与同一文件夹和子文件夹中的所有页面合并，除非子文件夹用自己的模板覆盖它

· 您必须声明一个且只有一个**<page-fragment>**标记。这是将与模板合并的引用页面的占位符

< **page-fragment>** 标签很重要。它声明了当前页面的插入位置并合并到您的模板中。

..

<page-fragment id="template-admin-home">

  <属性名称=“行”值=“0”/>

</page-fragment>
...

请注意，页面片段可以具有典型的片段属性，例如*id*以及子元素，例如*row*和*column*。page-fragment 标签是可寻址页面的占位符。此时可寻址页面被合并，由可选的*行*和*列*属性指定，将模板片段与来自可寻址页面的片段结合起来。这是管理员主页空间的完整模板页面定义。继续将此示例剪切并粘贴到您的文本编辑器中，并将文件保存在**pages/\_user/admin/template.tpsml**下：

<?xml 版本="1.0" 编码="UTF-8"?>

<page-template id="管理员定义"

xmlns="http://portals.apache.org/jetspeed"

xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"

xsi:schemaLocation="http://portals.apache.org/jetspeed http://portals.apache.org/jetspeed-2/2.2/schemas/tpsml.xsd">
<title>示例模板</title>

<fragment id="example-template-top" type="layout" name="jetspeed-layouts::VelocityThreeColumns">

<property name="sizes" value="15%,70%,15%"></property>
<fragment id="example-left" type="layout" name="jetspeed-layouts::VelocityOneColumn">

    <property name="row" value="0"></property>

    <property name="column" value="0"></property>

	<fragment id="example-locale" type="portlet" name="j2-admin::LocaleSelector">

        <属性名称="行" 值="0" />

         <property name="column" value="0" />

     </片段>

    </片段>

<page-fragment id="example-page-template">

  <property name="column" value="1"/>

  <属性名称=“行”值=“0”/>

</page-fragment>
<fragment id="example-right" type="layout" name="jetspeed-layouts::VelocityOneColumn">

    <property name="row" value="0"></property>

    <property name="column" value="2"></property>

	<fragment id="example-forgotten" type="portlet" name="j2-admin::ForgottenPasswordPortlet">

            <属性名称="行" 值="0" />

            <property name="column" value="0" />

    </片段>
</片段>

</片段>

</page-template>

刷新页面[http://localhost:8080/jetspeed/portal/\_user/admin](http://localhost:8080/jetspeed/portal/_user/admin)。您现在应该看到一些不同之处：就像 Navigator 和 Toolbox 消失了，取而代之的是您在上面定义的 portlet，即 Local Selector 和 Forgotten Password Portlet。仔细查看 XML 文件。请注意，我们使用 Jetspeed 布局 portlet 来定义模板化页面的布局。在此示例中，我们有一个三列布局。左列由*example-left*片段定义。中间列是关键：这是我们的页面模板，它将保存实际的 PSML 页面。右列由*example-right定义*分段。当模板与您导航到的页面合并时，最终结果将包含模板的左右列，以及包含引用页面的中间列。这个被引用的页面可以有它自己的布局。例如，如果引用的页面有两列，则生成的合并页面将有四列，两列来自模板，两列来自包含的页面。

不过有一个问题。第一个问题，您卡在此页面上，不再有任何导航可供您使用。让我们通过在模板中添加 Space Navigator 来解决这个问题。*将此代码片段粘贴到 id 为example-left*的片段上方的文件中并保存文件：

<fragment id="jsSpaceNavigator" type="portlet" name="j2-admin::SpaceNavigator" decorator='clear'>

        <property name="y" value="300"></property>

        <property name="x" value="20"></property>            

        <property name="state" value="detach"></property>                        

</片段>
刷新页面。您现在应该在页面顶部区域看到一个 Space Navigator。这个片段的一个有趣的方面是它被分离并放置在页面上的特定坐标处。分离的 portlet 放置在与流驱动布局 portlet 不同的平面中，后者的位置与其在 PSML 定义中的位置相关。要了解有关分离的 portlet 的更多信息，请参阅[JetUI 文档](https://portals.apache.org/jetspeed-2/deployguide/guide-jetui.html)。

还有一个问题。我们无法在“我的页面”文件夹中导航。为此，我们需要一个 Page Navigator。让我们在模板中添加一个，以便该文件夹中的所有页面都可以使用它。在片段的片段结束标记之后立即粘贴下面的代码片段，其中 id 为**example-locale**：

<fragment id="jsPageNavigator" type="portlet" name="j2-admin::PageNavigator">

                    <property name="row" value="1"></property>

                <property name="column" value="0"></property>

                <property name="state" value="normal"></property>

                <property name="tool" value="true"></property>

</片段>
刷新页面。您现在应该在页面左侧的 Locale Selector portlet 正下方看到一个页面导航器 portlet。当您导航到此文件夹中的其他页面（例如*My Account*页面）时，您应该始终可以看到来自模板的四个 portlet（Locale Selector、Page Navigator、Forgotten Password 和 Space Navigator）。

我们希望这些示例可以帮助您开始在 Jetpeed 中使用页面模板。如果您还有其他问题，请不要羞于在 Jetspeed 用户列表上提问。

### 8.4.2. **FPSML - 片段定义**

片段定义页面是用于声明可重用 portlet 定义的存储桶，然后可以引用这些定义并将其放置在普通的 PSML 文件中。TPSML 页面也遵循重用模式，而 FPSML 类似但解决的情况略有不同。TPSML 被模板重用。您将始终获得模板的整个布局。您的页面包含在模板中。FPSML 用例是不同的。使用 FPSML，您的页面将是片段定义包含在您的页面中的容器。

如下图所示，片段定义包含在任何页面（或页面模板）中，从而导致正常 portlet 片段的合并页面以及对片段定义的片段引用：

![](file:///C:\Users\johnfeng\AppData\Local\Temp\ksohtml11556\wps100.png)

在上图中，定义了四个片段定义。其中三个定义（Fragment Def A、Fragment Def B、Fragment Def C）是 portlet 片段。第四个是布局片段（Fragment Layout D），它包含两个portlet 片段（Fragment Def D-1、Fragment Def D-2）。

在页面 X 上，直接在该页面 (1,2,14,23) 上定义了四个 portlet。还有两个片段引用（A，B）。片段不是直接在页面 X 上定义的，它们只是被引用。

在页面 Y 上，直接在该页面 (1,6,7,22) 上定义了四个 portlet。还有两个片段引用（B，C）。片段不是直接在页面 Y 上定义的，它们只是被引用。此外，页面 Y 有一个片段布局参考 (D)。在这个片段布局参考中，有两个片段 portlet 参考（D-1、D-2）。

此时，您可能会问：在页面定义之外声明片段定义有什么好处？ **使用片段定义的好处**

· Portlet 或 Portlet 组的集中定义

· 只定义一次页面首选项

· 锁定页面部分，以便用户无法自定义它们

· 与 portlet 模板相结合

**如何创建片段定义**

在本节中，您将学习如何在 Jetspeed 中创建自己的片段定义页面 (FPSML)，然后使用片段引用在 PSML 页面中使用这些片段定义。请注意，此处包含的所有示例都是在 Jetspeed 2.3.0 版本的经典（门户）管道 (/jetspeed/portal) 上进行的测试。片段定义旨在与 JetUI 管道和经典管道一起使用。一个需要注意的重要问题——直到版本 2.3.0，片段定义和片段引用只能在 XML 定义中定义。使用 Jetspeed 定制器创建这些片段定义没有定制功能。未来的版本将提供片段定义编辑器。

让我们开始创建一个新的片段定义。您需要运行 Jetspeed 以便于演示片段定义的工作方式。首先，启动 Jetspeed，导航到[http://localhost:8080/jetspeed/portal ，并使用](http://localhost:8080/jetspeed/portal)*admin*用户登录演示系统，密码也是*admin*。

要遵循的一条重要规则：每个 FPSML 文件可能只有一个片段定义。如果您想创建另一个片段定义，则创建另一个文件并将其存储在那里。让我们创建一个新的片段参考文件。打开一个文本编辑器，并创建一个名为**example.fpsml**的空文件。将该文件放在**pages/**文件夹中。创建片段定义时，您需要引用 Jetspeed 2.2 XML Schemas。您可以在此处找到 XML Schema 声明：http: //portals.apache.org/jetspeed-2/2.2/schemas/fpsml.xsd ["](http://portals.apache.org/jetspeed-2/2.2/schemas/fpsml.xsd) 您的所有片段定义 FPSML 页面应按以下方式开始...

<fragment-definition id="定义"

xmlns="http://portals.apache.org/jetspeed"

xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"

xsi:schemaLocation="http://portals.apache.org/jetspeed http://portals.apache.org/jetspeed-2/2.2/schemas/fpsml.xsd">
根标签必须始终声明为**<fragment-definition>**。片段定义可以有一些与页面片段相同的 XML 元素。它们共同的主要元素是片段标签。如果您还没有，我们建议您先熟悉[标准** PSML **页面](https://portals.apache.org/jetspeed-2/devguide/guide-psml.html)，然后再继续。但是，有一些重要的区别：

· 您在片段定义中定义的片段永远不会直接显示在页面上。它们必须被引用，然后通过片段 ID 合并到真实页面中（见下文）

· 您必须为每个片段定义声明一个且仅一个根**<fragment>**标记。

第二个限制与 PSML 页面并没有太大的不同，PSML 页面也仅限于每个页面的根片段。但是在 PSML 页面上，这个片段必须是布局片段。使用片段定义，此片段可能是单个 portlet 片段。

..

<fragment id="hometown-weather-def" type="portlet" name="demo::WeatherPortlet">

  <偏好名称="城市">

    <value>佛罗里达州迈阿密</value>

  </偏好> 
</片段>

...

请注意，片段定义可以具有典型的片段属性，如*id*以及子元素，如*偏好*。在这里声明首选项是使用片段引用的更重要的技术之一。通过在此页面上声明首选项，您可以根据其首选项重用 portlet 的变体，并将这些首选项锁定在许多页面上。这是我们示例的完整片段定义。继续将此示例剪切并粘贴到您的文本编辑器中，并将文件保存在**pages/example.fpsml下**

<?xml 版本="1.0" 编码="UTF-8"?>

<fragment-definition id="定义"

xmlns="http://portals.apache.org/jetspeed"

xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"

xsi:schemaLocation="http://portals.apache.org/jetspeed http://portals.apache.org/jetspeed-2/2.2/schemas/fpsml.xsd">
<title>天气</title>

<fragment id="hometown-weather-def" type="portlet" name="demo::WeatherPortlet">

     <偏好名称='天气状态'>

    <值>FL</值>

  </偏好>

  <偏好名称='weather_city'>

    <value>迈阿密</value>

  </偏好>
</片段>

</片段定义>

Jetspeed 现在将自动了解您的片段定义。下一步是引用该定义。

**如何引用片段定义**

使用片段引用，您可以将片段定义放在任何页面或模板页面上。片段引用与片段具有几乎相同的 XML 模式，唯一的区别在于标签**fragment-reference**的名称和该标签上的**refid**属性。这是一个片段引用，引用了我们的片段定义：

..

<fragment-reference id="dp-25-wp-reference" refid="hometown-weather-def">

    <property name="row" value="5"/>

    <property name="column" value="0"/>

</片段参考>
...

在所有片段和片段引用中始终为 id 属性赋予唯一的 id 属性非常重要。refid 属性是**hometown-weather-def**，将这个引用链接到实际的片段定义。让我们将此片段引用添加到主页。编辑**pages/default-page.psml**，并在根片段集合（布局片段）下的任何位置添加片段引用，例如在最后一个结束片段标记之前。保存文件，访问首页[http://localhost:8080/jetspeed/portal](http://localhost:8080/jetspeed/portal)，用*admin*用户登录demo系统，密码也是*admin*. 引用的片段将显示在第一列第五行。它现在应该使用片段定义中的首选项（迈阿密，佛罗里达）。

### 8.4.3. **动态模板页面 (DPSML)**

动态模板是可重用的门户页面，与门户内的匹配内容 URL 一起使用。与页面模板一样，动态页面与页面合并。您还可以将片段和片段引用放在动态页面上。动态页面通过 URL 和内容类型映射匹配到门户内容页面请求：匹配页面从当前或父文件夹中选择。每个文件夹只能为每种内容类型定义一个动态页面。

动态页面与[内容和请求** URL **映射](https://portals.apache.org/jetspeed-2/deployguide/guide-content-mapping-psml.html)配置结合使用。URL 映射配置处理将请求 URL 映射到旨在从内容管理系统或其他网站检索内容的 portlet 的动态部分。这使得将外部系统的内容空间直接映射到门户的 URL 空间成为可能。Jetspeed 可以开箱即用地将网站的 URL 空间映射到门户中，使用 DynamicWebContentPortlet 与我们的虚拟 DPSML（动态模板页面）相结合。要查看使用 JetUI 运行的示例，请启动 Jetspeed，以管理员身份登录，然后导航到[http://localhost:8080/jetspeed/ui/content/](http://localhost:8080/jetspeed/ui/content/). （不要忘记结尾 /，这是必要的。）您将看到 Apache Portals 网站在动态 Web 内容 Portlet 中运行。

![](file:///C:\Users\johnfeng\AppData\Local\Temp\ksohtml11556\wps101.jpg)

请注意左侧有一个页面导航器，右侧是常用的工具箱。Apache Portals 网站托管在中间。此外，它旁边还有一个 Weather portlet。这里是有趣的部分。单击 Apache Portals 导航面板中的任何链接，例如**News and Status**链接。请注意，当您单击托管网站内的链接时，整个页面是如何重新呈现的。看网址。当您单击新闻和状态链接时，URL 应该已更改为[http://localhost:8080/jetspeed/ui/content/news.html](http://localhost:8080/jetspeed/ui/content/news.html) 动态页面允许您在 Jetspeed 模板中构建外部网站，并将网站的内容与配置的 portlet 和布局混合在一起。并且，将外部网站的 URL 空间映射并挂载到门户的 URL 空间。安装 URL 空间在[Content and Request URL Mapping Guide](https://portals.apache.org/jetspeed-2/deployguide/guide-content-mapping-psml.html)中配置。在这个例子中，我们映射一个基本 URL http://portals.apache.org/。基本 URL 之外的任何路径都安装到 Jetspeed 基本 URL，http://localhost:8080/ui/content/。

举一个稍微复杂一点的例子，单击动态 Web 内容 portlet 顶部区域中的**Jetspeed-2**链接，然后导航到**Features**链接。在 portlet 中，您已导航到 http://portals.apache.org/jetspeed-2/features.html。挂载的 URL 是 http://localhost:8080/jetspeed/ui/content/jetspeed-2/features.html。

DPSML 页面的配置与 TPSML 页面的配置没有太大区别。让我们看一下上面示例中使用的 DPSML 页面。首先是 **动态页面**元素，告诉 Jetpeed 我们正在定义一个动态 PSML 页面：

<dynamic-page id="default-content" content-type="*"

xmlns="http://portals.apache.org/jetspeed"

xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"

xsi:schemaLocation="http://portals.apache.org/jetspeed http://portals.apache.org/jetspeed-2/2.2/schemas/dpsml.xsd">
从这里开始，该页面看起来与任何其他 PSML 页面没有任何不同。由 portlet 开发人员创建一个能够使用 Jetspeed 动态内容映射 API 的 portlet。Jetspeed 提供了一个：**j2-admin::DynamicWebContentPortlet**。此 Portlet 使用两个首选项来配置动态内容。**SRC**首选项提供被代理网站的URL。PORTALPATH**首**选项定义了 Jetspeed URL 命名空间的安装路径前缀。

<fragment id="dcdp-2-dynamic-content" type="portlet" name="j2-admin::DynamicWebContentPortlet" decorator="gray-gradient-noborder">

  <preference name="SRC">

    <value>http://portals.apache.org/</value>

  </偏好>

  <preference name="PORTALPATH">

    <值>/内容/</值>

  </偏好>

</片段>
除了支持虚拟网站，DPSML 加上 Jetspeed 动态内容映射 API 可用于将其他内容系统（如内容管理系统或 Wiki）集成到门户中。

# 9. **Jetspeed 集群**

## 9.1. [**聚类**](https://portals.apache.org/jetspeed-2/deployguide/config-cluster.html)

Jetspeed 是一个能够在集群应用服务器中运行的企业门户。在集群部署中运行需要进行几项配置更改：

1. 使用数据库页面管理器
2. 使用版本化部署管理器
3. 启用分布式缓存

### 9.1.1. **1.数据库页面管理器**

PSML 代表门户中的页面。可以有很多。默认实现将 PSML 文件存储在文件系统上。辅助实现将文件存储在数据库中。当部署到集群的 Jetspeed 发行版，或者当您有数以万计的用户需要性能时，存储在数据库中是必要的。在备用目录中提供的是 DBPSML 备用配置 db-page-manager.xml。您可以获取此文件并将其复制到您的覆盖目录中。它将按名称覆盖 page-manager.xml bean。

<bean id="org.apache.jetspeed.page.PageManagerImpl"

    名称="pageManagerImpl"

    初始化方法=“初始化”

    class="org.apache.jetspeed.page.impl.DatabasePageManager">

  <!-- OJB配置文件资源路径-->

  <constructor-arg index="0"><value>JETSPEED-INF/ojb/page-manager-repository.xml</value></constructor-arg>       

  <!-- 权限安全启用标志，默认=false -->

  <constructor-arg index="1"><value>false</value></constructor-arg>

  <!-- 约束安全启用标志，默认=true -->

  <constructor-arg index="2"><value>true</value></constructor-arg>

  <!-- 文件夹/页面/链接缓存 -->

  <constructor-arg index="3"><ref bean="pageManagerOidCache"/></constructor-arg>

  <!-- 文件夹/页面/链接路径缓存 -->

  <constructor-arg index="4"><ref bean="pageManagerPathCache"/></constructor-arg>
</豆>

### 9.1.2. **2. 版本化部署**

默认的 Jetspeed Deployer，虽然它适用于 Tomcat 上的开发，但在集群环境中效果不佳。我们已经为集群环境实现了第二个版本化 Portlet 应用程序管理器。节点管理器的实现很可能在未来被弃用。在部署到具有复制数据库和复制应用程序服务器的集群时，我们遇到了基于 NodeManager 的集群支持的限制。默认的 PAM（Portlet 应用程序管理器）不适用于门户的许多部署。PAM 的第二个版本没有侦听器，并且基于 jetspeed-portlet.xml 元数据中提供的版本号的更简单的部署算法 如果未找到此字段，或者它等于或小于数据库中的版本，则不会部署 PA。这将允许在集群中放入 2..n 个 PA，而无需重新注册。重新注册的问题是注册算法从数据库中深度删除旧的 PA def，创建一个带有所有新 OID 的新 PA，使集群中其他节点上的所有其他 PA 和 portlet 无效。

<bean id="deployFactory" class="org.apache.jetspeed.tools.deploy.JetspeedDeployFactory"/>

<bean id="org.apache.jetspeed.tools.pamanager.PortletApplicationManager"

   class="org.apache.jetspeed.tools.pamanager.VersionedPortletApplicationManager" init-method="start" destroy-method="stop"
   <constructor-arg><ref bean="portletFactory"/></constructor-arg>

   <constructor-arg><ref bean="org.apache.jetspeed.components.portletregistry.PortletRegistry"/></constructor-arg>

   <constructor-arg><ref bean="org.apache.jetspeed.components.portletentity.PortletEntityAccessComponent"/></constructor-arg>

   <constructor-arg><ref bean="org.apache.jetspeed.container.window.PortletWindowAccessor"/></constructor-arg>

   <constructor-arg><ref bean="org.apache.jetspeed.security.PermissionManager"/></constructor-arg>       

   <constructor-arg><ref bean="org.apache.jetspeed.search.SearchEngine"/></constructor-arg>              

   <constructor-arg><ref bean="org.apache.jetspeed.security.RoleManager"/></constructor-arg>                     

   <!-- 在部署 Portlet 应用程序期间分配默认权限的角色主体 -->

   <构造函数参数>

     <列表>

        <value>用户</value>

     </列表>

   </constructor-arg>

   <!-- 应用根目录 -->

    <构造函数参数>

        <value>${applicationRoot}</value>

    </constructor-arg>
<!-- 用于自动创建部署的 web.xml 中定义的尚未存在的角色的可选配置：

       <property name="autoCreateRoles"><value>true</value></property>

   -->

<!-- 可选描述符更改监视器检查间隔，以秒为单位（0：禁用，默认值：10）：

       <property name="descriptorChangeMonitorInterval"><value>10</value></property>

   -->

<!-- 如果注册 ths PA 出错，可选的最大 PA 启动重试次数（0：不重试，默认值：10）：

   		这是因为集群环境中的数据库约束验证错误而引入的

   		见 https://issues.apache.org/jira/browse/JS2-666

       <property name="maxRetriedStarts"><value>10</value></property>

   -->

</豆>

您可以在备用目录中找到这些**alternate**Spring 配置，即部署备用配置，deployment.xml。您可以获取此文件并将其复制到您的覆盖目录中。它将按名称覆盖 deployment.xml bean。

### 9.1.3. **3.分布式缓存**

在集群中，Jetspeed 使用分布式缓存在集群中保持所有内部缓存同步。[可在此处](https://portals.apache.org/jetspeed-2/deployguide/distributed-cache.html)找到有关分布式缓存的文档。

## 9.2. [**分布式缓存**](https://portals.apache.org/jetspeed-2/deployguide/distributed-cache.html)

可以选择将 Jetspeed 配置为将分布式缓存复制与 ehcache 一起使用。默认情况下，分布式缓存复制被禁用，但可以通过 Jetspeed 配置启用。程序集文件夹包含**cache.xml**通过 Spring 控制 ehcache 配置。

Jetspeed 使用缓存复制来管理其所有分布式缓存，例如页面管理器和首选项缓存。**ehcache.xml**（在 中找到）**/WEB-INF/classes/**具有更详细的缓存配置详细信息。它已被修改以启用所有缓存的分布式缓存复制，包括页面管理器和首选项缓存。

以下示例取自**distributed-ehcache.xml**(in **/WEB-INF/classes/**)。如果要切换到完整的分布式缓存使用，可以更轻松地交换完全 in (in ) 的用法**ehache.xml**，如下所示。 **distributed.ehcache.xmlcache.xml/WEB-INF/assembly/**

<!-- 缓存管理器 -->

<bean id="cacheManagerConfig" class="org.apache.jetspeed.cache.impl.EhCacheConfigResource">

<!-- <property name="defaultConfigResource" value="distributed-ehcache.xml"/> -->

<property name="defaultConfigResource" value="ehcache.xml"/>
</豆>

缓存复制需要侦听器和提供者工厂缓存。您不必在此文件中输入值，而是使用 jetspeed override.properties 来设置它们。以下是可以设置用于配置分布式缓存的参数。在大多数默认配置下，集群中所有节点的端口和主机名可以相同。

### 9.2.1. **监听器工厂**

<cacheManagerPeerListenerFactory 类="net.sf.ehcache.distribution.RMICacheManagerPeerListenerFactory"

                             properties="hostName=${org.apache.jetspeed.ehcache.hostname},

                             端口=${org.apache.jetspeed.ehcache.port}"/>
### 9.2.2. **提供者工厂**

<cacheManagerPeerProviderFactory 类="net.sf.ehcache.distribution.RMICacheManagerPeerProviderFactory"

                             属性=“对等发现=自动，

                             multicastGroupAddress=${org.apache.jetspeed.ehcache.group.address},

                             multicastGroupPort=${org.apache.jetspeed.ehcache.group.port},

                             timeToLive=${org.apache.jetspeed.ehcache.group.ttl}"/>
### 9.2.3. **首选项缓存**

<缓存名称="preferencesCache"

   maxElementsInMemory="10000"

   maxElementsOnDisk="1000"

   永恒=“假”

   溢出到磁盘 =“假”

   timeToIdleSeconds="28800"

   timeToLiveSeconds="28800"

   memoryStoreEvictionPolicy="LFU">

<cacheEventListenerFactory

        class="net.sf.ehcache.distribution.RMICacheReplicatorFactory"

        属性=“replicateAsynchronously=true,replicatePuts=false,

                    复制更新=假，复制更新ViaCopy=假，

                    复制删除=真"/>
</缓存>

### 9.2.4. **pageManagerPathCache**

<缓存名称="pageManagerPathCache"

   maxElementsInMemory="${org.apache.jetspeed.ehcache.pagemanager.maxelements}"

   永恒=“假”

   溢出到磁盘 =“假”

   timeToIdleSeconds="${org.apache.jetspeed.ehcache.pagemanager.element.ttl}"

   timeToLiveSeconds="${org.apache.jetspeed.ehcache.pagemanager.element.ttl}"

   memoryStoreEvictionPolicy="LFU">

<cacheEventListenerFactory class="net.sf.ehcache.distribution.RMICacheReplicatorFactory"

                           属性=“复制异步=真，

                                       复制普特=假，

                                       复制更新=假，

                                       replicateUpdatesViaCopy=false,

                                       复制删除=真"/>
</缓存>

### 9.2.5. **主机名**

由**org.apache.jetspeed.ehcache.hostname**属性表示的主机名是侦听器正在运行的主机。如果未指定，主机名默认为默认接口的主机名。当主机是多宿主的并且您想要控制接收集群消息的接口时，您将需要为每个节点指定主机名。例如，如果您碰巧设置了网络，以便缓存到缓存通信不在默认接口上，那么您必须在每台机器上设置该主机名属性。这需要每个节点的自定义 jetspeed.property 文件。

可以通过缓存管理器配置 Spring bean 并结合设置 Java System 属性来为每个节点配置不同的主机名。在 中**cache.xml**，您可以将 配置**CacheManagerConfig**为使用系统属性，在本例中为名为 的属性**server.ref**。此参数在运行时通过 cache.xml 中的以下设置在门户框架中填充：

<!-- 缓存管理器 -->

<bean id="cacheManagerConfig" class="org.apache.jetspeed.cache.impl.EhCacheConfigResource">

    <!-- <property name="defaultConfigResource" value="distributed-ehcache.xml"/> -->

    <property name="defaultConfigResource" value="ehcache${server.ref}.xml"/>

</豆> 
确保设置系统属性，例如在启动时：

java .... -Dserver.ref=_NODE56

### 9.2.6. **缓存属性**

以下是使用分布式缓存的默认设置。这些可以在**jetspeed.properties**or中设置/修改**override.properties**：


| **缓存（默认注释掉）**                               |             |
| ---------------------------------------------------- | ----------- |
| 缓存页面管理器覆盖属性。                             |             |
| **财产**                                             | **默认**    |
| #org.apache.jetspeed.ehcache.pagemanager.maxelements | 128         |
| #org.apache.jetspeed.ehcache.pagemanager.element.ttl | 150         |
| #org.apache.jetspeed.ehcache.pagemanager.maxfiles    | 1000        |
| #org.apache.jetspeed.ehcache.config.resource         | ehcache.xml |
| #org.apache.jetspeed.ehcache.group.address           | 230.0.0.1   |
| #org.apache.jetspeed.ehcache.group.port              | 4446        |
| #org.apache.jetspeed.ehcache.group.ttl               | 1           |
| #org.apache.jetspeed.ehcache.hostname                |             |
| #org.apache.jetspeed.ehcache.port                    | 40001       |

这些设置特定于页面管理器缓存：

· #org.apache.jetspeed.ehcache.pagemanager.maxelements=128

· #org.apache.jetspeed.ehcache.pagemanager.element.ttl=150

· #org.apache.jetspeed.ehcache.pagemanager.maxfiles=1000

### 9.2.7. **测试 Jetspeed 分布式缓存**

首先，验证以下页面管理器测试是否适用于您的开发机器：

mvn test -P test -Dtest=TestDatabasePageManagerCache

不仅此测试必须通过，而且以下消息不应出现在控制台/shell 或测试日志文件中：

**“未分发服务器页面管理器：可能的系统限制......跳过测试”**

如果您看到上述消息，请检查防火墙设置以允许 UDP/4446。如果启用防火墙以允许 UDP 多播环回，则有时在 Lunix 系统上需要这样做。一些较旧的 TCP 堆栈根本不支持 UDP 多播环回。这就是为什么即使无法设置分布式缓存，该测试也不会完全失败的原因。

现在进行全面测试：设置两个独立的 tomcat J2 映像。编辑**webapps/jetspeed/WEB-INF/assembly/cache.xml**Tomcat 图像 #1：

<bean id="cacheManagerConfig" class="org.apache.jetspeed.cache.impl.EhCacheConfigResource">

<property name="defaultConfigResource" value="distributed-ehcache.xml"/>

<property name="defaultHostname" value="localhost"/>

<property name="defaultPort" value="40001"/>
</豆>

编辑**webapps/jetspeed/WEB-INF/assembly/cache.xml**Tomcat 图像 #2：

<bean id="cacheManagerConfig" class="org.apache.jetspeed.cache.impl.EhCacheConfigResource">

<property name="defaultConfigResource" value="distributed-ehcache.xml"/>

<property name="defaultHostname" value="localhost"/>

<property name="defaultPort" value="40002"/>
</豆>

针对每台服务器启动浏览器。使用不同的主机名以确保 cookie 被单独管理（即“127.0.0.1”和“localhost”）。在每个浏览器中查看相同的页面。在一个浏览器中编辑页面。刷新后，更改应在第二个浏览器中可见。

当分布式缓存在多个虚拟或物理服务器上运行时，上面分配的默认端口不需要为每台机器增加。如果服务器部署在多个网络上，则必须注意确保 UDP/4446/230.0.0.1 和 TCP/40001 上的多播流量在服务器之间路由。此外，可能必须指定多播传播 TTL 以使 UDP 数据包能够在网络之间跳转。默认值为“1”，应该将数据包限制到一个子网。（请参阅 org.apache.jetspeed.ehcache.group.ttl 属性）。

这是一个完全指定的 cacheManagerConfig bean，它具有正常安装的分布式缓存默认值：

<bean id="cacheManagerConfig" class="org.apache.jetspeed.cache.impl.EhCacheConfigResource">

<property name="defaultConfigResource" value="distributed-ehcache.xml"/>

<property name="defaultGroupAddress" value="230.0.0.1"/>

<property name="defaultGroupPort" value="4446"/>

<property name="defaultGroupTTL" value="1"/>

<property name="defaultHostname" value="localhost"/>

<property name="defaultPort" value="40001"/>
</豆>

这些中的任何一个都可以配置为反映生产网络的要求。
